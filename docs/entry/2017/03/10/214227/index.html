<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <base href="https://daruyanagi.net/" />
        <link rel="canonical" href="https://daruyanagi.net/entry/2017/03/10/214227/" />

        <meta name="viewport" content="width=device-width,initial-scale=1">

        <title> 
            Visual Studio 2017 で Windows サービスを作った | だるやなぎ
        </title>

        

        
            
        

        
            <meta name="description" content="まぁ、この程度のことであれば、今までとあんまり変わらんと思うけどね。ちょこちょこ便利になってる感じはある。
### 今回の目標 実行ファイルが書き換わったら、トーストで通知してほしい。  ### プロジェクトを作成する   ［テンプレート］－［Visual C#］－［Windows クラシック デスクトップ］を開いて、“Windows サービス（.NET Framework）”を選択。すると、Windows サービス プロジェクトのスケルトンがブリブリっと吐かれる。Service1.cs では味気ないので、今回は MihariService.cs という名前にした。“見張り”やね（以前にもそういう名前のアプリを作って放置してたっけ）。  次に MihariService.cs のデザイナー画面を開き、コンテキストメニューの［インストーラーの追加］コマンドを実行。  すると ServiceInstaller.cs というのが作成されます。このデザイン画面で ServiceInstaller1 を探し、プロパティ画面からいい感じにプロパティを設定。今回はこんな感じにした。  ServiceName：MihariService（アプリ ID のノリでどこでも使っていくやで） DisplayName：Mihari サービス（WIndowsの「サービス」からはこれが見えるらしい。日本語にした） Description：システム内で EXE ファイルが変更されるのを監視します StartType：Automatic（これでたぶん自動実行されるはず） 最低限の準備はこれでいいみたい。まだ中身はないけれど、ソリューションをビルドする。  ### サービスの登録とデバッグ   このままデバッグ実行をしても、エラーが出る。ビルドした Windows サービスをシステムに登録しなきゃいけない。  まず、ツールの類にパスの通ったコマンドプロンプトを起動（よくわかんないけど Developer Command Prompt for VS 2017 というのでいいみたい）。  Debug フォルダーに移動してパスをコピーしておき、コマンドプロンプトで移動。installutil で MihariService.exe をシステムに登録する。 ``` ********************************************************************** ** Visual Studio 2017 Developer Command Prompt v15." />
        

        
        
        <link rel="stylesheet" href="css/style.css">

    </head>
    <body class="body">

        <header class="global-header">
            <h1><a href="/" >だるやなぎ</a></h1>

<p>そうだ、だるだるしよう。</p>


        </header>

        <main>
            
    <article class="entry">

        <div class="entry__header">
            <div class="entry__header-taxonomies">
                
                
                    <div class="entry__header-taxonomies-category">
                        <span class="entry__header-taxonomies-category-title">
                            <a class="entry__header-taxonomies-category-title-link" href="https://daruyanagi.net/entry/">
                                Entries
                            </a>
                        </span>
                    </div>
                
                
                    <div class="entry__header-taxonomies-tags">
                        <ul class="entry__header-taxonomies-tags-list" >
                            
                                
                                
                                    <li class="entry__header-taxonomies-tags-list-item">
                                        <a class="entry__header-taxonomies-tags-list-itelink" href="https://daruyanagi.net/tags/windows/">Windows デスクトップ アプリ</a>
                                    </li>
                                
                            
                                
                                
                                    <li class="entry__header-taxonomies-tags-list-item">
                                        <a class="entry__header-taxonomies-tags-list-itelink" href="https://daruyanagi.net/tags/visual-studio/">Visual Studio</a>
                                    </li>
                                
                            
                                
                                
                            
                        </ul>
                    </div>
                
            </div>

            <div class="entry__header-title">
                <a class="entry__header-title-link" href="https://daruyanagi.net/entry/2017/03/10/214227/" >
                    <h1 class="entry__header-title-link-text">Visual Studio 2017 で Windows サービスを作った</h1>
                </a>
            </div>

            <div class="entry__header-date">
                <P>公開日：<time>2017/03/10</time>
                </P>
            </div>

        </div>
        <div class="entry__content">
            <p><figure>
    <img src="/images/20170310210104.png"/> 
</figure>
まぁ、この程度のことであれば、今までとあんまり変わらんと思うけどね。ちょこちょこ便利になってる感じはある。</p>
<div class="section">
    ### 今回の目標
    実行ファイルが書き換わったら、トーストで通知してほしい。
</div>
<div class="section">
    ### プロジェクトを作成する
    <figure>
    <img src="/images/20170310210338.png"/> 
</figure>
［テンプレート］－［Visual C#］－［Windows クラシック デスクトップ］を開いて、“Windows サービス（.NET Framework）”を選択。すると、Windows サービス プロジェクトのスケルトンがブリブリっと吐かれる。Service1.cs では味気ないので、今回は MihariService.cs という名前にした。“見張り”やね（以前にもそういう名前のアプリを作って放置してたっけ）。<figure>
    <img src="/images/20170310210613.png"/> 
</figure>
次に MihariService.cs のデザイナー画面を開き、コンテキストメニューの［インストーラーの追加］コマンドを実行。<figure>
    <img src="/images/20170310210915.png"/> 
</figure>
すると ServiceInstaller.cs というのが作成されます。このデザイン画面で ServiceInstaller1 を探し、プロパティ画面からいい感じにプロパティを設定。今回はこんな感じにした。
<ul>
<li>ServiceName：MihariService（アプリ ID のノリでどこでも使っていくやで）</li>
<li>DisplayName：Mihari サービス（WIndowsの「サービス」からはこれが見えるらしい。日本語にした）</li>
<li>Description：システム内で EXE ファイルが変更されるのを監視します</li>
<li>StartType：Automatic（これでたぶん自動実行されるはず）</li>
</ul>最低限の準備はこれでいいみたい。まだ中身はないけれど、ソリューションをビルドする。
</div>
<div class="section">
    ### サービスの登録とデバッグ
    <figure>
    <img src="/images/20170310211757.png"/> 
</figure>
このままデバッグ実行をしても、エラーが出る。ビルドした Windows サービスをシステムに登録しなきゃいけない。<figure>
    <img src="/images/20170310211520.png"/> 
</figure>
まず、ツールの類にパスの通ったコマンドプロンプトを起動（よくわかんないけど Developer Command Prompt for VS 2017 というのでいいみたい）。<figure>
    <img src="/images/20170310211358.png"/> 
</figure>
Debug フォルダーに移動してパスをコピーしておき、コマンドプロンプトで移動。installutil で MihariService.exe をシステムに登録する。
```
**********************************************************************
** Visual Studio 2017 Developer Command Prompt v15.0.26228.4
** Copyright (c) 2017 Microsoft Corporation
**********************************************************************
> cd （Debug フォルダー）
<blockquote>
<p>installutil MihariService.exe</p>
</blockquote>
<pre><code class="language-<figure>
    <img src="/images/20170310212252.png"/> 
</figure>
ログインを求められたら、ユーザー名とパスワードを入力。ユーザー名はコンピュータ名から始まる完全な奴じゃないとダメみたい。" data-lang="<figure>
    <img src="/images/20170310212252.png"/> 
</figure>
ログインを求められたら、ユーザー名とパスワードを入力。ユーザー名はコンピュータ名から始まる完全な奴じゃないとダメみたい。"></code></pre><blockquote>
<p>whoami</p>
</blockquote>
<pre><code class="language-で取得したのをコピーして使うといい。<figure>
    <img src="/images/20170310212519.png"/> 
</figure>
あとは「サービス」に移動して、登録したサービスを開始する。" data-lang="で取得したのをコピーして使うといい。<figure>
    <img src="/images/20170310212519.png"/> 
</figure>
あとは「サービス」に移動して、登録したサービスを開始する。">
&lt;/div&gt;
&lt;div class=&quot;section&quot;&gt;
    ### デバッグ
    <figure>
    <img src="/images/20170310212629.png"/> 
</figure>
デバッグを行うには Windows サービスのプロセスにアタッチすればよい。<figure>
    <img src="/images/20170310212806.png"/> 
</figure>
［すべてのユーザーからのプロセスを表示する］オプションを有効化し、フィルターで Mihari を探すと早い。あとはブレークポイントを仕掛けるなりなんなりご自由に。リビルドのときは サービスを止める → ビルド → サービスを開始する（→再びアタッチする）みたいな作業フローで。ちょっと面倒くさいけど仕方ない（もしかしたら自動化できるのかもだけど、そこまではいいや）。

&lt;/div&gt;
&lt;div class=&quot;section&quot;&gt;
    ### ファイルを監視する
    <figure>
    <img src="/images/20170310213029.png"/> 
</figure>
めんどくさくなった。MihariService.cs に FileSystemWatcher を追加して、いろいろコードを書けばおっけ。 完成してから気づいたんだけど、サービスから通知トーストを出しても、クリックに反応してくれないんだな（フォルダーを開いたりしてほしい）。単にログだけ出力し、そのログを監視してトーストを出すクライアントを別途作った方がよかった。[Windowsサービスの作り方講座　その１ - おろかな日々](http://rinta.hatenablog.com/entry/20110102/p2)[WindowsサービスをC#で書く - backyard of 伊勢的新常識](http://iseebi.hatenablog.com/entry/20080603/p1)先人たちのおかげですんなり完成しました。

&lt;/div&gt;

</code></pre>
        </div>
        <div class="entry__footer">
            
            <div class="entry__footer-navigation">
                <span class="entry__footer-prev">
                     <a class="entry__page-navigation-link" href="https://daruyanagi.net/entry/2017/03/11/151103/">&laquo; 前の記事</a> 
                </span>
                <span class="entry__footer-lastmod">
                    
                    最終更新日：<time
                        datetime="2017-03-10T21:42:27JST">2017/03/10</time>
                    
                </span>
                <span class="entry__footer-next">
                     <a class="entry__page-navigation-link" href="https://daruyanagi.net/entry/2017/03/09/194122/">次の記事 &raquo; </a> 
                </span>
            </div>
        </div>

    </article>

        </main>

        <footer class="global-footer">
            <p>&copy; 2020 daruyanagi.</p>

        </footer>
    </body>
</html>