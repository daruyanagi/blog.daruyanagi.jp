
+++
date = "2012-08-25 00:34:21 +0000 UTC"
draft = false
title = "WebMatrix でユーザー認証機能（3） ―― なにはともあれユーザー登録しないと始まらん"
tags = ["ASP.net Web Pages","WebMatrix"]

+++


{{< figure src="/images/20120824233928.png"  >}}

br/>


<ul>
<li><a href="https://blog.daruyanagi.jp/entry/2012/08/24/095023">WebMatrix でユーザー認証機能 ―― 準備編 - だるろぐ</a></li>
<li><a href="https://blog.daruyanagi.jp/entry/2012/08/24/105121">WebMatrix でユーザー認証機能（2） ―― WebSecurityってどうやって使うんだ？ - だるろぐ</a></li>
</ul>のんびりやっていこう。今回はユーザー登録するで。
```cs
@{
    var name = "";
    var password = "";
    var confirmPassword = "";

    if (IsPost)
    {
        name = Request.Form["name"];
        password = Request.Form["password"];
        confirmPassword = Request.Form["confirmPassword"];

        // ここでバリデーション（値が妥当なものか検証）する

        if (Validation.IsValid())
        {
            if (WebSecurity.GetUserId(name) > -1)
            {
                ModelState.AddFormError("Username alredy exists");
            }
            else
            {
                try
                {
                    WebSecurity.CreateUserAndAccount(
                        name, password, new { Name = name });
                    WebSecurity.Login(name, password);
                    Response.Redirect("~/");
                }
                catch (Exception e)
                {
                    ModelState.AddFormError(e.Message);
                }
            }
        }
    }
}

```まずはバリデーションを関連の記述をとっぱらったサーバー側のコード<a href="#f-8a0f6f9f" name="fn-8a0f6f9f" title="コードビハインドっていうの？　知らんけど">*1</a>。やっていることは簡単で、

<ol>
<li>フォームから値を受け取る</li>
<li>値をバリデーション</li>
<li>ユーザーネームにダブりがないか確認</li>
<li>ユーザープロファイルとメンバーシップアカウントを作成</li>
<li>ログインしてトップページへリダイレクト</li>
<li>エラーが発生したら適宜 ModelState に登録しておく</li>
</ol>みたいな感じ。

<div class="section">
    ### WebSecurity.CreateUserAndAccount()
    WebSecurity では、ユーザーアカウントをユーザープロファイル（開発者が管理）とメンバーシップアカウント（システムが管理）にわけて管理している（<a href="https://blog.daruyanagi.jp/entry/2012/08/24/105121">WebMatrix でユーザー認証機能（2） ―― WebSecurityってどうやって使うんだ？ - だるろぐ</a>）。両者は同じ UserId で紐付けられる仕組みだ。 WebSecurity.CreateUserAndAccount() はそのユーザープロファイルとメンバーシップアカウントの作成を同時に行うメソッド。ユーザープロファイルテーブルに挿入するデータは、第三引数で匿名オブジェクトを与えればよい。今回は名前だけを登録しておいた。ちなみに WebSecurity.Create() だけを使った場合、さきにユーザープロファイルテーブルへ UserId とそのほかのデータを挿入しておかなければならない。“Starter Site”テンプレートではそれを SQL で行なっている。
```cs
if (Validation.IsValid())
{
    var db = Database.Open(App.Database);

    var user = db.QuerySingle(
        "SELECT Name FROM Users WHERE LOWER(Name) = LOWER(@0)",
        name);

    if (user == null)
    {
        db.Execute(
            "INSERT INTO Users (Name) VALUES (@0)", name);
        WebSecurity.CreateAccount(name, password);

```げろげろうげー。
```cs
if (Validation.IsValid())
{
    if (WebSecurity.GetUserId(name) > -1)
    {
        ModelState.AddFormError("Username alredy exists");
    }
    else
    {
        try
        {
            WebSecurity.CreateUserAndAccount(
                name, password, new { Name = name });

```絶対こっちにするやろ。せっかく WebSecurity Helper を使うんだから、大いに頼ればよろしい。

{{< figure src="/images/20120825001002.png"  >}}

br/>


</div>
<div class="section">
    ### ModelState
    ModelState は WebPage に属しており、フォームのエラーを管理するものだとでも理解しておく。 ModelState.AddFormError() でフォーム関連のエラーが登録できるんだな。バリデーション関連のコードはこんな感じ（“Starter Site”からコードをパクってきた）。
```cs
Validation.RequireField("name", 
    "電子メール アドレスを入力してください。");
Validation.RequireField("password", 
    "パスワードを空白にすることはできません。");
Validation.Add("confirmPassword",　Validator.EqualsTo(
    "password", "パスワードと確認のパスワードが一致しません。")
);
Validation.Add("password",
    Validator.StringLength(
        maxLength: Int32.MaxValue,
        minLength: 6,
        errorMessage: "パスワードは 6 文字以上にする必要があります"
    )
);

```読むだけで何をしているのかわかるのがいい。表示部分はこのようなコードになっていた。
```cs
&lt;section id="register">
    &lt;form method="post">
        @Html.ValidationSummary("Log in was unsuccessful." + 
            "Please correct the errors and try again.",
            excludeFieldErrors: true, htmlAttributes: null)

        &lt;fieldset>
            &lt;legend>Register Your Account&lt;/legend>
            &lt;ol>
                @RenderFormInputWithValidation(this, "name")
                &lt;li class="name">
                    &lt;label for="name" @if (!ModelState.IsValidField("name")) {&lt;text>class="error-label"&lt;/text>}>Name&lt;/label> 
                    &lt;input type="text"
                        id="name" name="name" value="@name"
                        @Validation.For("name") />
                    @Html.ValidationMessage("name")
                &lt;/li>
                &lt;li class="password">
                    &lt;label for="password" @if (!ModelState.IsValidField("password")) {&lt;text>class="error-label"&lt;/text>}>Password&lt;/label> 
                    &lt;input type="password"
                        id="password" name="password"
                        @Validation.For("password")/>
                    @Html.ValidationMessage("password")
                &lt;/li>
                &lt;li class="confirm-password">
                    &lt;label for="confirm-password" @if (!ModelState.IsValidField("confirmPassword")) {&lt;text>class="error-label"&lt;/text>}>confirmPassword&lt;/label> 
                    &lt;input type="password"
                        id="confirmPassword" name="confirmPassword"
                        @Validation.For("confirmPassword")/>
                    
                    @Html.ValidationMessage("confirmPassword")
                &lt;/li>
            &lt;/ol>
            &lt;input type="submit" value="Register" />
        &lt;/fieldset>
    &lt;/form>
&lt;/section>

```ぐちゃぐちゃしてわかりにくいが、
```cs
@Html.ValidationSummary("Log in was unsuccessful." + 
    "Please correct the errors and try again.",
    excludeFieldErrors: true, htmlAttributes: null)

```でページ全体についてのバリデーション結果を表示する。

{{< figure src="/images/20120825002435.png"  >}}

ォームの各フィールドは、
```cs
&lt;label for="name" @if (!ModelState.IsValidField("name")) {&lt;text>class="error-label"&lt;/text>}>Name&lt;/label> 
&lt;input type="text" id="name" name="name" value="@name" @Validation.For("name") />
@Html.ValidationMessage("name")

```このコードでワンセットみたい。 Validation.For() は JavaScript によるバリデーションに必要な data- 属性を出力する（今回は使ってない）。 Html.ValidationMessage() はバリデーションエラーのメッセージがあれば表示する。このメッセージはさっき ModelState に登録したエラーから取得するみたい。

{{< figure src="/images/20120825002611.png"  >}}

者のコードは使いまわせそうないわばイディオムなので、ヘルパーか拡張メソッドにしておくとよさそうだ。今回は以下のようにしてみたよ。
```cs
~/App_Code/WebPageExtension.cs

using System.Linq;
using System.Web;
using System.Web.WebPages;
using System.Web.WebPages.Html;

public static class WebPageExtension
{
    private enum InputType
    {
        Text, Password, Checkbox, Textarea,
    }

    private static HtmlString RenderInputWithValidation(
        this WebPage target, InputType input_type,
        string name, string label = "", object additional = null)
    {
        const string HTML_TAG = @"
            <div class="" validation-input="" {0}="" {1}""=""></div>
                <label for="" {0}""="">{2}</label>
                <input type="" {3}""="" id="" {0}""="" name="" {0}""="" {4}="" {5}=""/>
                {6}
            ";
            
        var attrs = (additional == null)
            ? string.Empty
            : string.Join(" ", additional
                .GetType()
                .GetProperties()
                .Select((p) => string
                    .Format("{0}=\"{1}\"",
                        p.Name.ToLower(),
                        p.GetValue(additional)
                    )
                )
            );

        return new HtmlString(
            string.Format(
                HTML_TAG, name,
                target.ModelState.IsValidField(name)
                    ? string.Empty
                    : "validation-failed",
                label.IsEmpty() ? name : label,
                input_type.ToString().ToLower(),
                attrs,
                target.Validation.For(name),
                target.Html.ValidationMessage(name)
            )
        );
    }

    public static HtmlString RenderTextWithValidation(
        this WebPage target, string name,
        string label = null, object additional = null)
    {
        return RenderInputWithValidation(
            target, InputType.Text, name, label, additional);
    }

    public static HtmlString RenderPasswordWithValidation(
        this WebPage target, string name,
        string label = null, object additional = null)
    {
        return RenderInputWithValidation(
            target, InputType.Password, name, label, additional);
    }

    public static HtmlString RenderCheckBoxWithValidation(
        this WebPage target, string name,
        string label = null, object additional = null)
    {
        return RenderInputWithValidation(
            target, InputType.Checkbox, name, label, additional);
    }
}

```ModelState が WebPage に属する関係で、 WebPage クラスの拡張メソッドとして定義してある。ほんとは HTML Helper にして、 @Html.TextWithValidation() などと呼べる方がカッコいいな。今度もう少しこのあたりはブラッシュアップしてみたい。んで、これを使って書きなおした表示部分はこうなる。
```cs
&lt;section id="register">
    &lt;form method="post">
        @Html.ValidationSummary(
            "Log in was unsuccessful." + 
            "Please correct the errors and try again.",
            false, null)

        &lt;fieldset>
            &lt;legend>Register Your Account&lt;/legend>
            @this.RenderTextWithValidation(
                "name", "Name", new { Value = name} )
            @this.RenderPasswordWithValidation(
                "password", "Password")
            @this.RenderPasswordWithValidation(
                "confirmPassword", "Confirm Password")
            &lt;input type="submit" value="Register" />
        &lt;/fieldset>
    &lt;/form>
&lt;/section>

```だいぶシンプルになって予はだいぶ満足したぞよ。ほかのヘルパーの真似して new { Value = name} で追加の属性を追加できるようにしてみたのがちょっとだけ自慢だ。リフレクションはちょっと苦手なので、今日は個人的にその勉強などしてみた。次回はログインとログアウトだけど、これは一瞬で終わりそう……。

</div><div class="footnote">
<a href="#fn-8a0f6f9f" name="f-8a0f6f9f" class="footnote-number">*1</a><span class="footnote-delimiter">:</span><span class="footnote-text">コードビハインドっていうの？　知らんけど</span>
</div>

