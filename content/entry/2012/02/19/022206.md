
+++
date = "2012-02-19 02:22:06 +0000 UTC"
draft = false
title = " 危険な可能性のある Request.Form 値がクライアントから検出されました"
tags = ["C#","ASP.net Web Pages"]

+++
<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120219/20120219013646.png" alt="f:id:daruyanagi:20120219013646p:plain" title="f:id:daruyanagi:20120219013646p:plain" class="hatena-fotolife"/>ASP.NET 規定の動作では、入力にHTMLタグが含まれていると、バリデーションでエラーを吐く（HttpRequestValidationException）。これはこれでありがたいのだけど、どうしてもHTMLタグを受け入れたい場合はある。

<div class="section">
    ### ページ単位でバリデーションを無効にする
    web.config に設定を記述する。

    ```xml
&lt;configuration>
    &lt;system.web>
        &lt;httpRuntime requestValidationMode="2.0" />
        &lt;pages validateRequest="false">
        &lt;/pages>
    &lt;/system.web>
&lt;/configuration>
```

</div>
<div class="section">
    ### メソッド単位でバリデーションを無効にする。
    POSTメソッドをまるごと。

    ```cs
[HttpPost]
[ValidateInput(false)]
public ViewResult Edit(FormCollection form)
{

}
```
<a href="http://stackoverflow.com/questions/4361907/asp-net-mvc-3-validaterequestfalse-not-working-with-formcollection">ASP.NET MVC 3 ValidateRequest(false) not working with FormCollection - Stack Overflow</a>

</div>
<div class="section">
    ### フォームデータ単位でバリデーションを無効にする。
    Request クラスの拡張メソッド Unvalidated() を利用する。自分ではこれしか使わない。コントローラーで使ってみる。

    ```cs
using System.Web.Helpers;

var hoge = Request.Unvalidated().Form["hoge"];
```
ビューでも使えるんだね。

    ```
@Request.Unvalidated("html")

&lt;form method="post">
    &lt;input type="text" name="html" />
    &lt;input type="submit" />
&lt;/form>
```
<a href="http://d.hatena.ne.jp/shiba-yan/20110406/1302094656">System.Web.Helpers を活用する - まめしば雑記</a>

</div>
<div class="section">
    ### 補足
    DB に HTML タグを突っ込みたい場合は AllowHtml 属性を付与してやる。

    ```
[AllowHtml]
[DisplayName("本文")]
public string Body { get; set; }
```
HTML タグを含む文字列を生のまま出力したい場合は、@Html.Raw() が利用できる。

    ```
@Html.Raw(hoge)
```
HTML タグを含む文字列を変数として保持したい場合は、 HtmlString/MvcHtmlString クラスを使う。MvcHtmlString は ASP.Net 3.5 MVC 2 から使えるが、 HtmlString は MVC 3 のみ。これからは HtmlString 使えばいいんじゃないかな。中身がどう違うのかはよく知らない。

    ```
var hoge = new MvcHtmlString("&lt;b>hoge&lt;/b>");
```
HTML タグを安全に出力したい場合は HttpUtility.HtmlEncode() を使う。

    ```
@HttpUtility.HtmlEncode(hoge)
```
※ 間違ってるところがあったら、ぜひ教えてほしいです......

</div>

