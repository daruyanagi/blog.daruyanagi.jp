
+++
date = "2012-10-07 11:39:45 +0000 UTC"
draft = false
title = "WebMatrix/ASP.NET Web Pages で YAML を扱う"
tags = ["ASP.net Web Pages","WebMatrix"]

+++
ちょっと YAML を使いたいなーというシーンがあったので、いろいろ調べたみた。

<div class="section">
    ### YAML って？
    
    >
        YAML は XML よりも読みやすく、書きやすく、JSON よりも型にうるさく、しかも自由度がある、Ruby 使い達に人気の(?) データ記述形式です。

    
ほんとう？　それを確かめるためにちょっと比較してみました。例は <a href="http://www.ibm.com/developerworks/jp/xml/library/x-matters23/">XMLの論考: YAMLはXMLに改良を加える</a> のものをベースに、<a href="http://bluehawk.infinitybird.com/dev/xmljson.html">XML-JSON相互変換ツール - Bluehawk&#39;s lab.</a> で作成した JSON 形式のものを追加してあります。

<div class="section">
    #### XML で表現した場合
    ```xml
<!--?-->xml version="1.0"?>
<club></club>
  <players></players>
    id="kramnik"
            name="Vladimir Kramnik"
            rating="2700"
            status="GM" />
    id="fritz"
            name="Deep Fritz"
            rating="2700"
            status="Computer" />
    id="mertz"
            name="David Mertz"
            rating="1400"
            status="Amateur" />
  
  <matches></matches>
    <match></match>
        <date></date>2002-10-04
        refid="fritz" />
        refid="kramnik" />
        <result></result>Draw
    
    <match></match>
        <date></date>2002-10-06
        refid="kramnik" />
        refid="fritz" />
        <result></result>White
    
  


```タグがウザい。何でもできるけれど、少し厳格すぎるきらいがある。

</div>
<div class="section">
    #### JSON で表現した場合
    ```
{
  "club": {
    "players": {
      "player": [
        {
          "-id": "kramnik",
          "-name": "Vladimir Kramnik",
          "-rating": "2700",
          "-status": "GM"
        },
        {
          "-id": "fritz",
          "-name": "Deep Fritz",
          "-rating": "2700",
          "-status": "Computer"
        },
        {
          "-id": "mertz",
          "-name": "David Mertz",
          "-rating": "1400",
          "-status": "Amateur"
        }
      ]
    },
    "matches": {
      "match": [
        {
          "Date": "2002-10-04",
          "White": { "-refid": "fritz" },
          "Black": { "-refid": "kramnik" },
          "Result": "Draw"
        },
        {
          "Date": "2002-10-06",
          "White": { "-refid": "kramnik" },
          "Black": { "-refid": "fritz" },
          "Result": "White"
        }
      ]
    }
  }
}
```ネストが深い。JavaScript との相性が抜群だが、いろいろユルい部分も多い。

</div>
<div class="section">
    #### YAML で表現した場合
    ```yaml
---
players:
  Vladimir Kramnik: &amp;kramnik
    rating: 2700
    status: GM
  Deep Fritz: &amp;fritz
    rating: 2700
    status: Computer
  David Mertz: &amp;mertz
    rating: 1400
    status: Amateur
matches:
  -
    Date: 2002-10-04
    White: *fritz
    Black: *kramnik
    Result: Draw
  -
    Date: 2002-10-06
    White: *kramnik
    Black: *fritz
    Result: White

```タグがないし、ネストも深くないのでスッキリ。ただ、構造化データを記述する以外の用途には向かない。あと、参照の仕組み（アンカーとエイリアス、アドレスとポインタのようなもの）をもっているのがいい。これって、データベースをテキストに書きだしたり、オブジェクトをシリアライズするときにも便利だよね。

<ul>
<li><a href="http://jp.rubyist.net/magazine/?0009-YAML">Rubyist Magazine - プログラマーのための YAML 入門 (初級編)</a></li>
</ul>
</div>
</div>
<div class="section">
    ### 
	YamlSerializer for .NET

    
    >
        主に２つの目的で使うことができます。


C# のオブジェクトをそのまま YAML テキストにシリアライズ・デシリアライズすることができます。=> YamlSerizlizer クラス
一般の YAML ファイルを扱うこともできます。 => YamlNode クラス

    
というわけで、今日はこのライブラリを使ってみる。ちゃんと NuGet にもパッケージングされていて、WebMatrix からもサックリ使えるよ。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20121007/20121007113028.png" alt="f:id:daruyanagi:20121007113028p:plain" title="f:id:daruyanagi:20121007113028p:plain" class="hatena-fotolife"/>

<div class="section">
    #### サンプルコード
    ```cs
# Default.cshtml

@functions {
    // シリアライズ・デシリアライズのためのサンプルクラス
    public class Person
    {
        public string FirstName { get; set; }
        public string LastName { get; set; }
        
        public override string ToString()
        {
            return string.Format("{0} {1}", FirstName, LastName);
        }
    }
}

@{
    var person = new Person()
    {
        FirstName = "Hidetoshi", LastName = "Yanagi",
    };

    // シリアライザの生成
    // using System.Yaml.Serialization;
    var serializer = new YamlSerializer();

    // YML形式のテキスト
    string yml =@"
LastName: 柳
FirstName: 英俊
";

    // YMLテキスト → Person
    var deserialised = serializer.Deserialize(
        yml, typeof(Person)
    );
}

&lt;!DOCTYPE html>

&lt;html lang="ja">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>マイ サイトのタイトル&lt;/title>
    &lt;/head>
    &lt;body>
        &lt;pre>
        @serializer.Serialize(person) //&lt;-- YMLテキストに！
        &lt;/pre>

        // 返り値は object 配列だよ！
        &lt;h1>フルネームは @(deserialised[0] as Person) です。&lt;/h1>
    &lt;/body>
&lt;/html>

```
</div>
<div class="section">
    #### 結果
    <img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20121007/20121007113045.png" alt="f:id:daruyanagi:20121007113045p:plain" title="f:id:daruyanagi:20121007113045p:plain" class="hatena-fotolife"/>ちょっとアレだな、とおもったのは @(deserialised[0] as Person) の部分だけれど、dynamic でうければいいのかもしれない。
```cs
dynamic deserialised = serializer.Deserialize(
        yml, typeof(Person)
    )[0];

deserialised.FirstName;

```
</div>
</div>

