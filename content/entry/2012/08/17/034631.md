
+++
date = "2012-08-17 03:46:31 +0000 UTC"
draft = false
title = "Highlight.js を NuGet パッケージにしてみました"
tags = ["NuGet","WebMatrix","Visual Studio","ASP.net Web Pages"]

+++
<a href="https://blog.daruyanagi.jp/entry/2012/08/16/155714">WebMatrix で Markdown を少しだけ拡張してみる - だるろぐ</a> と <a href="https://blog.daruyanagi.jp/entry/2012/08/16/182105">App_Code でサブフォルダーを利用する - だるろぐ</a> で扱った Highlight.js を NuGet パッケージにしてみました。最初は Highlight.js の NuGet パッケージは存在しないと思い込んでいたのですが、ただ検索のやり方が悪かったようで、「Highlight」というパッケージがあったり、似たような機能を実現できそうな「ColorCode」というパッケージもみつけたのですが、見なかったふりをします。 nuget.org はまだちょっと検索機能がイケてないような気がしますね（責任転嫁）。

<div class="section">
    ### 準備
    
<div class="section">
    #### nuget.org のアカウントを作成
    <a href="http://nuget.org">NuGet Gallery | Home</a> でアカウントを作成してください。だいぶ前にやったのでやり方は忘れましたが、難しくはないはずです。

{{< figure src="/images/20120817024658.png"  >}}

カウントページで API キーが取得できるので、それをローカル環境に登録します。
```
nuget.exe setApiKey ********-****-****-****-************
nuget.exe push MyPackage.1.0.nupkg
```NuGet.exe を入手（<a href="http://nuget.codeplex.com/releases">http://nuget.codeplex.com/releases</a> NuGet.exe Command Line）して、1行目を実行すればOKです<a href="#f-f45a0f4e" name="fn-f45a0f4e" title="初回起動時に実行ファイルのアップデートが行われます">*1</a>。

</div>
<div class="section">
    #### パッケージに含めるファイルを用意
    今回パッケージに含めるファイルは以下のとおりです。
```
Highlight.js/

    Highlight.js.nuspec &lt;-- あとで作りましょう！

    content/
        （ ~/ 以下に展開されます）
        App_Code/
            Highlight/
                Highlight.cs
                Lisence Files
        Content/
            Highlight/
                Theme Skins
        Scripts/
            Highlight/
               hilight.pack.js
        web.config.transform &lt;-- あとで説明します！

    tools/
        （セットアップなどに利用するスクリプトなどを含めます）

    lib/
        （必要な参照アセンブリを格納しておきます）
```今回は tools と lib が空ですけど、それなりに大規模なパッケージを作るときは必要になるのだと思います。ほかにも .NET やら Silverlight やら、ターゲットによってフォルダー構成を変えなきゃダメみたいだけれど、今回はまぁ、いいかな。その代わり、 NuSpec （後述）のタグに「asp.net」と対象ターゲットを書いておくことにします。web.config.transform の内容はこんな感じです。 App_Code のサブフォルダーに格納した Highlight.cs のコンパイルを有効にするための設定が記述されています。
```xml
<!--?-->xml version="1.0"?>
<configuration></configuration>
    .web>
      debug="false">
         <codesubdirectories></codesubdirectories>
           directoryName="Highlight"/>
         
      
   .web>


```.transform という拡張子をつけて content フォルダーに置いておくだけで、勝手にインストール先の Web アプリの web.config とマージしてくれるみたいですね。あらまー、簡単！

<ul>
<li><a href="http://haacked.com/archive/2010/11/19/nuget-transformation.aspx">NuGet Package Transformations | You’ve Been Haacked</a></li>
</ul>
</div>
</div>
<div class="section">
    ### NuGet パッケージ（NuPack）の作成
    では、 NuGet のパッケージを作成します。手順は NuSpec ファイルに名前やバージョンなどのメタデータを記述して、 NuPack へ Pack（パッケージング）し、 nuget.org へ push （公開）するといった感じ。

<div class="section">
    #### NuSpec の作成
    

{{< figure src="/images/20120817031210.png"  >}}

br/>

```
nuget.exe spec
```で雛形を出力します。内容はこんな感じになっているので、てけとーに編集します。
```xml
<!--?-->xml version="1.0"?>
<package></package>
  <metadata></metadata>
    <id></id>Package
    <version></version>1.0.0
    <authors></authors>Hidetoshi Yanagi
    <owners></owners>Hidetoshi Yanagi
    <licenseurl></licenseurl>http://LICENSE_URL_HERE_OR_DELETE_THIS_LINE
    <projecturl></projecturl>http://PROJECT_URL_HERE_OR_DELETE_THIS_LINE
    <iconurl></iconurl>http://ICON_URL_HERE_OR_DELETE_THIS_LINE
    <requirelicenseacceptance></requirelicenseacceptance>false
    <description></description>Package description
    <releasenotes></releasenotes>Summary of changes made in this release of the package.
    <copyright></copyright>Copyright 2012
    <tags></tags>Tag1 Tag2
    <dependencies></dependencies>
      id="SampleDependency" version="1.0" />
    
  


```自分の場合はこんな感じになりました（v1.0.4 の場合）。
```xml
<!--?-->xml version="1.0"?>
<package></package>
  <metadata></metadata>
    <id></id>Highlight.js
    <version></version>1.0.4
    <authors></authors>Ivan Sagalaev
    <owners></owners>daruyanagi
    <projecturl></projecturl>http://softwaremaniacs.org/soft/highlight/en/
    <requirelicenseacceptance></requirelicenseacceptance>false
    <description></description>Syntax Highlighter written by JavaScript and CSS (and C# Helper)
    <releasenotes></releasenotes>Package for v7.1 release.
    <copyright></copyright>Copyright 2012 Hidetoshi Yanagi (@daruyanagi)
    <tags></tags>webmatrix javascript css syntax asp.net .net40
  


```
</div>
<div class="section">
    #### NuPack の作成
    

{{< figure src="/images/20120817031339.png"  >}}

マンドを実行して、 NuPack を作成します。
```
nuget.exe pack Highlight.js.nuspec
```すると、 nuget.exe のフォルダーに（パッケージ名）.（バージョン）.nupaack（今回なら Highlight.js.1.0.4.nupack）が作成されます。解凍ソフトでバラして中身を確認してみると面白いかも。

</div>
<div class="section">
    #### NuPack の公開
    コマンドを実行して、 NuPack を公開します。
```
nuget.exe push Highlight.js.1.0.4.nupack
```これで、 nuget.org にパッケージが公開されるはず。

{{< figure src="/images/20120817031425.png"  >}}

a href="https://nuget.org/packages/Highlight.js">https://nuget.org/packages/Highlight.js</a>もしよかったら使ってみてくださいね！

</div>
</div>
<div class="section">
    ### パッケージのテスト
    アップロードしたパッケージは、パッケージマネージャーでインストール・アンインストールしてちゃんと動くか確かめましょう<a href="#f-a0ca43e7" name="fn-a0ca43e7" title="ごめんなさい、今までめんどくさくてだいたい動いていればOKかなって思ってました！">*2</a>。あと、「WebMatrix 2」で動くからといって「Visual Studio」でもそのまま動くかというとそうでもないみたいです。今回躓いたところを何点か補足しておきます。

<div class="section">
    #### パッケージが見つからない……
    

{{< figure src="/images/20120817032039.png"  >}}

ップロードしたばかりのパッケージは「WebMatrix 2」の検索で引っかかりにくいです。

{{< figure src="/images/20120817032125.png"  >}}

んなときは、フルネームでの検索を試みたり、パッケージのソースを変えてみるといいかもしれません。「Visual Studio」で利用する場合もそうですが、既定の検索結果が「ダウンロード数」順になっているみたいで、新参者はなかなか見つけにくい。「Visual Studio」の場合は、 CUI でインストールしてしまうのが手っ取り早いかもしれませんね。「WebMatrix 2」でも簡単に CUI で NuGet パッケージをインストールできるといいのですけど。

</div>
<div class="section">
    #### .NET Framework のターゲット
    「WebMatrix 2」のプロジェクトを「Visual Studio 2012」で開いたのですが、そのままではヘルパー（自作の静的クラス）がうまく動きませんでした。

{{< figure src="/images/20120817032540.png"  >}}

パラメーター初期化子を使うな」だの「System.Web.HtmlString なんてないよ！」だの言われるのでちょっと変だなと思っていたのですが、どうも .NET 2.0 でコンパイルしようとしているみたい。
```xml
<!--?-->xml version="1.0"?>
<configuration></configuration>
    .web>
      targetFramework="4.0" debug="false">
         <codesubdirectories></codesubdirectories>
           directoryName="Highlight"/>
         
      
   .web>


```web.config.transform を少し書き換えて、 .NET 4 を利用するようにしてみたら（targetFramework="4.0"）ちゃんと動きました。ついでに、 NuSpec のタグに「.net 40」を追加して「.NET 4 用ですよ！」とわかるようにしておくと<a href="#f-b9e55fda" name="fn-b9e55fda" title="周りのパッケージをみていると、そうしているのが多いように思います">*3</a>いいんじゃないでしょうか。

</div>
</div>
<div class="section">
    ### おわり！
    

{{< figure src="/images/20120817034817.png"  >}}

れまでの3つのエントリー

<ul>
<li><a href="https://blog.daruyanagi.jp/entry/2012/08/16/043012">WebMatrix で Markdown を使おう！ - だるろぐ</a></li>
<li><a href="https://blog.daruyanagi.jp/entry/2012/08/16/155714">WebMatrix で Markdown を少しだけ拡張してみる - だるろぐ</a></li>
<li><a href="https://blog.daruyanagi.jp/entry/2012/08/16/182105">App_Code でサブフォルダーを利用する - だるろぐ</a></li>
</ul>で使ってきたサンプルプロジェクトでも、既存の Highlight.js 関連のコードをバッサリ消して NuGet パッケージに置き換えてみました。入れたり消したり、好き放題だ！

</div>
<div class="section">
    ### おまけ
    

{{< figure src="/images/20120817033216.png"  >}}

NuGet Package Explorer」ってなんだよ！　最初から知ってたらこっちを使ってたかもしれない（くっそくっそ！なんかしらんけどプラグインでカスタマったりできるらしいゼ？ 

<ul>
<li><a href="http://npe.codeplex.com/wikipage?title=How%20to%20write%20a%20plugin%20for%20NuGet%20Package%20Explorer">CodePlex Archive</a></li>
</ul>ダウンロードは nuget.exe と同じところから。

</div><div class="footnote">
<a href="#fn-f45a0f4e" name="f-f45a0f4e" class="footnote-number">*1</a><span class="footnote-delimiter">:</span><span class="footnote-text">初回起動時に実行ファイルのアップデートが行われます</span>
<a href="#fn-a0ca43e7" name="f-a0ca43e7" class="footnote-number">*2</a><span class="footnote-delimiter">:</span><span class="footnote-text">ごめんなさい、今までめんどくさくてだいたい動いていればOKかなって思ってました！</span>
<a href="#fn-b9e55fda" name="f-b9e55fda" class="footnote-number">*3</a><span class="footnote-delimiter">:</span><span class="footnote-text">周りのパッケージをみていると、そうしているのが多いように思います</span>
</div>

