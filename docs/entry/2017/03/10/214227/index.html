<!DOCTYPE html>
<html><link rel="icon" href="https://via.placeholder.com/70x70">
<link rel="stylesheet" href="https://andybrewer.github.io/mvp/mvp.css">

<meta charset="utf-8">
<meta name="description" content="My description">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Visual Studio 2017 で Windows サービスを作った - だるろぐ - だるやなぎのブログ</title>

<style>
    nav {
        margin-bottom: 0;
    }

    body {
        font-family: "UD デジタル 教科書体 NP-R", Arial, Helvetica, sans-serif;
    }

    table {
        margin: 2em auto;
        border: none;
    }

    th, td, tr {
        text-align: right !important;
        padding: 1rem !important;
    }

    td {
        border-bottom: 1px solid gray;
    }
</style>


    
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53152247-5"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-53152247-5');
        </script>
    
<body>
        <header><nav>
    <a href="/"><img alt="Logo" src="/logo.png" height="70"></a>
    
</nav>

<h1>だるろぐ - だるやなぎのブログ</h1>

<p></p>



<hr></header>

        <main>
<article>
    <h1>Visual Studio 2017 で Windows サービスを作った</h1>
    
    <p class="published">
        <time>
            公開日：
            2017/03/10
        </time>        
    </p>

    <figure>
    <img src="/images/20170310210104.png"/> 
</figure>

<p>ぁ、この程度のことであれば、今までとあんまり変わらんと思うけどね。ちょこちょこ便利になってる感じはある。</p>
<div class="section">
    ### 今回の目標
    実行ファイルが書き換わったら、トーストで通知してほしい。
</div>
<div class="section">
    ### プロジェクトを作成する
<figure>
    <img src="/images/20170310210338.png"/> 
</figure>

<p>テンプレート］－［Visual C#］－［Windows クラシック デスクトップ］を開いて、“Windows サービス（.NET Framework）”を選択。すると、Windows サービス プロジェクトのスケルトンがブリブリっと吐かれる。Service1.cs では味気ないので、今回は MihariService.cs という名前にした。“見張り”やね（以前にもそういう名前のアプリを作って放置してたっけ）。</p>
<figure>
    <img src="/images/20170310210613.png"/> 
</figure>

<p>に MihariService.cs のデザイナー画面を開き、コンテキストメニューの［インストーラーの追加］コマンドを実行。</p>
<figure>
    <img src="/images/20170310210915.png"/> 
</figure>

<p>ると ServiceInstaller.cs というのが作成されます。このデザイン画面で ServiceInstaller1 を探し、プロパティ画面からいい感じにプロパティを設定。今回はこんな感じにした。</p>
<ul>
<li>ServiceName：MihariService（アプリ ID のノリでどこでも使っていくやで）</li>
<li>DisplayName：Mihari サービス（WIndowsの「サービス」からはこれが見えるらしい。日本語にした）</li>
<li>Description：システム内で EXE ファイルが変更されるのを監視します</li>
<li>StartType：Automatic（これでたぶん自動実行されるはず）</li>
</ul>最低限の準備はこれでいいみたい。まだ中身はないけれど、ソリューションをビルドする。
</div>
<div class="section">
    ### サービスの登録とデバッグ
<figure>
    <img src="/images/20170310211757.png"/> 
</figure>

<p>のままデバッグ実行をしても、エラーが出る。ビルドした Windows サービスをシステムに登録しなきゃいけない。</p>
<figure>
    <img src="/images/20170310211520.png"/> 
</figure>

<p>ず、ツールの類にパスの通ったコマンドプロンプトを起動（よくわかんないけど Developer Command Prompt for VS 2017 というのでいいみたい）。</p>
<figure>
    <img src="/images/20170310211358.png"/> 
</figure>

<p>ebug フォルダーに移動してパスをコピーしておき、コマンドプロンプトで移動。installutil で MihariService.exe をシステムに登録する。</p>
<pre><code>**********************************************************************
** Visual Studio 2017 Developer Command Prompt v15.0.26228.4
** Copyright (c) 2017 Microsoft Corporation
**********************************************************************
&gt; cd （Debug フォルダー）

&gt; installutil MihariService.exe
</code></pre><figure>
    <img src="/images/20170310212252.png"/> 
</figure>

<p>グインを求められたら、ユーザー名とパスワードを入力。ユーザー名はコンピュータ名から始まる完全な奴じゃないとダメみたい。</p>
<pre><code>&gt; whoami
```で取得したのをコピーして使うといい。

<figure>
    <img src="/images/20170310212519.png"/> 
</figure>


とは「サービス」に移動して、登録したサービスを開始する。

&lt;/div&gt;
&lt;div class=&quot;section&quot;&gt;
    ### デバッグ
    

<figure>
    <img src="/images/20170310212629.png"/> 
</figure>


バッグを行うには Windows サービスのプロセスにアタッチすればよい。

<figure>
    <img src="/images/20170310212806.png"/> 
</figure>


すべてのユーザーからのプロセスを表示する］オプションを有効化し、フィルターで Mihari を探すと早い。あとはブレークポイントを仕掛けるなりなんなりご自由に。リビルドのときは サービスを止める → ビルド → サービスを開始する（→再びアタッチする）みたいな作業フローで。ちょっと面倒くさいけど仕方ない（もしかしたら自動化できるのかもだけど、そこまではいいや）。

&lt;/div&gt;
&lt;div class=&quot;section&quot;&gt;
    ### ファイルを監視する
    

<figure>
    <img src="/images/20170310213029.png"/> 
</figure>


んどくさくなった。MihariService.cs に FileSystemWatcher を追加して、いろいろコードを書けばおっけ。 完成してから気づいたんだけど、サービスから通知トーストを出しても、クリックに反応してくれないんだな（フォルダーを開いたりしてほしい）。単にログだけ出力し、そのログを監視してトーストを出すクライアントを別途作った方がよかった。[Windowsサービスの作り方講座　その１ - おろかな日々](http://rinta.hatenablog.com/entry/20110102/p2)[WindowsサービスをC#で書く - backyard of 伊勢的新常識](http://iseebi.hatenablog.com/entry/20080603/p1)先人たちのおかげですんなり完成しました。

&lt;/div&gt;

</code></pre>
</article>

<section>
    <style>
        article p.published { text-align: right; }

        .spacer { margin: auto 1em;}
    </style>

    <p>
        
        <a href="https://blog.daruyanagi.jp/entry/2017/03/09/194122/">&laquo; Older</a>
        
        <span class="spacer">|</span>
        <a href="/">Home</a>
        <span class="spacer">|</span>
        <a href="#">Top</a>
        <span class="spacer">|</span>
        
            <a href="https://blog.daruyanagi.jp/entry/2017/03/11/151103/">Newer &raquo;</a>
        
    </p>    
    
</section>


        </main>
        
        <footer><hr>
<p>
    <a href="/about">daruyanagi</a> &copy; 2007-2020
</p></footer>
    </body>
</html>
