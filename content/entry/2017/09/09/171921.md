
+++
date = "2017-09-09 17:19:21 +0000 UTC"
draft = false
title = "Razor Pages：PhantomJS で動的サイトをスクレイピングする（2）"
tags = ["ASP.NET Core Razor Page","ASP.NET Core Web API"]

+++
[Razor Pages：PhantomJS で動的サイトをスクレイピングする - だるろぐ](http://blog.daruyanagi.jp/entry/2017/09/08/235450)前回、<a href="http://blog.daruyanagi.jp/entry/2017/09/08/235450">AngleSharp</a> を使えばよかったかもといったのですが、結果的にはちょっと大変かなって感じでした。
```cs
var document = default(IHtmlDocument);
            
using (var client = new HttpClient())
using (var stream = await client.GetStreamAsync(Target))
{
    var parser = new HtmlParser();
    document = await parser.ParseAsync(stream);
}

Result = document.QuerySelector(Selector)?.InnerHtml;

return Page();

```確かにシンプルなのですが、外部 JavaScript を読んで、評価して……までやりだすと、いろいろ大変な感じ<a href="#f-4db4db9a" name="fn-4db4db9a" title="すごく頑張ればできなくはなさそうだけど、バージョンアップで API が変わってたりでちょっと調べるのが面倒になった">*1</a>。これまで通り PhantomJS でやった方がよさそう。――というわけで。今回はそっちを置いておいて、Web API として使えるようにしてみました。ASP.NET API（Core）を使うのは初めてだったんですが、今回のような単純なモノであれば一瞬でできました。
```cs
namespace WebApplication7.Controllers
{
    [Route("api/[controller]")]
    public class ValuesController : Controller
    {
        // GET api/values
        [HttpGet]
        public IEnumerable&lt;string> Get()
        {
            return new string[] { "value1", "value2" };
        }
    }
}

```<code>/api/values</code> をゲットでたたくと、<code>{ "value1", "value2" }</code> が返ってくる。これと組み合わせて、API Controller を Razor Pages で呼び出して使いたいなーと、ちょっと四苦八苦していたのですが、それはちょっと筋悪だったよう。結局は、API と Razor Pages で共通のロジックをまとめて（適当に <code>Services</code> フォルダーにまとめました）、共有することにしました。{{< figure src="/images/20170909170801.png"  >}}共有部分はこんな感じ。
```cs
// サービスと名付けたモノ（/Services）

namespace WebApplication7.Services
{
    public static class DynamicScrapingService
    {
        public static string Process(Models.ScrapingRequest request)
        {
            var root_dir = Hosting.Environment.ContentRootPath;
            var work_dir = System.IO.Path.Combine(root_dir, "Tools");
            var script_name = "scrape.js";

            var info = new System.Diagnostics.ProcessStartInfo()
            {
                Arguments = $@"""{script_name}"" ""{request?.Target}"" ""{request?.Selector}""",
                FileName = System.IO.Path.Combine(work_dir, "phantomjs.exe"),
                CreateNoWindow = true,
                RedirectStandardOutput = true,
                StandardOutputEncoding = System.Text.Encoding.UTF8,
                UseShellExecute = false,
                WorkingDirectory = work_dir,
            };

            using (var process = new System.Diagnostics.Process() { StartInfo = info, })
            {
                var output = string.Empty;

                process.OutputDataReceived += (s, a) => { output += a.Data; };

                process.Start();
                process.BeginOutputReadLine();
                process.WaitForExit();

                // エラー出力をちょん切る
                var r = new System.Text.RegularExpressions.Regex("{.+}");
                output = r.Match(output).Value;

                return output;
            }
        }
    }
}

// モデル的なモノ（/Models）

namespace WebApplication7.Models
{
    public class ScrapingRequest
    {
        public Uri Target { get; set; }
        public string Selector { get; set; }
    }
}

namespace WebApplication7.Models
{
    public class ScrapingResult
    {
        public string Url { get; set; }
        
        public string Selector { get; set; }
        
        public string Status { get; set; }
        
        public string Text { get; set; }
    }
}

```これを Index.cshtml では
```cs
namespace WebApplication7.Pages
{
    public class IndexModel : PageModel
    {
        public IndexModel()
        {
            ScrapinRequest = new Models.ScrapingRequest()
            {
                Target = new Uri("https://blog.daruyanagi.jp/"),
                Selector = "footer",
            };
        }

        public Models.ScrapingRequest ScrapinRequest { get; set; }
        public Models.ScrapingResult ScrapingResult { get; set; }

        public void OnPost()
        {
            var output = Services.DynamicScrapingService.Process(ScrapinRequest);
            ScrapingResult = Newtonsoft.Json.JsonConvert.DeserializeObject&lt;Models.ScrapingResult>(output);
        }
    }
}

```こんな感じに呼び出します。{{< figure src="/images/20170909171117.png"  >}}API Controller ではこんな感じに使ってみました。JSON で渡して、JSON で返してくれる感じ。
```cs
namespace WebApplication7.Controllers
{
    [Route("api/[controller]")]
    public class DynamicScrapingController : Controller
    {   
        [HttpPost]
        public IActionResult Index([FromBody] Models.ScrapingRequest request)
        {
            var output = Services.DynamicScrapingService.Process(request);
            return Json(output);
        }
    }
}

```テストはむかし @nakaji せんせいが教えてくれた Chrome 拡張機能を使ってみました。[WebAPIの動作確認にはAdvanced REST clientが便利そう - なか日記](http://blog.nakajix.jp/entry/2014/06/24/005200)大変便利なのでこれからも常用していこうと思います。{{< figure src="/images/20170909171326.png"  >}}<br/>


<div class="section">
    ### 追伸
    前回書き忘れたのですが、ASP.NET Core には <code>Server.MapPath()</code> がないみたい。
```cs
namespace WebApplication7
{
    public class Startup
    {
        public Startup(IConfiguration configuration)
        {
            Configuration = configuration;
        }

        public IConfiguration Configuration { get; }

        // This method gets called by the runtime. Use this method to add services to the container.
        public void ConfigureServices(IServiceCollection services)
        {
            services.AddMvc();
        }

        // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
        public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)
        {
            app.UseMvc();

            Hosting.Environment = env;
        }
    }

    public static class Hosting
    {
        public static IHostingEnvironment Environment { get; set; }
    }
}

```適当に IHostingEnvironment を保存しておくようにしたのですが（<code>Hosting.Environment.ContentRootPath</code> でルートがわかるので、それを <code>Path.Combine()</code> なんかでごにょごにょする）、これがいい作法なのかどうかは自信がない。

</div>
<div class="section">
    ### 追伸2
    そのまま Azure Web Site に置けなくて泣いてる。

</div><div class="footnote">
<a href="#fn-4db4db9a" name="f-4db4db9a" class="footnote-number">*1</a><span class="footnote-delimiter">:</span><span class="footnote-text">すごく頑張ればできなくはなさそうだけど、バージョンアップで API が変わってたりでちょっと調べるのが面倒になった</span>
</div>

