
+++
date = "2012-02-02 22:57:59 +0000 UTC"
draft = false
title = " RSS 2.0 を実装する"
tags = ["C#"]

+++
<a href="http://sample.com/Post/LastUpdated.rss">http://sample.com/Post/LastUpdated.rss</a> で RSS が吐かれるようにしてみたかった。まずはルーティング。

    ```
#Global.asax.cs

routes.MapRoute(
    "Mode", // ルート名
    "{controller}/{action}.{mode}", // パラメーター付きの URL
        new { controller = "Home",
        action = "Index",
        id = UrlParameter.Optional,
        mode = "html" } // パラメーターの既定値
);
```
次はコントローラー。IPagedList は自分で作ったページング機能付きのリスト。"<a href="http://sample.com/Post/LastUpdated?mode=rss">http://sample.com/Post/LastUpdated?mode=rss</a>" でアクセスしてもいい。レポジトリパターンにしたのにここで IPagedList 作ってるのはダサいので、あとで直そう…

    ```
#Post.cs

//
// GET: /Post/LastUpdated

public ViewResult LastUpdated(int current = 1, int items_per_page = 10, string mode = "html")
{
    var posts = new PagedList&lt;Post>(
        repository.GetList().OrderByDescending(p => p.UpdatedAt),
        current, items_per_page);

    switch (mode)
    {
        case "rss":
            return View("LastUpdated.rss", posts);
        default:
            return View(posts);
    }
}
```
最後にビュー。"LastUpdated.rss.cshtml"ってのを追加する。XML宣言をファイルの先頭にしたほうがいいのかな。あと、Response.ContentType に "application/rss+xml" を設定して、「今から返すんはRSSやで！」と教えておく。

    ```
&lt;?xml version="1.0" encoding="utf-8"?>

@model IEnumerable&lt;Daruwiki.Models.Post>

@{
    Layout = string.Empty;
    Response.ContentType = "application/rss+xml";

    var Title = App.Name;
    var SiteUrl = "http://" + Request.Url.Authority;
    var RssUrl = Request.Url;
    var Description = "";
    var LastUpdated = GetUnixTime(Model
        .OrderByDescending(p => p.CreatedAt).First().CreatedAt);
}

@functions
{
    private static DateTime UNIX_EPOCH =  new DateTime(1970, 1, 1, 0, 0, 0, 0);
    
    public static long GetUnixTime(DateTime targetTime)
    {
        targetTime = targetTime.ToUniversalTime();
        TimeSpan elapsedTime = targetTime - UNIX_EPOCH;
        return (long)elapsedTime.TotalSeconds;
    }
}

&lt;rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
&lt;channel>
  &lt;title>@Title&lt;/title>
  &lt;link>@SiteUrl&lt;/link>
  &lt;atom:link href="@RssUrl" rel="self" type="application/rss+xml" />
  &lt;description>@Description&lt;/description>
  &lt;language>ja&lt;/language>
  &lt;lastBuildDate>@LastUpdated&lt;/lastBuildDate>
@foreach (var item in Model)
{
  &lt;item>
    &lt;title>@item.Title&lt;/title>
    &lt;link>@SiteUrl/@item.Title&lt;/link>
    &lt;guid>@item.PostId&lt;/guid>
    &lt;pubDate>@item.CreatedAt&lt;/pubDate>
    &lt;description>&lt;![CDATA[@Html.Raw(item.FormattedBody)]]>&lt;/description>
  &lt;/item>
}
&lt;/channel>
&lt;/rss>
```

    >
        でけた。でも、その直後に RssResult っていうのがあるっぽいことを知った

        Twitter
    

    >
        @daruyanagi WCF とか使えば出力できそうな気が

        Twitter
    
勉強が足りない。


