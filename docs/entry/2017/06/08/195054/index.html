<!DOCTYPE html>
<html><link rel="icon" href="https://via.placeholder.com/70x70">
<link rel="stylesheet" href="https://andybrewer.github.io/mvp/mvp.css">

<meta charset="utf-8">
<meta name="description" content="My description">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Tonjiru v1.2.0 ＋ WPF での起動オプション、ジャンプリスト、トースト - だるろぐ - だるやなぎのブログ</title>

<style>
    nav {
        margin-bottom: 0;
    }

    body {
        font-family: "UD デジタル 教科書体 NP-R", Arial, Helvetica, sans-serif;
    }

    table {
        margin: 2em auto;
        border: none;
    }

    th, td, tr {
        text-align: right !important;
        padding: 1rem !important;
    }

    td {
        border-bottom: 1px solid gray;
    }
</style>


    
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53152247-5"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-53152247-5');
        </script>
    
<body>
        <header><nav>
    <a href="/"><img alt="Logo" src="/logo.png" height="70"></a>
    
</nav>

<h1>だるろぐ - だるやなぎのブログ</h1>

<p></p>



<hr></header>

        <main>
<article>
    <figure>
    <img src="/images/20170608192727.png"/> 
</figure>

<p>br/&gt;</p>
<ul>
<li>起動オプションの追加（/g で GUI 付きの起動）</li>
<li>ジャンプリストへの対応（GUI 付きの起動を追加）</li>
<li>ウィンドウ情報のクリップボードコピー（JSON 形式）</li>
<li>ウィンドウ情報のファイル保存（JSON 形式）</li>
<li>通知機能</li>
<li>安定性の向上</li>
</ul>
<div class="github-card" data-user="daruyanagi/Tonjiru/releases/tag" data-repo="v1.2.0" data-width="400" data-height="" data-theme="default"></div
<blockquote>
</blockquote>
<script src="https://cdn.jsdelivr.net/github-cards/latest/widget.js"></script>
<br/>
<div class="section">
    ### WPF と起動オプション
    起動時に［Shift］キーが押されていたら GUI を起動するという挙動は
<ul>
<li>App.xaml の StartupUri を削除</li>
<li>App.Startup でキーの押し下げ確認と MainWindow の自前生成</li>
</ul>という感じで実現していたんだけど、起動オプションを付けたら破綻したので、
<ul>
<li>App.xaml の StartupUri を元に戻す</li>
<li>App.xaml のビルドアクションを Page にして、main 関数を自分で書く</li>
</ul>という感じに変えた。
```cs
[System.STAThreadAttribute()]
public static void Main()
{
    var args = Environment.GetCommandLineArgs();
<pre><code>if (args.Contains(&quot;/g&quot;) || (Control.ModifierKeys &amp;amp; Keys.Shift) == Keys.Shift)
{
    var app = new Tonjiru.App();
    app.InitializeComponent();
    app.Run();
}
else // UI less mode
{
    CloseAllWindowsAndExit();
}
</code></pre>
<p>}</p>
<pre><code class="language-/h" data-lang="/h">
&lt;/div&gt;
&lt;div class=&quot;section&quot;&gt;
    ### ジャンプリスト
    起動オプションを付けた副産物として、ジャンプリストへの対応が簡単になった。App.xaml に以下のように記述。
```xml
x:Class=&quot;Tonjiru.App&quot;
             xmlns=&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;
             xmlns:x=&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;
             xmlns:local=&quot;clr-namespace:Tonjiru&quot;
             StartupUri=&quot;Views\MainWindow.xaml&quot;&gt;
    .Resources&gt;
         
    .Resources&gt;

    .JumpList&gt;
        &lt;jumplist&gt;&lt;/jumplist&gt;
            Title=&quot;Launch with GUI&quot;
                Description=&quot;Launch with GUI&quot; 
                Arguments=&quot;/g&quot; /&gt;
        
    .JumpList&gt;


```ジャンプリストは最近忘れられてる気がするけど、割かし便利だと思う。対応アプリが増えるといいな。なお、ジャンプリストから起動するとワーキングディレクトリが System フォルダーになった気がする。設定ファイルなどをロードするとき、パス検索をいい加減にしていると痛い目にあう（あった）。

&lt;/div&gt;
&lt;div class=&quot;section&quot;&gt;
    ### ValueTupple と DataContractJsonSerializer
    ウィンドウ情報の保存は手抜きで DataContractJsonSerializer を使ったんだけど、Model をそのままシリアライズするとサイズがすごく大きくなってしまった。そこで情報を間引いたんだが、ここでタプルが使えるのではないかと気づいた。
```cs
list.Select(_ =&gt; (title: _.Title, process: _.ProcessName)); // これをシリアライズ

```試しにこれを
```cs
DataContractJsonSerializer(typeof(ValueTupple&amp;lt;string, string&gt;));

DataContractJsonSerializer(typeof((string title, string process)));

```みたいに使ってみたところ――とりあえずコンパイルは通り、普通に使えた。けれど、出力される JSON がどっちも
</code></pre><p>[{ &ldquo;Item1&rdquo;: &ldquo;hoge&rdquo;, &ldquo;Item2&rdquo;: &ldquo;fuga&rdquo; }]</p>
<pre><code class="language-みたいな感じになる（ほんとは" data-lang="みたいな感じになる（ほんとは">
&lt;/div&gt;
&lt;div class=&quot;section&quot;&gt;
    ### 通知
    WPF でトーストを出そうと思うと WindowsRuntime を使わなくちゃーってなりがちだけど、ただ出したいだけであれば NotifyIcon で ShowBalloonTip() するのが楽でいい。Windows 7 だとバルーンだが、Windows 10 ではトーストになる。
```cs
using (var notify_icon = new System.Windows.Forms.NotifyIcon())
{
    notify_icon.Icon = System.Drawing.Icon.ExtractAssociatedIcon(System.Reflection.Assembly.GetEntryAssembly().Location);
    notify_icon.Visible = true;

    notify_icon.BalloonTipTitle = System.Reflection.Assembly.GetExecutingAssembly().GetName().Name;
    notify_icon.BalloonTipText = message;
    notify_icon.ShowBalloonTip(3000);
}

```簡単だね！

<figure>
    <img src="/images/20170608194803.png"/> 
</figure>


イントは Visible を true にしておくこと（じゃないとトーストが出てこない）、最後に Visible を False にするか Dispose() すること（でないとトレイにアイコンがゾンビ）ぐらい。

&lt;/div&gt;

</code></pre>
</article>

<section>
    <style>
        .spacer { margin: auto 1em;}
    </style>

    <p>
        
        <a href="https://blog.daruyanagi.jp/entry/2017/06/07/191844/">&laquo; Older</a>
        
        <span class="spacer">|</span>
        <a href="/">Home</a>
        <span class="spacer">|</span>
        <a href="#">Top</a>
        <span class="spacer">|</span>
        
            <a href="https://blog.daruyanagi.jp/entry/2017/06/09/175700/">Newer &raquo;</a>
        
    </p>    
    
</section>


        </main>
        
        <footer><hr>
<p>
    <a href="/about">daruyanagi</a> &copy; 2007-2020
</p></footer>
    </body>
</html>
