
+++
date = "2012-08-24 09:50:23 +0000 UTC"
draft = false
title = "WebMatrix でユーザー認証機能 ―― 準備編"
tags = ["ASP.net Web Pages","WebMatrix"]

+++
お次はユーザー認証機能に挑戦しますかね？　Webサイトでデータを扱うとき、ユーザー認証機能がなかったらだいぶ困る。というわけで、“Startar Site”テンプレートをみながら勉強しようかなぁ、と思ったのだけど……<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120824/20120824092022.png" alt="f:id:daruyanagi:20120824092022p:plain" title="f:id:daruyanagi:20120824092022p:plain" class="hatena-fotolife"/>ナンテコッタイ／(^o^)＼　ソースを見てみたら文字化けしてたり改行が吹っ飛んでたりで、一部ソースコードがぶっ壊れていた。修正を試みたのだけれど、途中で「いや待て、“Empty Site”から自分で作ったほうが勉強になるかもしれない」と思い直し、まっさらなWebサイトを作ってユーザー認証機能を追加してみることにした。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120824/20120824092316.png" alt="f:id:daruyanagi:20120824092316p:plain" title="f:id:daruyanagi:20120824092316p:plain" class="hatena-fotolife"/>

<div class="section">
    ### データベースを作成
    まずはユーザー情報を格納するデータベースを作成。名前は……思いつかなかったから“database.sdf”でいいや。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120824/20120824092517.png" alt="f:id:daruyanagi:20120824092517p:plain" title="f:id:daruyanagi:20120824092517p:plain" class="hatena-fotolife"/>リネームした時のことを考えて、データベース名は App に格納しておくことにした。アプリケーションの起動時に実行される _AppStart.cshtml に記述しておく。
```cs
#_AppStart.cshtml

@{
    App.Database = "database"; // 拡張子は要らないっぽい
}

```
</div>
<div class="section">
    ### ユーザー情報テーブルを作成
    次に、認証情報を保存しておくテーブルを作成する。 WebMatrix では WebSecurity Helper というお手軽な認証システムがあるらしい。“Startar Site”テンプレートでも利用されていたのでそれを使おう。 WebSecurity.InitializeDatabaseConnection() でユーザー情報を管理するテーブルが初期化されるみたい。
```cs
#_AppStart.cshtml

@{
    App.Database = "database";
    
    WebSecurity.InitializeDatabaseConnection(
        App.Database, // データベース名
        "Users",      // テーブル名
        "UserId",     // ID を格納するカラム
        "Name",       // 一意なユーザー名を格納するカラム
        true          // テーブルがなかったら作れ
    );
}

```しかし、「WebSecurity などというクラスは知らない」と怒られてしまう。デフォルトでは入っていないのね……<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120824/20120824093457.png" alt="f:id:daruyanagi:20120824093457p:plain" title="f:id:daruyanagi:20120824093457p:plain" class="hatena-fotolife"/>“Startar Site”テンプレートを「Visual Studio」でみてみたら、 WebMatrix.WebData.dll というアセンブリが必要であるらしい。これもどうせ NuGet で取得できるんでしょ？ わかってる、わかってる！

</div>
<div class="section">
    ### Microsoft ASP.NET Web Page 2 Web Data をインストール
    <img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120824/20120824093635.png" alt="f:id:daruyanagi:20120824093635p:plain" title="f:id:daruyanagi:20120824093635p:plain" class="hatena-fotolife"/>そこで適当に「WebData」などと検索してみたところ、「Microsoft ASP.NET Web Page 2 Web Data」というのがどうもあやしいくさい。さっそくインストールしてみると……ビンゴ！　無事、Web サイトを［実行］できました。テーブルもちゃんと作成されているみたい（まだからっぽだけど！）。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120824/20120824093836.png" alt="f:id:daruyanagi:20120824093836p:plain" title="f:id:daruyanagi:20120824093836p:plain" class="hatena-fotolife"/>
```html
#Default.cshtml

@{
    
}



&lt;html lang="ja">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>マイ サイトのタイトル&lt;/title>
    &lt;/head>
    &lt;body>
        <!-- Starter Site テンプレートからパクって魔改造してみた！ -->
        &lt;section id="login">
        @if (WebSecurity.IsAuthenticated) {
            &lt;ul>
                &lt;li>&lt;a href="~/Users/@WebSecurity.CurrentUserName">
                @WebSecurity.CurrentUserName&lt;/a>&lt;/li>
                &lt;li>&lt;a href="~/Account/Logout">ログアウト&lt;/a>&lt;/li>
            &lt;/ul>
        } else {
            &lt;ul>
                &lt;li>&lt;a href="~/Account/Register">登録&lt;/a>&lt;/li>
                &lt;li>&lt;a href="~/Account/Login">ログイン&lt;/a>&lt;/li>
            &lt;/ul>
        }
        &lt;/section>
    &lt;/body>
&lt;/html>

```コレで準備は完了といったところかな。とりあえず、 Register / Login / Logout を作って、ユーザーページも表示できるようにしたいな。

</div>

