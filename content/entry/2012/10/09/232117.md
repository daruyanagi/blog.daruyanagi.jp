
+++
date = "2012-10-09 23:21:17 +0000 UTC"
draft = false
title = "WebMatrix/ASP.NET Web Pages で Jekyll っぽいものを"
tags = ["ASP.net Web Pages","WebMatrix"]

+++
<a href="https://github.com/mojombo/jekyll">GitHub - jekyll/jekyll: Jekyll is a blog-aware static site generator in Ruby</a> というのは、Markdown ドキュメントを置いておくとそれを HTML に変換しておいてくれる静的コンテンツの生成システムらしい。Jekyll ドキュメントはこんなかんじ。
```
---
layout: post
title: テスト投稿タイトル
date: 2012-04-01 09:00:00
category : サンプル
tags : [intro, 初心者, jekyll, tutorial]
---

テスト投稿本文

- a
- b
- c

[http://daruyanagi.net](http://daruyanagi.net/)
```Markdown テキストの先頭に YAML Front-Matter と呼ばれる設定を書いておけば、タイトル・レイアウト・投稿日時・カテゴリ・タグといったメタデータを付与することもできる。なんだか便利臭がプンプンするぜ。さて、これを WebMatrix で HTML ドキュメントに変換してみようというのが今日のお題。<a href="https://blog.daruyanagi.jp/entry/2012/09/27/213159">SignalR + WebMatrix でサーバーフォルダの監視を行ってみる - だるろぐ</a> などと組み合わせたら面白いものができそうな気がする。

<div class="section">
    ### 必要なライブラリ
    
<ul>
<li>MarkdownSharp</li>
<li>YamlSerializer for .NET（<a href="https://blog.daruyanagi.jp/entry/2012/10/07/113945">WebMatrix/ASP.NET Web Pages で YAML を扱う - だるろぐ</a>）</li>
</ul>どちらも NuGet で取得できる。

</div>
<div class="section">
    ### サンプルコード
    先ほどの Jekyll ドキュメントを ~/Default.md としておき、これを ~/Default.cshtml で読み込んで変換・表示してみる。あくまでもサンプルなので、汚いところ、あからさまにダメなところは無視してほしいかな（笑
```cs
@using System.Text.RegularExpressions
@using System.Yaml

@{
    var path = Server.MapPath("~/Default.md");

    var s = System.IO.File.ReadAllText(path);

    // YAML Front-Matter を抽出する適当な正規表現
    var r = new Regex("---.+---", RegexOptions.Singleline);

    // YAML Front-Matter を取得（エラー処理なし！）

    /* 配列として受け取る → 先頭はマッピング（ハッシュ）のはず */
    var node = YamlNode.FromYaml(r.Match(s).ToString())[0]
            as YamlMapping;

    //YAML Front-Matter の値を変数に格納する

    /* スカラ（値）の場合 */
    var title = (node["title"] as YamlScalar)
        .Value; // &lt;- 生テキスト！
    var date = (node["date"] as YamlScalar)
        .NativeObject; // &lt;- DateTime!
    var category = (node["category"] as YamlScalar).Value;
    var layout = (node["layout"] as YamlScalar).Value;

    /* シーケンス（配列）の場合 */
    var tags = (node["tags"] as YamlSequence)
        .Select(_ => (_ as YamlScalar).Value);

    // YAML Front-Matter を除去（危険が危ないデシ！）
    s = r.Replace(s, string.Empty);

    // 残りは Markdown ドキュメントです
    var m = new MarkdownSharp.Markdown();
    var text = m.Transform(s);
}

&lt;!DOCTYPE html>

&lt;html lang="ja">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>@title&lt;/title>
    &lt;/head>
    &lt;body>
        &lt;h1>@title&lt;/h1>

        @Html.Raw(text)

        &lt;h2>Posted at&lt;/h2>
        &lt;p>@date&lt;/p>

        &lt;h2>Category&lt;/h2>
        &lt;p>&lt;a href="~/Category/@category">@category&lt;/a>&lt;/p>

        &lt;h2>Tags&lt;/h2>
        &lt;ul>
        @foreach(var tag in tags)
        {
            &lt;li>&lt;a href="~/Tag/@tag">@tag&lt;/a>&lt;/li>
        }
        &lt;/ul>
    &lt;/body>
&lt;/html>

```{{< figure src="/images/20121009231737.png"  >}}なんとなく動いてるっぽい。

</div>

