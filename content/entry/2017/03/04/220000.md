
+++
date = "2017-03-04 22:00:00 +0000 UTC"
draft = false
title = "PowerShell：ストアアプリのセール情報を取得する"
tags = ["PowerShell"]

+++
```ps1
# スクリプトと同じパスにある StoreApps.txt から URL を読み込む
$path = $PSScriptRoot | Join-Path -ChildPath "StoreApps.txt"
$urls = (Get-Content $path) -as [string[]]

# デバッグ用のサンプル
# $urls =@(
# "https://www.microsoft.com/ja-jp/store/p/nextgen-reader/9wzdncrfj262"
# )

foreach ($url in $urls)
{
    try
    {
        $request = Invoke-WebRequest $url
        
        # アプリ名を取得
        $title = $request.AllElements.FindById("page-title").innerText

        # ParsedHtml もめっちゃ便利やったぞ！
        # 例：打消し線の付いた定価タグを取得
        $body = $request.ParsedHtml
        $price_node = $body.getElementsByTagName("s") | where { 
            $_.getAttributeNode("class").Value  -eq "srv_saleprice"
        }

        # 定価が打ち消されていたらセール中ってこと
        if ($price_node)
        {
            $price = $price_node.innerText

            # 販売価格（セール価格）の取得
            $sales_node = $body.getElementsByTagName("meta") | where {
                $_.getAttributeNode("itemprop").Value  -eq "price"
            }
            $sales = "¥{0:#,0}"
                -f [int]$sales_node.getAttributeNode("content").Value

            # セール期間を取得
            $countdown_node = $body.getElementsByTagName("div") | where {
                $_.getAttributeNode("class").Value
                -eq "caption text-muted srv_countdown"
            }
            $countdown = $countdown_node.innerText
            $countdown = $countdown.Replace(" • ", "").Trim()

            # デバッグに使ってた
            # [PSCustomObject] @{
            #    Title = $title; Sales = $sales;
            #    Price = $price; Url = $url
            # }

# 今回は成形したはてな記法テキストを出力
@"
* $title

<s></s>$price → <b></b>$sales（$countdown）

$url`:embed

"@
        }
    
    }
    catch
    {
        Write-Host $Error[0] $url
    }
    finally
    {
        $sales_node = $null
        $sales = $null
        $price_node = $null
        $price = $null
    }
}

```結果はこんな感じ。
```
* Nextgen Reader

&lt;s>¥200&lt;/s> → &lt;b>&amp;yen;100&lt;/b>（¥100 値引き  あと 7 日です）

https://www.microsoft.com/ja-jp/store/p/nextgen-reader/9wzdncrfj262:embed

* Minecraft: Windows 10 Edition

&lt;s>¥3,150&lt;/s> → &lt;b>&amp;yen;1,150&lt;/b>（¥2,000 値引き  あと 17 日です）

https://www.microsoft.com/ja-jp/store/p/minecraft-windows-10-edition/9nblggh2jhxj:embed

```これをそのまま投稿するとこんな記事になりました。<iframe src="http://store-watch.hatenadiary.jp/embed/2017/03/04/174241" title="本日のセール：Nextgen Reader、Minecraft: Windows 10 Edition - Windows Store Watch" class="embed-card embed-blogcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;"></iframe><br/>


<div class="section">
    ### 今日学んだこと
    
<div class="section">
    #### スクリプトのあるフォルダーを取得する
    PowerScript v3 以降では
```ps1
$PSScriptRoot

```が利用できる。それ以前だと、ちょっとめんどい（といってもひと手間増える程度だけど

</div>
<div class="section">
    #### キャストっぽいことをする
    型演算子 -as が使える。割と柔軟に使えるみたいだけど、俺みたいな万年初心者には、どこまで柔軟にやってくれるのかよくわかんないのが不安。
```ps1
$urls = (Get-Content $path) -as [string[]]

```失敗すると $null が返る。親戚として -is、-isnot もチェック！

</div>
<div class="section">
    #### 指定したクラスのタグを取得する
    たとえば s.srv_saleprice は以下のコードでとれる。
```ps1
$price_node = $request.ParsedHtml.getElementsByTagName("s") | where { 
    $_.getAttributeNode("class").Value  -eq "srv_saleprice"
}
$price_node.innerText

```ちなみに、クラスが"caption text-muted srv_countdown"みたいに複数指定されてるときは"srv_countdown"だけで -eq 判定してもダメ。全体で -eq 評価するか、-match を使う。まぁ、デフォルトでここまでできるのは便利だけど、それ以上はいろいろめんどいし、そろそろ HtmlAgilityPack でやるかなー。AllElements でとったタグの innerText を読むと改行が飛ぶといった挙動もあまり気に入らない（正規表現でお茶を濁した）。

</div>
<div class="section">
    #### ヒアドキュメント
    ```ps1
@"
ヒアドキュメント $url 変数も評価される
$url`:embed（はてな記法
"@

```変数に“:”が続くとそのまま評価されてしまう。困る場合は、バッククォートでエスケープすればいいみたい。ちなみに、変数を評価してほしくない場合はシングルクォートでくくる。

</div>
<div class="section">
    #### はてな記法で PowerShell を構文色分け
    コード記法で`ps1`を使う。

</div>
</div>

