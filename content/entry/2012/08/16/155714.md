
+++
date = "2012-08-16 15:57:14 +0000 UTC"
draft = false
title = "WebMatrix で Markdown を少しだけ拡張してみる"
tags = ["ASP.net Web Pages","WebMatrix"]

+++
前回（<a href="https://blog.daruyanagi.jp/entry/2012/08/16/043012">WebMatrix で Markdown を使おう！ - だるろぐ</a>）は、「WebMatrix 2」で Markdown を使ってみました。ついでに静的クラスを用意して、コードも少しキレイにしてみました。最終的にはこんな感じです。
```cs
# Markdown.cs

using System;
using System.IO;
using System.Text;
using System.Web;

/// &lt;summary>
/// Summary description for ClassName
/// &lt;/summary>
public static class Markdown
{
    private static readonly MarkdownSharp.Markdown md = 
        new MarkdownSharp.Markdown();
    private static readonly Encoding encoding = Encoding.UTF8;

    public static HtmlString Parse(string input)
    {
        return new HtmlString(md.Transform(input));
    }

    public static HtmlString LoadFromFile(string path)
    {
        return Parse(File.ReadAllText(path, encoding));
    }
}

```で、 Web ページ側ではこんな感じに使います。
```cs
# Page.cshtml

&lt;!DOCTYPE html>

@{
    var path = Server.MapPath(
        string.Format("{0}/{1}.markdown",
            "~/App_Docs/",
            UrlData.Count == 0
                ? "Default"
                : string.Join("/", UrlData)
        )
    );
}

&lt;html lang="en">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>&lt;/title>
    &lt;/head>
    &lt;body>
        @Markdown.LoadFromFile(path)
    &lt;/body>
&lt;/html>

```ところで、前回は脚注にこんなことを書いておきました。

    >
        （Markdown の）弱点は若干機能不足なこと。これを補う派生版が幾つかあります

    
その代表例が <a href="http://github.github.com/github-flavored-markdown/">Redirecting...</a> （GFM）です。たとえば、こんな書式でプログラミング言語を指定してシンタックスハイライトが行えます。
```
```ruby
require &#39;redcarpet&#39;
markdown = Redcarpet.new("Hello World!")
puts markdown.to_html
```
```これはいいですね！　さっそく取り入れてみましょう。

<div class="section">
    ### 準備
    まずはシンタックスハイライト機能をどうやって実現するか…… Google Code Prettify（<a href="http://google-code-prettify.googlecode.com/svn/trunk/README.html">http://google-code-prettify.googlecode.com/svn/trunk/README.html</a>）ならば NuGet で取得できるのですけど、今回は Highlight.js （<a href="http://softwaremaniacs.org/soft/highlight/en/">highlight.js</a>）を使ってみることにしました。なぜかというと、こっちのほうが言語サポートが幅広いみたいだからデス。ダウンロードして、以下のように配置しました。
```
~/
    /App_Code
        Highlight.cshtml &lt;-- あとで説明します！
        /Highlight
            Lisence Files
    /Content
        Highlight
        /    Theme Skins
    /Scripts
        /Highlight
            hilight.pack.js
```こうした状態で、
```html


&lt;html lang="en">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>&lt;/title>

        &lt;link rel="stylesheet" href="~/Content/Highlight/default.css">
        &lt;script src="~/Scripts/Highlight/highlight.pack.js">&lt;/script>
        &lt;script>hljs.initHighlightingOnLoad();&lt;/script>
    &lt;/head>
    &lt;body>
        &lt;pre>&lt;code class="language">
            // Any Code...
        &lt;/pre>&lt;/code>
    &lt;/body>
&lt;/html>

```などと記述すれば、 pre > code 内のコードが色分け表示されます。……しっかし、 Highlight.js は NuGet ないのか……めんどくせえな。久しぶりに作るかな。

</div>
<div class="section">
    ### コーディング
    お次は Markdown.cs を拡張して、 ```～``` 記法へ対応させます。適当に正規表現で解決してみました。
```cs
：
：
using System.Text.RegularExpressions;

public static class Markdown
{
    ：
    ：
    public static bool HighlightEnabled { get; set; }

    static Markdown()
    {
        HighlightEnabled = true;
    }

    public static string Highlight(string input)
    {
        const string R = @"```(?<type>\w+)\r(?<code>.+)```"</code></type>;
        const string F = @"<pre><code class="" {0}""="">{1}</code></pre>";

        Regex r = new Regex(R, RegexOptions.Singleline);

        return r.Replace(
            input,
            (m) => string.Format(
                F, m.Groups["type"],
                HttpUtility.HtmlEncode(m.Groups["code"])
            )
        );
    }
}

```完成<a href="#f-729061fc" name="fn-729061fc" title="なんで改行が \n でマッチせずに \r ではマッチするんだ……くっそくっそ">*1</a>！ m.Groups["code"] を HTML エンコードする必要があったのでラムダ式になりましたけれど、そうでなければ @"&lt;pre>&lt;code class=""${type}"">${code}&lt;/code>&lt;/pre>" で置換できるんですね。知らなかったわー。ちなみに、正規表現のテストはオンラインツールが便利です（<a href="http://regexhero.net/tester/">The .NET Regex Tester | Regex Hero</a>）。できあがりはこんな感じ。

{{< figure src="/images/20120816153937.png"  >}}

ighlightEnabled = false;

{{< figure src="/images/20120816153946.png"  >}}

ighlightEnabled = true;

</div>
<div class="section">
    ### ステップアップ
    最後に、少し細かいところをブラッシュアップしてみましょう。
```html
&lt;link rel="stylesheet" href="~/Content/Highlight/default.css">
&lt;script src="~/Scripts/Highlight/highlight.pack.js">&lt;/script>
&lt;script>hljs.initHighlightingOnLoad();&lt;/script>

```Highlight.js を使う際のおまじない、毎回書くの面倒ですね？　なので、ヘルパーとしてまとめてみました。 ~/App_Code/Highlight.cshtml に以下のように記述します。
```cs
@helper Include(string theme = "default"){
    &lt;link rel="stylesheet" href="~/Content/Highlight/@(theme).css">
    &lt;script src="~/Scripts/Highlight/highlight.pack.js">&lt;/script>
    &lt;script>hljs.initHighlightingOnLoad();&lt;/script>
}

```これで Web ページを使うときでも、 @Higjlight.Include() を呼び出すだけでOK！
```html


&lt;html lang="en">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>&lt;/title>

        @Higjlight.Include("vs") &lt;-- おまじないに変換される
    &lt;/head>

```引数を与えることでテーマを選択できるのもいい感じでしょう？　そうでもないデスか。まぁ、「鬼に金棒」、「怠け者にヘルパー」ってもんですよ。

</div><div class="footnote">
<a href="#fn-729061fc" name="f-729061fc" class="footnote-number">*1</a><span class="footnote-delimiter">:</span><span class="footnote-text">なんで改行が \n でマッチせずに \r ではマッチするんだ……くっそくっそ</span>
</div>

