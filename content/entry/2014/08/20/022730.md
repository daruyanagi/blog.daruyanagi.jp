
+++
date = "2014-08-20 02:27:30 +0000 UTC"
draft = false
title = "TwitterRT でストア アプリからお手軽ツイート（※要改修"
tags = ["Twitter","Windows ストア アプリ","WinRT"]

+++
{{< figure src="/images/20140820020905.png"  >}}Windows ストア アプリへ手軽にツイート機能を追加したいときに便利なライブラリが、<a href="http://twitterrt.codeplex.com/">TwitterRt - Tweet from Windows Metro Apps - Home</a>。こういう感じの WebAuthenticationBroker を使った認証処理を一行で実現してくれるのがいい。
```cs
private TwitterRt t = new TwitterRt(
    "consumerKey", 
    "consumerSecret",
    "callbackUrl"
);

 private async void Button1_Click(object sender, Windows.UI.Xaml.RoutedEventArgs args)
{
    // 認証
    await t.GainAccessToTwitter();
}

 private async void Button2_Click(object sender, Windows.UI.Xaml.RoutedEventArgs args)
{
    // ツイート
    await t.UpdateStatus("Hello From TwitterRt");
}

```ソースコードを斜め読みしかしてないのだけど、認証処理で取得したトークンなんかは自動で ApplicationData.RoamingSettings に保存してくれるっぽい。一度どこかの端末で認証しておけば、ほかの端末でもそれが自動で同期されるはず。超便利だな。でも、残念ながらメンテナンスされていないようで、NuGet で取得したバイナリが動かない。しょうがないのでソースコードを落としてきてちょろちょろっと直した。
```cs
// 46行目ぐらい

// const string _updateStatusUrl = "https://api.twitter.com/1/statuses/update.json";
const string _updateStatusUrl = "https://api.twitter.com/1.1/statuses/update.json";

```まずは Twitter の API を 1.0 → 1.1 へとアップデート。
```cs
// 295行目ぐらい

Request.Method = "POST";
Request.ContentType = "application/x-www-form-urlencoded"; // 追加
Request.Headers["Authorization"] = headers;

```ContentType も設定しなきゃいけないらしい。これだけで一応動くのだけど……
```cs
// 179行目ぐらい

// request.Add("status", Uri.EscapeDataString(status));
request.Add("status", Uri.EscapeDataString(status.Replace("\r\n", "\n")));

```改行を含んだテキストをツイートできるように、もう一カ所修正しておいた。

<ul>
<li><a href="http://coelacanth.jp.net/windows%E3%82%B9%E3%83%88%E3%82%A2%E3%82%A2%E3%83%97%E3%83%AA%E5%85%A5%E9%96%80-vol73twitterrt%E3%81%A7%E3%81%8A%E6%89%8B%E8%BB%BD%E3%81%AB%E3%81%A4%E3%81%B6%E3%82%84%E3%81%8F/">Windowsストアアプリ入門 vol73:TwitterRtでお手軽につぶやく | 眠るシーラカンスと水底のプログラマー</a></li>
</ul>

