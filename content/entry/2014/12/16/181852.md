
+++
date = "2014-12-16 18:18:52 +0000 UTC"
draft = false
title = "WebMatrix：　@nakaji のコードをパクって「えひめFreeWi-Fi」スポットを Google Map へマッピング"
tags = ["WebMatrix"]

+++
{{< figure src="/images/20140728155412.jpg"  >}}<a href="http://nakaji.hatenablog.com/entry/2014/12/16/090000">SGMLReaderで「えひめFreeWi-Fi」サービス提供箇所をスクレイピング - なか日記</a> を読んで存在を知った。

    >
        産学官で構成する愛媛県公衆無線LAN推進協議会では、外国人観光客や県内外の旅行者、地域住民等が無料で利用できるWi-Fiスポットの整備を民設民営で進めることにより、その利便性を確保し、愛媛県内の地域活性化を図る「えひめFreeWi-Fiプロジェクト」を推進しています。

        愛媛県庁／えひめFree Wi-Fiサービス提供箇所等のお知らせ
    
“利便性を確保し”とか“地域活性化を図る”とかいってる割りには、クソ不便なテーブルデータしか用意してないのって、ほんとお役所だなーと思いますね。というわけで、なかじが作ってくれたコードをまるパクリして、それを Google Map へマッピングしてみた。これで、ちょっとは利便性が向上するんじゃないだろうか。マッピングのライブラリは、

<ul>
<li><a href="http://www.ryokurian.jp/atelier/google/maps_sample1.html">サンプル１ - 「googleマップで複数住所を一括表示」の作り方 - 緑里庵</a></li>
</ul>をもらってきた。ちょっとコードが古いので、TypeScript で書き直したりしてみたい。Web ページのコードはこんな感じ（spotList あたりのコードとか汚いけど）。WebMatrix（ASP.NET Web Pages）はこういう“ペライチ”のページを作るときに便利よね。
```cs
# ~/Default.cshtml

@using System.Xml.Linq
@using Sgml

@{
    var urlString = "http://www.pref.ehime.jp/h12600/wifi/osirase260822.html";

    XDocument xml;
    using (var sgml = new SgmlReader() { Href = urlString, IgnoreDtd = true })
    {
        xml = XDocument.Load(sgml);
    }

    var ns = xml.Root.Name.Namespace;
    var spots = xml.Descendants(ns + "table")
        .Last()
        .Descendants(ns + "tr")
        .Skip(1) // タイトルをスキップ
        .Select(e => e.Elements(ns + "td").ToList())
        .Select(x => new
        {
            Place = x[1].Value,
            Address = x[2].Value,
            ServiceProvider = x[3].Value
        });

    var spotList = string.Join("\r\n", spots.Select(_ => _.Address.Replace("−", "-")).ToArray());
}

&lt;!DOCTYPE html>

&lt;html lang="ja">
    &lt;head>
        &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        &lt;meta charset="utf-8" />
        &lt;title>マイ サイトのタイトル&lt;/title>
        &lt;link href="~/favicon.ico" rel="shortcut icon" type="image/x-icon" />
        &lt;script src="http://maps.google.com/maps/api/js?sensor=false">&lt;/script>
        &lt;script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.0/jquery.min.js">&lt;/script>
        &lt;script src="~/Scripts/sirusiizu.js">
        &lt;/script>
    &lt;/head>
    &lt;body>

        &lt;textarea id="addressList" style="width: 80%; height: 120px;">@spotList&lt;/textarea>

        &lt;div id="map" style="width: 80%; height: 360px;">
        
        &lt;/div>

        &lt;script>     
            sirusiizu.initialize("map");
            sirusiizu.marking(document.getElementById("addressList").value);
        &lt;/script>
    &lt;/body>
&lt;/html>

```{{< figure src="/images/20141216181643.png"  >}}割とたくさんあるんやなー。{{< tweet 544782999317778434 >}}まじ申し訳ないけど、割とやっつけ仕事なので、キレイに仕上げてくれていいのよ？

<ul>
<li><a href="http://ehime-wifi.azurewebsites.net/">http://ehime-wifi.azurewebsites.net/</a></li>
</ul>

