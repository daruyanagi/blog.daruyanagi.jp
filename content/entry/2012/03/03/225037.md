
+++
date = "2012-03-03 22:50:37 +0000 UTC"
draft = false
title = "Flickr の URL を画像タグへ変換する（oEmbed）"
tags = ["C#","ASP.NET"]

+++
>
        eEmbedというのは、あるリソースのURL(例えばFlickrの特定の写真のページのURL)を
サードパーティ上で、写真自体の埋め込みに変換したいときに、
埋め込みに必要なパラメータを取得するためのプロトコルみたいです。

         URLを埋め込みコンテンツに変換するoEmbedの仕様 - Codin’ In The Free World
    
前にやったときは API を使って実装したのだけど、こっちだと API キーや秘密鍵を取得しないで同じことができそう。

    ```
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;

using Codeplex.Data;
using System.Net;

public static class FlickrHelper
{
    private static readonly string Endpoint = 
        @"http://www.flickr.com/services/oembed";
    public static string FORMAT_URL = 
        @"{0}?url={1}&amp;maxwidth={2}&amp;maxheight={3}&amp;format={4}";
    public static string FORMAT_HTML_TAG = @"
&lt;blockquote>
&lt;p>&lt;img src=&#39;{0}&#39; alt=&#39;{1}&#39; />&lt;p>
&lt;p>&lt;small>{1} by &lt;a href=&#39;{3}&#39;>{2}&lt;/a>&lt;/small>&lt;p>
&lt;/blockquote>
";
    public static string FORMAT_ERROR = 
        @"&lt;p class=&#39;error&#39;>{0}&lt;/p>";

    public static string GetHtml(string url,
        string max_width = "500", string max_height = "500")
    {
        try
        {
            return GetHtml(url, 
                int.Parse(max_width), int.Parse(max_height));
        }
        catch (Exception e)
        {
            return string.Format(FORMAT_ERROR, e.Message);
        }
    }

    public static string GetHtml(
        string url, int max_width, int max_height)
    {
        var format = "json";

        var address = string.Format(FORMAT_URL,
            Endpoint, url, max_width, max_height, format);

        using (var client = new WebClient())
        {
            try
            {
                var response = client.DownloadString(address);
                var info = DynamicJson.Parse(response);

                return string.Format(FORMAT_HTML_TAG,
                    info.url, info.title,
                    info.author_name, info.author_url);
            }
            catch (Exception e)
            {
                return string.Format(FORMAT_ERROR, e.Message);
            }
        }
    }
}
```
<br/>
<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120303/20120303222856.png" alt="f:id:daruyanagi:20120303222856p:plain" title="f:id:daruyanagi:20120303222856p:plain" class="hatena-fotolife"/>できた。けど、これだと短縮URL（flic.kr）は使えないみたい。自分で Base58 のデコード処理<a href="#f1" name="fn1" title="短縮URLはPhoto IDをBase58でエンコードしてある">*1</a>なり、URLを展開する処理なりを追加する必要がある。 Base58 のデコード処理では Photo ID しか取得できず、結局 API が必要になるので、今回は汎用の短縮URL展開処理を使った。

    ```
public static Uri ExpandUrl(this Uri input)
{
    var req = (HttpWebRequest)WebRequest.Create(input);
    WebResponse res = req.GetResponse();
    return res.ResponseUri;
}
```
みたいな拡張メソッドを用意して、

    ```
if (url.StartsWith("http://flic.kr/p/"))
{
    url = new Uri(url).ExpandUrl().ToString();
}
```
短縮URLを展開してあげる。
<div class="footnote">
<a href="#fn1" name="f1" class="footnote-number">*1</a><span class="footnote-delimiter">:</span><span class="footnote-text">短縮URLはPhoto IDをBase58でエンコードしてある</span>
</div>

