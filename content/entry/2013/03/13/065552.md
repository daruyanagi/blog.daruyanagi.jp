
+++
date = "2013-03-13 06:55:52 +0000 UTC"
draft = false
title = "WebMatrix 2"
tags = ["WebMatrix","SignalR"]

+++
緑タイツの中の人が Facebook で、昨日の記事（<a href="https://blog.daruyanagi.jp/entry/2013/03/12/093613">WebMatrix 2: SignalR を動かす （ 1.0.1 対応版） - だるろぐ</a>）に_「SignalRのサンプル作るときは、「今何人接続」表示があるともっと便利ですよー」_とコメントを付けてくれました。これは要するに、_「そのやり方をブログに書け」_ということですよね！（違幸い、しばやんが偶然たまたま <a href="http://shiba-yan.hatenablog.jp/entry/20130312/1363090277">ASP.NET SignalR で接続中のクライアントを数えてみる - しばやん雑記</a> という記事を書いてくれましたので、それを<del>コピペ</del>参考にして、昨日のサンプルに追加してみました。

<div class="section">
    ### ~/_AppStart.cshtml
    ```cs
@using System.Web.Routing

@{
    RouteTable.Routes.MapHubs();
}

```
</div>
<div class="section">
    ### ~/App_Code/ChatHub.cshtml
    ```cs
using Microsoft.AspNet.SignalR;

// 追加
using Microsoft.AspNet.SignalR.Hubs;
using System.Collections.Concurrent;
using System.Threading.Tasks;

[HubName("chat")]
public class ChatHub : Hub 
{
    public void Send(string message)
    {        
        Clients.All.addMessage(message);
    }
    
    // 以下、追加
    private static readonly ConcurrentDictionary&lt;string, bool>
        _connections = new ConcurrentDictionary&lt;string, bool>();

    public override Task OnConnected()
    {
        _connections.TryAdd(Context.ConnectionId, true);

        return Clients.All.notify(_connections.Count);
    }

    public override Task OnDisconnected()
    {
        bool value;

        _connections.TryRemove(Context.ConnectionId, out value);

        return Clients.All.notify(_connections.Count);
    }

    public override Task OnReconnected()
    {
        _connections.TryAdd(Context.ConnectionId, true);

        return Clients.All.notify(_connections.Count);
    }
}

```Dictionary で 接続ID を管理する処理が追加されています。ConcurrentDictionary は、

    >
        複数のスレッドから同時にアクセスできるキーと値のペアのスレッド セーフなコレクションを表します。

        http://msdn.microsoft.com/ja-jp/library/vstudio/dd287191.aspx
    
.NET Framework 4 から使えるのかな？しばやんの記事を読むまでは、単純に接続イベントで int Count をインクリメント・デクリメントしようと思っていたのですが、そんなに簡単なお話ではなかったようです。あと、クラス名を ChatHub に変更しました。ファイル名とクラス名は合わせたいかな、と思ったので。これには追加の名前空間（Microsoft.AspNet.SignalR.Hubs）が必要です。 [HubName("chat")] という属性を追加すれば動作に影響はありません。

</div>
<div class="section">
    ### ~/Default.cshtml
    ```html
@{
    
}



&lt;html lang="ja">
    &lt;head>
        &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        &lt;meta charset="utf-8" />

        &lt;title>マイ サイトのタイトル&lt;/title>

        &lt;link href="~/favicon.ico" rel="shortcut icon" type="image/x-icon" />

        &lt;script src="~/Scripts/jquery-1.9.1.min.js">&lt;/script>
        &lt;script src="~/Scripts/jquery.signalR-1.0.1.min.js">&lt;/script>
        &lt;script src="~/signalr/hubs">&lt;/script>
        &lt;script>
            $(function () {
                var chat = $.connection.chat;

                chat.client.addMessage = function (message) {
                    $(&#39;#messages&#39;).append(&#39;<li>&#39;</li> + message + &#39;&#39;);
                };

                // notify() を追加
                chat.client.notify = function (message) {
                    $(&#39;#count&#39;).html(message)
                };

                $.connection.hub.start().done(function () {
                    $("#broadcast").click(function () {
                        chat.server.send($(&#39;#msg&#39;).val());
                        $("#msg").val(""); // 追加
                    });
                });
            });
        &lt;/script>
    &lt;/head>
    &lt;body>
        &lt;div><!-- 追加 -->
            現在、&lt;span id="count">&lt;/span>人が接続しています。
        &lt;/div><!-- ここまで -->
        &lt;div>
            &lt;input type="text" id="msg" />
            &lt;input type="button" id="broadcast" value="broadcast" />

            &lt;ul id="messages">
            &lt;/ul>
        &lt;/div>
    &lt;/body>
&lt;/html>

```ハブが Clients.All.notify(接続数) するので、クライアント側でそれを span#count にセットします。ついでに、ブロードキャストしたときにテキストボックスを空にする処理を加えておきました。

</div>
<div class="section">
    ### 結果
    {{< figure src="/images/20130313064343.png"  >}}できました！

</div>

