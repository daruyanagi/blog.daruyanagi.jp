
+++
date = "2017-06-27 02:17:36 +0000 UTC"
draft = false
title = "空の ASP.NET Core プロジェクトからとりあえず Web サイトのトップページを書いて Azure にデプロイするまで"
tags = ["Microsoft Azure","ASP.NET Core"]

+++
{{< figure src="/images/20170627010541.png"  >}}ウチの Web サイトは Microsoft Azure の Bizspark を使わせてもらっていたのですが、いつのまにかサブスクリプションが切れていて（そういえばいろいろメールがきてた気がしないでもない）、アクセスできなくなってしまいました。あれ、データもサルベージできないのかな……。というわけで、一からサイトを作り直すことにしました。とりあえず、今回の目標は web.archive.org からサルベージしたトップページの復旧です。もう一度 ASP.NET で組みなおしてもいいのですが、いい機会なので、ずっと挑戦してみたかった ASN.NET Core を利用してみることにしましょう（よく知らんけど、今後はこっちが主流になりそうな匂いがするので）。右も左も分からんけど、大丈夫やろうか。

<div class="section">
    ### 前提条件と大まかな流れ
    まず Visual Studio 2017 Community の「ASP.NET と Web 開発」というワークロードがインストールされている環境を用意（これだけで足りんかったらごめんな、正直よくわかってないんや）。空のテンプレートを作成し、トップページの Index.cshtml を表示するところまで頑張ります。

</div>
<div class="section">
    ### 実装
    
<div class="section">
    #### 空のテンプレートを作成
    {{< figure src="/images/20170627011714.png"  >}}まず、「ASP.NET Core Web アプリケーション」のプロジェクトを新規に作成します（名前は Sample にしました）。

<ul>
<li>.NET Core</li>
<li>.NET Framework</li>
</ul>の 2 つのバージョンがありますが、今回は前者（.NET Core）を選択。{{< figure src="/images/20170627022120.png"  >}}.NET Core はクロスプラットフォームなので、Linux サーバーでも運用できるはず。いずれは Docker なんかも試してみたいなー。{{< figure src="/images/20170627012047.png"  >}}プロジェクトを作成するとテンプレート画面が現れるので、「空」を選択。いきなり訳の分からんファイルをブリブリ生成されても泣いてしまうからね、仕方ないね。ちなみに ASP.NET Core のバージョンは 1.1 でした。そろそろ 2.0 なんじゃなかったっけ？　また変わったら嫌だなー。

</div>
<div class="section">
    #### 空のテンプレートを概観
    {{< figure src="/images/20170627012316.png"  >}}プロジェクトが作成されたら、さらっと中身を見てみましょう。ファイル構造はこんな感じです

<ul>
<li>wwwroot フォルダー</li>
<li>Program.cs</li>
<li>Startup.cs</li>
</ul>シンプルでいい感じ。最初に実行される main() 関数は Program.cs に記述されています。
```cs
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Hosting;

namespace Sample
{
    public class Program
    {
        public static void Main(string[] args)
        {
            var host = new WebHostBuilder()
                .UseKestrel()
                .UseContentRoot(Directory.GetCurrentDirectory())
                .UseIISIntegration()
                .UseStartup&lt;Startup>()
                .UseApplicationInsights()
                .Build();

            host.Run();
        }
    }
}

```よくわからんけど、いろんな設定をしてホストを作成し、実行しているみたいですね。素人は触らん方がよさそう。一方の Startup.cs はこんな感じ。
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;

namespace Sample
{
    public class Startup
    {
        // This method gets called by the runtime. Use this method to add services to the container.
        // For more information on how to configure your application, visit https://go.microsoft.com/fwlink/?LinkID=398940
        public void ConfigureServices(IServiceCollection services)
        {
        }

        // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
        public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)
        {
            loggerFactory.AddConsole();

            if (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
            }

            app.Run(async (context) =>
            {
                await context.Response.WriteAsync("Hello World!");
            });
        }
    }
}

```ConfigureServices と Configure という二つのメソッドがあり、Configure で Hello World! を出力する（context.Response.WriteAsync）ようになっているみたい。{{< figure src="/images/20170627012904.png"  >}}実際に［F5］キーで実行してみると、Hello World! が出力されました。つまり、どっかにファイルを置いて読み込み、context.Response.WriteAsync() すれば、とりあえずトップページは出力されそう……だけど、後々のことを考えると流石にそれはめんどくさそうなので、フレームワークの力を借りておこうかな。

</div>
<div class="section">
    #### ASP.NET Core MVC の導入
    できれば使い慣れた ASP.NET Web Pages の ASN.NET Core 版のようなのがあればよかったのだけど、今のところ無いのかな？　よくわかんないので、比較的情報の多かった ASN.NET Core MVC を導入してみます。NuGet パッケージで簡単にインストールできるみたいなので、今回はそれを利用してみましょう。アプリを終了して、ソリューションのコンテキストメニューから［ソリューションの NuGet パッケージを管理］コマンドを選択。{{< figure src="/images/20170627013555.png"  >}}「Microsoft.AspNetCore.MVC」を探してインストールします。{{< figure src="/images/20170627013752.png"  >}}パッケージがクソほどあってビビるけど、インストールは一瞬で終わりました。
```
：
：
&#39;Microsoft.Extensions.WebEncoders 1.1.2&#39; が Sample に正常にインストールされました
NuGet の操作の実行に 2.22 sec かかりました
経過した時間: 00:00:04.0184836
========== 終了 ==========

NuGet パッケージを復元しています...
経過した時間: 00:00:01.3445620
========== 終了 ==========
```最近の NuGet は速いなー……なんかもっと遅いイメージあったんだけど。あとは、Startup.cs で MVC を利用するよう書き換えます。
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;

namespace Sample
{
    public class Startup
    {
        // This method gets called by the runtime. Use this method to add services to the container.
        // For more information on how to configure your application, visit https://go.microsoft.com/fwlink/?LinkID=398940
        public void ConfigureServices(IServiceCollection services)
        {
            // MVC を追加
            services.AddMvc();
        }

        // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
        public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)
        {
            loggerFactory.AddConsole();

            if (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
            }

            // 使わないのでコメントアウト
            // app.Run(async (context) =>
            // {
            //     await context.Response.WriteAsync("Hello World!");
            // });

            // ルーティング を追加
            app.UseMvc(routes =>
            {
                routes.MapRoute(
                name: "default",
                template: "{controller=Home}/{action=Index}/{id?}");
            });
        }
    }
}

```ビルドしてエラーがなければ次に進みます。ルーティングのマップは、

<ul>
<li>/Hoge/Fuga/Piyo</li>
</ul>にアクセスしたら、

<ul>
<li>HogeController の Fuga() メソッドを叩け（引数は Piyo）</li>
</ul>って感じの意味だと思います。デフォルト引数（？）が設定されているので、ルートへのアクセスで

<ul>
<li>HomeController の Index() メソッドを叩け</li>
</ul>になります。Index() メソッドでビューを表示できれば今回の目標は完了やね。――というわけで、次はコントローラーと、それを表示するビューの実装です。

</div>
</div>
<div class="section">
    ### コントローラーとビューを作成
    {{< figure src="/images/20170627015130.png"  >}}以下のような構造でコントローラーとビューを作成します。この辺りは MVC の“お約束”なので覚えるしかない。{{< figure src="/images/20170627021309.png"  >}}<br/>


<ul>
<li>**Controllers フォルダー**
<ul>
<li>**HomeController.cs**</li>
</ul></li>
<li>**Views フォルダー**
<ul>
<li>**Home フォルダー**
<ul>
<li>**Index.cshtml**</li>
</ul></li>
</ul></li>
<li>wwwroot フォルダー</li>
<li>Program.cs</li>
<li>Startup.cs</li>
</ul>ソリューションエクスプローラーのコンテキストメニューには［追加］－［コントローラー］というコマンドがあるのですが、これを使うとなんかエラーが出たので、［新しい項目］コマンドからコントローラーを追加しました。{{< figure src="/images/20170627015202.png"  >}}先程、ルーティングでデフォルトコントローラーの名前を“Home”にしておいたのにはとくに意味はなく、単にこのときの既定の名前が“HomeController.cs”だったからデス。名前はお好みで。
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;

// For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860

namespace Sample.Controllers
{
    public class HomeController : Controller
    {
        // GET: /<controller>/</controller>
        public IActionResult Index()
        {
            return View();
        }
    }
}

```Index() も用意されているので、ここで追加のコーディングは不要。なんでも既定（“お約束”）に合わせておくと色々楽ちん。{{< figure src="/images/20170627015533.png"  >}}ビューもおんなじ感じで。作成するやで。ビューは殺風景なので、適当にサンプルを書いてみました。
```cs
@{ 
    var message = "Hello! World";
}

&lt;html>
    &lt;head>
        &lt;title>@message&lt;/title>
    &lt;/head>
    &lt;body>
        &lt;p>@message&lt;/p>

        &lt;p>@DateTime.Now&lt;/p>
    &lt;/body>
&lt;/html>

```［F5］で実行します。{{< figure src="/images/20170627015831.png"  >}}フーーーッ！　これでだいたい完了！　あとはビューをしこしこ書いていくだけです。

<div class="section">
    #### 性的静的ファイルを利用
    けれど、これだけだと CSS や JavaScript を置いて読み込んだりできなくて不便でした。というわけで、以下の設定を Startup.cs の Configure() メソッドに追加しておきました（もうネームスペースやクラスの部分は省いて大丈夫ですよね！）。
```cs
public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)
{
    loggerFactory.AddConsole();

    if (env.IsDevelopment())
    {
        app.UseDeveloperExceptionPage();
    }

    // 以下の2行を追加
    app.UseDefaultFiles();
    app.UseStaticFiles();

    app.UseMvc(routes =>
    {
        routes.MapRoute(
        name: "default",
        template: "{controller=Home}/{action=Index}/{id?}");
    });
}

```これで wwwroot に静的ファイルがあるかどうかをチェックし、あればそっちを先に読み込んでくれます。ビューを cshtml にする必要がなければ、html にして wwwroot に置いておき、この二行を追加するだけでもよかったね。……まぁ、今後のことも考えると無駄ではないけど。

</div>
<div class="section">
    #### デプロイ
    {{< figure src="/images/20170627020507.png"  >}}プロジェクトのコンテキストメニューから［公開］コマンドを選択。あとはそんなに難しくないと思うで、以下省略。ウチの場合はトラブルなく、デプロイまで完了しました。いずれは GitHub 連携でデプロイ……みたいな感じにしたいですね。終わり！

</div>
</div>

