
+++
date = "2013-03-12 09:36:13 +0000 UTC"
draft = false
title = "WebMatrix 2"
tags = ["SignalR","WebMatrix"]

+++
もうだいぶ昔の話になりますが、ASP.NET SignalR が正式リリースされました。

<ul>
<li><a href="http://shiba-yan.hatenablog.jp/entry/20130303/1362291390">ASP.NET SignalR 1.0.1 が出てました - しばやん雑記</a></li>
</ul>最新版は 1.0.1 ですかね。ASP.NET SignalR は「WebMatrix 2」からも使えますが、ベータのとき（<a href="https://blog.daruyanagi.jp/entry/2012/08/31/031730">SignalR Deep Dive ! に参加してきた＋WebMatrix で SignalR 動かしてみた - だるろぐ</a>）とは少し変わっている部分もあるようなので、もう一度やってみました。とりあえず、<a href="https://github.com/SignalR/SignalR/wiki/QuickStart-Hubs">QuickStart Hubs · SignalR/SignalR Wiki · GitHub</a> を動作させるのが目標。

<div class="section">
    ### NuGet で SignalR を取得
    {{< figure src="/images/20130312085421.png"  >}}公式パッケージソースで「SignalR」を検索すると、三番目ぐらいに出てくるはず。

</div>
<div class="section">
    ### サーバー（ハブ）
    {{< figure src="/images/20130312090003.png"  >}}~/App_Code フォルダに ChatHub.cs を作成し、以下のようなクラスを用意します。
```cs
using Microsoft.AspNet.SignalR;

public class Chat : Hub 
{
    public void Send(string message)
    {
        // Call the addMessage method on all clients            
        Clients.All.addMessage(message);
    }
}

```受け取ったメッセージを接続中のすべてのクライアントへそのまま一斉送信する（クライアントクラスの addMessage() を呼び出す）だけの簡単なクラスです。これがサーバー側のコードになります。名前空間が変わったのかな？

</div>
<div class="section">
    ### ハブのマッピング
    {{< figure src="/images/20130312090455.png"  >}}さきほど記述したハブをルートテーブルにマップして使えるようにします。~/_AppStart.cshtml を作成し、以下のように記述しましょう。
```cs
@using System.Web.Routing

@{
    RouteTable.Routes.MapHubs();
}

```<a href="https://github.com/SignalR/SignalR/wiki/QuickStart-Hubs">QuickStart Hubs · SignalR/SignalR Wiki · GitHub</a> に掲載されているコードと少し違いますが、「WebMatrix 2」の場合はこれで OK です。正直、あんまりよくわかっていないのですけれど、これをコメントアウトすると次のセクションに出てくる &lt;script src="/signalr/hubs">&lt;/script> が 404 になってしまうので、まぁ、そういうのことをしてくれているのではないでしょうか。クライアントコードで $.connection.chat と書いてハブプロキシを呼び出せるようにごにょごにょするとか、そういう準備全般だと思います。

</div>
<div class="section">
    ### クライアント（Javascript + HTML）
    {{< figure src="/images/20130312091147.png"  >}}~/Default.cshtml を以下のように書き換えます。自分の場合は jQuery をアップデートしてあるのですが、古いものでも大丈夫なのかな？　コピペで動かす場合は、スクリプトのバージョンだけ間違わないように気を付けてくださいね。
```cs
@{
    
}

&lt;!DOCTYPE html>

&lt;html lang="ja">
    &lt;head>
        &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        &lt;meta charset="utf-8" />

        &lt;title>マイ サイトのタイトル&lt;/title>

        &lt;link href="~/favicon.ico" rel="shortcut icon" type="image/x-icon" />

        &lt;script src="~/Scripts/jquery-1.9.1.min.js">&lt;/script>
        &lt;script src="~/Scripts/jquery.signalR-1.0.1.min.js">&lt;/script>
        &lt;script src="~/signalr/hubs">&lt;/script>
        &lt;script>
            $(function () {
                // ハブプロキシを作成        
                var chat = $.connection.chat;

                // サーバーが addMessage() を呼んだら……         
                chat.client.addMessage = function (message) {
                    $(&#39;#messages&#39;).append(&#39;<li></li>&#39; + message + &#39;&#39;);
                };

                // 接続開始
                $.connection.hub.start().done(function() {
                    // imput#broadcast がクリックされたら……
                    $("#broadcast").click(function () {
                        // サーバーの Send() を実行する
                        chat.server.send($(&#39;#msg&#39;).val());
                    });
                });
            });
        &lt;/script>
    &lt;/head>
    &lt;body>
        &lt;div>
            &lt;input type="text" id="msg" />
            &lt;input type="button" id="broadcast" value="broadcast" />

            &lt;ul id="messages">
            &lt;/ul>
        &lt;/div>
    &lt;/body>
&lt;/html>

```input#broadcast を押したら、input#msg の内容を引数にサーバーの ChatHub.Send(string） を実行します。 すると、それがすべてのクライアントに送信され、それを受け取ったクライアントは ul#messages にそれを追加する、というわけ。{{< figure src="/images/20130312092011.png"  >}}とりあえずブラウザーをいくつか起動して適当に入力してみてください。ちゃんとブロードキャストされているかな？

</div>

