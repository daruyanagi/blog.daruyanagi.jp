
+++
date = "2012-09-27 21:31:59 +0000 UTC"
draft = false
title = "SignalR + WebMatrix でサーバーフォルダの監視を行ってみる"
tags = ["WebMatrix","SignalR"]

+++
SignalR の面白い使い方ってないかなーと思ってたのだけど、たとえば誰かがファイルをアップロードした時、同時接続している人たちにそれを知らせられたら面白くないかな？　と思いついた。さっそくやってみる。自分の作ったサンプルコード（<a href="https://blog.daruyanagi.jp/entry/2012/08/31/031730">SignalR Deep Dive ! に参加してきた＋WebMatrix で SignalR 動かしてみた - だるろぐ</a>）をコピペして、必要な処理を足して、要らない部分を消して……以下のようなコードを書いてみた。
```cs
# ~/App_Code/SampleHub.cs

using SignalR.Hubs;
using System.IO;

[HubName("sample")]
public class SampleHub : Hub
{
    public SampleHub()
    {
        var watcher = new FileSystemWatcher();
        
        watcher.Path =  System.Web.HttpContext.Current
            .Server.MapPath(@"~/_Documents");
        watcher.Filter = "*.txt";
        watcher.NotifyFilter = NotifyFilters.FileName
                             | NotifyFilters.DirectoryName
                             | NotifyFilters.LastWrite;
        watcher.IncludeSubdirectories = false;
        watcher.Changed +=
            (o, s) => { Clients.Echo("なんかかわったで"); };
        watcher.Created +=
            (o, s) => { Clients.Echo("あたらしいのできたで"); };
        watcher.Deleted +=
            (o, s) => { Clients.Echo("きえてもうた……"); };
        watcher.Renamed +=
            (o, s) => { Clients.Echo("なまえかわったわ"); };
        watcher.EnableRaisingEvents = true;
    }
}

```めんどくさいので <a href="http://dobon.net/vb/dotnet/file/filesystemwatcher.html">フォルダ、ファイルの変更を監視する - .NET Tips (VB.NET,C#...)</a> をほとんど丸コピしている。原理的には、これで _Documents フォルダ内のテキストファイルが更新されると、クライアント側の Echo() が呼ばれるはず。ちなみにクライアント側はこんな感じ。
```html
# ~/Default.cshtml



&lt;html lang="ja">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>マイ サイトのタイトル&lt;/title>
        &lt;script type="text/javascript"
                src="Scripts/jquery-1.6.4.js">&lt;/script>
        &lt;script type="text/javascript"
                src="Scripts/jquery.signalR-0.5.3.js">&lt;/script>
        &lt;script>
            var connection = $.hubConnection();
            var sample = connection.createProxy("sample");
            connection.start();
            sample.on("Echo", function (value) {
                $("#value").html(value);
            });
        &lt;/script>
    &lt;/head>
    &lt;body>
        &lt;p id="value">&lt;/p>
    &lt;/body>
&lt;/html>

```
<div class="section">
    ### 反応がない、ただの屍のようだ。
    でも、これだと動かない。なぜだ！元のサンプルコードをいじりながらいろいろ試してみたところ、クライアントから一度なんらかのアクションがあれば、期待通りの動作をするみたい。ということで、コードを少し足した。
```cs
# ~/App_Code/SampleHub.cs

using SignalR.Hubs;
using System.IO;

[HubName("sample")]
public class SampleHub : Hub
{
    public SampleHub()
    {
        （省略）
    }

    public void Initialize()
    {
        // 追加：コネクションを叩き起こすための何もしないメソッド
    }
}

```で、クライアント側から SampleHub.Initialize() を叩く。
```html
# ~/Default.cshtml



&lt;html lang="ja">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>マイ サイトのタイトル&lt;/title>
        &lt;script type="text/javascript"
                src="Scripts/jquery-1.6.4.js">&lt;/script>
        &lt;script type="text/javascript"
                src="Scripts/jquery.signalR-0.5.3.js">&lt;/script>
        &lt;script>
            var connection = $.hubConnection();
            var sample = connection.createProxy("sample");
            connection.start();
            sample.on("Echo", function (value) {
                $("#value").html(value);
            });
            sample.invoke(&#39;initialize&#39;); // &lt;-- 追加！
        &lt;/script>
    &lt;/head>
    &lt;body>
        &lt;p id="value">&lt;/p>
    &lt;/body>
&lt;/html>

```
</div>
<div class="section">
    ### 無理やり叩いたらゲロ吐きやがった
    そうしたらエラーで止まった。{{< figure src="/images/20120927212447.png"  >}}connection.start() が終わってないのに SampleHub.Initialize() を叩くんじゃねえ、バカ。そういいたいらしい。connection.start().done() を使えというので、素直に従おう。
```html
# ~/Default.cshtml



&lt;html lang="ja">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>マイ サイトのタイトル&lt;/title>
        &lt;script type="text/javascript"
                src="Scripts/jquery-1.6.4.js">&lt;/script>
        &lt;script type="text/javascript"
                src="Scripts/jquery.signalR-0.5.3.js">&lt;/script>
        &lt;script>
            var connection = $.hubConnection();
            var sample = connection.createProxy("sample");
            connection.start().done(function () { // &lt;-- done()!
                sample.invoke(&#39;initialize&#39;);
            });
            sample.on("Echo", function (value) {
                $("#value").html(value);
            });
        &lt;/script>
    &lt;/head>
    &lt;body>
        &lt;p id="value">&lt;/p>
    &lt;/body>
&lt;/html>

```{{< figure src="/images/20120927212701.png"  >}}ぉー！ ちゃんと動いたぞ。けれど、あんまりスマートじゃないな？　まぁ、いいか。

</div>

