
+++
date = "2013-08-10 15:52:43 +0000 UTC"
draft = false
title = "WebMatrix 3 で Wiki クローンを作る vol.1"
tags = ["WebMatrix 3 で Wiki クローンを作る","WebMatrix","ASP.net Web Pages"]

+++
前回（<a href="https://blog.daruyanagi.jp/entry/2013/07/17/054740">WebMatrix 3 で Wiki クローンを作る vol.0 - だるろぐ</a>）からすでに1ヶ月たちましたが、だいたいこんなペースで、気が向いたときにやっていくと思います。すまんやで！さて、今回はデータの読み書きです。Wiki と言えば、データはテキストとして保存するるタイプが多いんですかね？　まぁ、それでもいいんですけど、WebMatrix では **SQL Server Compact Edition**（SQL CE と略されることが多いです）が簡単に扱えるので、それを利用したいと思います。**SQL CE** というのは Microsoft SQL Server 兄弟の末弟で、SQLite みたいにポータブルに扱えるタイプのデータベースです。ちなみに、WebMatrix はそのお兄さん（SQL Server）や、お兄さんのライバル（MySQL）なんかともなかよくできるのですけれど、ああいうのはインストールとかセッティングとかメンテナンスとか面倒ですよね。その点、SQL CE はデータベースファイルをひとつポンと作るだけなので楽ちんです。ちなみに、タダ。

<div class="section">
    ### データベースの作成
    

{{< figure src="/images/20130810152905.png"  >}}

ebMatrix でデータを扱うには、［データベース］というワークスペースを選択します。

{{< figure src="/images/20130810152957.png"  >}}

は、さっそくデータベースを作りましょう。データベースのファイル名はなんでもいいです。今回はプロジェクト名そのままの“Green Tights.sdf”にしました。続いてテーブルの作成。

{{< figure src="/images/20130810153138.png"  >}}

回はこんなかんじにしてみました。ついでにテーブルの定義も作っておきましょう。テーブルの名前は“Post”で、投稿を管理するテーブルです。

<ul>
<li>PostId：bigint（でっかい整数）型。“主キーかどうか”“ID かどうか”の両方を“はい”にしました。テーブルに行が挿入されると自動でインクリメントされるはずです。</li>
<li>Title：最大60文字の nvarchar（文字列）型。文字数は適当……。“Null（からっぽ）を許可”を“いいえ”にしておきます。</li>
<li>RawText：ntext 型。あらかじめ文字列の数を決めなくてよいテキスト型。本文をぶちこんでおくには最適かな？</li>
<li>CreatedAt：datetime（日時）型。その名の通り作成日時です。</li>
<li>UpdatedAt：datetime（日時）型。今回は使いませんが、のちのち更新日を記録しておきたくなると思うので。</li>
</ul>これを“Post”という名前で作っておきます。

</div>
<div class="section">
    ### データの入力画面の作成
    

{{< figure src="/images/20130810153956.png"  >}}

ファイル］ワークスペースへ移行、とりあえず NewPost.cshtml という名前でデータの入力画面ページをルートフォルダ―に作成します。この画面には、<a href="http://***/NewPost">http://***/NewPost</a> でアクセスできます。

{{< figure src="/images/20130810154059.png"  >}}

ードの方はこんな感じ。ごくごく簡単で、エラー処理っぽいことはしていません。
```cs
@{
    if (IsPost) // POST 要求だけを受け付けましょう
    {
        // Request["name"] で送られてきた名前を取得。
        // POST データなら Request.Form["name"] の方がフォーマルな書き方かな
        var title = Request["title"];
        var raw_text = Request["raw-text"];
        var now = DateTime.Now;

        // データベースを開く。拡張子はいらない
        using (var db = Database.Open("Green Tights"))
        {
            const string query = @"
                INSERT INTO Post(Title, CreatedAt, UpdatedAt, RawText)
                VALUES(@0, @1, @2, @3)
                ";
            db.Query(query, title, now, now, raw_text);
        }
    }
}

&lt;!DOCTYPE html>

&lt;html lang="en">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>&lt;/title>
    &lt;/head>
    &lt;body>
        &lt;form method="post"> &lt;!-- Submit すると自分を POST で呼ぶ -->
            &lt;p>&lt;input type="text" id="title" name="title" />&lt;/p>
            &lt;p>&lt;textarea id="raw-text" name="raw-text">&lt;/textarea>&lt;/p>
            &lt;p>&lt;input type="submit" />&lt;/p>
        &lt;/form>
    &lt;/body>
&lt;/html>

```試しに実行し、［データ］ワークペースでデータを確認してみましょう。表示モードを［定義］から［データ］に切り替えてね！

{{< figure src="/images/20130810154452.png"  >}}

にか……入ってますね？　成功！　次回はこれを取り出して表示して見ることにしましょう。おつかれさまです。<a href="https://blog.daruyanagi.jp/category/WebMatrix%203%20%E3%81%A7%20Wiki%20%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%B3%E3%82%92%E4%BD%9C%E3%82%8B">WebMatrix 3 で Wiki クローンを作る</a>

</div>

