
+++
date = "2012-08-23 00:05:47 +0000 UTC"
draft = false
title = "なぜ var d = new Dictionary&lt;string, string&gt; { { &quot;a&quot;, &quot;b&quot; }, { &quot;c&quot;, &quot;d&quot; } } と書けるのか ―― コレクション初期化子"
tags = ["C#"]

+++
>
        Dictionary ってその場で初期化できるんだね。
```cs
private Dictionary<string, string=""> AllowedFileType =
    new Dictionary<string, string="">()
{
    { "image/jpeg", "jpg" },
    { "image/png" , "png" },
    { "image/gif" , "gif" },
};

```こっちのほうがいいや。

        これまでのサンプルを NuGet パッケージにしてみました - だるろぐ
    </string,></string,>
簡単に書けるのはとっても素晴らしいのだけれど、イマイチこうやって書ける理由がわからなかったので調べてみました。

<div class="section">
    ### C# 3.0 のコレクション初期化子*1
    とりあえず、基本となるコレクション初期化子（配列初期化子）の復習から。

    >
        List は、次のように作成して初期化することができます。
```cs
var contacts = new List<contact> {
   new Contact {
      Name = "Chris Smith",
      PhoneNumbers = { "206-555-0101", "425-882-8080" }
   },
   new Contact {
      Name = "Bob Harris",
      PhoneNumbers = { "650-555-0199" }
   }
};

```これは、以下と同じ効果を持ちます。
```cs
var contacts = new List<contact>();
var __c1 = new Contact();
__c1.Name = "Chris Smith";
__c1.PhoneNumbers.Add("206-555-0101");
__c1.PhoneNumbers.Add("425-882-8080");
contacts.Add(__c1);
var __c2 = new Contact();
__c2.Name = "Bob Harris";
__c2.PhoneNumbers.Add("650-555-0199");
contacts.Add(__c2);

```__c1 と __c2 は、このような方法を使用しなければ隠蔽されアクセスできないテンポラリ変数です。

        Overview of C# 3.0 | Microsoft Docs
    </contact></contact>
つまり、
```cs
var x = List&lt;string>() { "a", "b" };

```は、
```cs
var x = List&lt;string>();
x.Add("a");
x.Add("b");

```とほぼ同じ。ただし、配列初期化子を利用して初期化できるクラスは、 **IEnumerable が実装されている**こと、メンバーとして **Add() が実装されていること**の二つが条件となります。逆に言えば、それさえ満たしていれば内容は問われません（後述）。

</div>
<div class="section">
    ### 足りない条件
    さて、 List の場合はだいたいわかりました。けれど、 Dictionary の場合はそれではまだ説明が足りないと思います。

>@aetos382 @Grabacr07 そうなんですよね。たとえば IEnumerable 実装してて、Add(arg1, arg2) ってシグネチャがあってればOK  とか、そういうルールあるのかなって— だるやなぎ に天使が舞い降りた！ (@daruyanagi) 2012年8月22日<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

以下のコードで言えば、なぜ { "a", "b" } なんて書けるのか、ちょっとわかりません。
```cs
var d = new Dictionary&lt;string, string>
{ 
    { "a", "b" }, // &lt;-- この {} って何さ！
    { "c", "d" }
} 

```すると、こんな助言をいただくなど。

>@okazuki なるほどー パラメーターはいくつでもいいのか— だるやなぎ に天使が舞い降りた！ (@daruyanagi) 2012年8月22日<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

そういうわけで少し試してみました。

{{< figure src="/images/20120822235621.png"  >}}

br/>

```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace ConsoleApplication1
{
    using System.Collections;
    using System.Diagnostics;

    class SampleClass : IEnumerable&lt;string>
    {
        public IEnumerator&lt;string> GetEnumerator()
        { throw new NotImplementedException(); }

        IEnumerator GetEnumerator()
        { throw new NotImplementedException(); }

        public void Add(string arg1, string arg2)
        { Debug.WriteLine("{0}, {1}", arg1, arg2); }
    }

    class Program
    {
        static void Main(string[] args)
        {
            var a = new List&lt;string>() { "a", "b" };
            a.ForEach((_) => Debug.WriteLine(_));

            var b = new List&lt;string>() { { "c" }, { "d" } };
            b.ForEach((_) => Debug.WriteLine(_));

            // var c = { 1 };

            var d = new SampleClass() {
                { "o", "p" }, { "q", "r" }
            };

            Console.WriteLine("何かキーを押してください。");
            Console.ReadLine();
        }
    }
}

```

{{< figure src="/images/20120822235856.png"  >}}

しずつカラクリが見えてきました。

<div class="section">
    #### { x } で Add(x) が呼ばれる
    ```cs
var b = new List&lt;string>() { { "c" }, { "d" } };

```全然知らなかったのだけれど、こんな書き方もいけるのですね。つまり、
```cs
var a = new List&lt;string>() { "a", "b" };

```において、 "a" は { "a" } の省略記法と見なせそう。
```cs
var c = { 1 };

```さすがにこれはダメですね。 { } ではなく ( ) ならばそのままコンパイルできるのですが。

{{< figure src="/images/20120822235244.png"  >}}

メンナサイ。

</div>
<div class="section">
    #### 中身はどうでもいい。とりあえず IEnumerable を実装して Add() 書いとけ
    SampleClass は IEnumerable<string> の出来損ないです。しかも、要素に一つの値しか取れないくせに Add() の引数は二つもある！</string>
```cs
class SampleClass : IEnumerable&lt;string>
{
    public IEnumerator&lt;string> GetEnumerator()
    { throw new NotImplementedException(); }

    IEnumerator GetEnumerator()
    { throw new NotImplementedException(); }

    public void Add(string arg1, string arg2)
    { Debug.WriteLine("{0}, {1}", arg1, arg2); }
}

```それでも、これが動くんですね。
```cs
var d = new SampleClass() {
    { "o", "p" }, { "q", "r" }
};

```ただ単に Add() してるのを簡易記法で隠蔽しているだけだとわかれば、何も難しくありません。
```cs
var d = new SampleClass();
d.Add("o", "p"); // &lt;-- 実際にはコレクションに値を追加していない！
d.Add("q", "r");

```こういうのを糖衣構文（シンタックスシュガー）というのですね。ちなみに、引数の数を間違えると静的にチェックされ、さすがにコンパイルエラーになります。

{{< figure src="/images/20120822235203.png"  >}}

br/>

```cs
var d = new SampleClass() {
    { "o", "p" }, { "q", "r", "s" } // &lt;-- アウチ！
};

```ちょっと興味深かったのでまとめてみました。

</div>
</div><div class="footnote">
<a href="#fn-a4390923" name="f-a4390923" class="footnote-number">*1</a><span class="footnote-delimiter">:</span><span class="footnote-text">.NET Framework 3.5</span>
</div>

