
+++
date = "2017-09-19 19:58:37 +0000 UTC"
draft = false
title = "Omawari 1.1：Web 更新を巡回するヤツ。静的スクレイピングとか追加した"
tags = ["告知","WPF","Omawari"]

+++
{{< figure src="/images/20170919194055.png"  >}}だいぶサマになってきた気がする。あっちこっちにぬるぽエラーがあって、潰すのに難儀した。Swift とか羨ましいかもね？（よく知らんけど）

<ul>
<li>デバッグビルドとリリースビルドの共存（開発の都合）</li>
<li>通知アイコンの改善</li>
<li>（タイマーの通算稼働時間のカウント）</li>
<li>Updated を Pending に変えるまでの時間をグローバル設定から読み込むように</li>
<li>ステータス色分けの改善</li>
<li>内部で保持している UTC を Local Time にちゃんと直して表示</li>
<li>コードの整理</li>
<li>**静的スクレイピング機能の追加**</li>
<li>**プレビューの文字化けを修正**</li>
<li>**更新ログウィンドウの追加**</li>
<li>スクレイピングルールのダブルクリックでログを表示（編集画面の方がよかったか？）</li>
</ul>
<div class="github-card" data-user="daruyanagi/Omawari/releases/tag" data-repo="v1.1" data-width="400" data-height="" data-theme="default"></div>
<script src="https://cdn.jsdelivr.net/github-cards/latest/widget.js"></script>
<br/>


<div class="section">
    ### 静的スクレイピング機能の追加
    {{< figure src="/images/20170919194450.png"  >}}PhantomJS は遅いので、AngleSharp を使った静的スクレイピングをデフォルトにしました。下手したら3分ぐらいかかっていた処理が、たった数秒に。[C#でモダンにスクレイピングするならAngleSharp - Qiita](http://qiita.com/matarillo/items/a92e7efbfd2fdec62595)AngleSharp は HtmlAgilityPack より断然使いやすいので、今後はこっちをメインに使おうと思います。

</div>
<div class="section">
    ### プレビューの文字化けを修正
    WebBrowser.NavigateToString() を使うとたまに文字化けする問題。HTML で UTF-8 エンコードを指定すればよかったのですが、Diff の方だけやって、プレビューの方には適用されてなかった（爆死
```cs
public class WebBrowserExtension
{
    public static readonly DependencyProperty HtmlProperty = DependencyProperty.RegisterAttached(
        "Html", typeof(string), typeof(WebBrowserExtension), 
        new UIPropertyMetadata(null, HtmlPropertyChanged));

    public static string GetHtml(DependencyObject obj)
    {
        return (string)obj.GetValue(HtmlProperty);
    }

    public static void SetHtml(DependencyObject obj, string value)
    {
        obj.SetValue(HtmlProperty, value);
    }

    public static void HtmlPropertyChanged(DependencyObject o, DependencyPropertyChangedEventArgs e)
    {
        WebBrowser browser = o as WebBrowser;
        if (browser == null) return;
        string html = e.NewValue as string;
        if (html == null) return;
        html = $@"


    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <style></style>
        ins.diffins {{ background-color: #cfc; text-decoration: none; }} 
        del.diffdel {{ color: #999; background-color:#FEC8C8; }}
    


    {html}

";
        browser.NavigateToString(html);
    }
}

```バインディング拡張の方でやるように処理を統一。
```html
&lt;WebBrowser u:WebBrowserExtension.Html="{Binding ViewModel.SelectedResult.Text}" />

```
</div>
<div class="section">
    ### 更新ログウィンドウの追加
    更新を検知したら ObservableCollection にログを追加してウィンドウに表示……っていうのをやってたのだけど、NotSupportedException が出て死んだ。異なるスレッドから書き込んだらダメみたい。結局こっちの解決 AsyncObservableCollection を拝借した。[[WPF] Binding to an asynchronous collection](https://www.thomaslevesque.com/2009/04/17/wpf-binding-to-an-asynchronous-collection/)要するに、コンストラクターでディスパッチャーを保存しておいて、コレクション操作でエラーが出たら保存しておいたディスパッチャーにお願いする感じみたい。便利だなー（小並感

</div>
<div class="section">
    ### 今後の予定
    
<ul>
<li>Diff 周りが混乱していて、何と何を比較しているのかわかんないから UI を見直す</li>
<li>よくわかんなくなってきたので、コードの整理する</li>
<li>スタートアップ登録・解除機能</li>
<li>5,000円ぐらいでアイコン作ってもらおうかな？</li>
<li>Desktop Bridge に挑戦するときがきた！！</li>
</ul>{{< figure src="/images/20170919195536.png"  >}}Desktop Bridge を利用した WPF → UWP の移植は理想的にはこうなるらしいけど、やってるアプリ見たことないので、ちょっと挑戦してみようと思う。cmd とのやり取りは排除できないけど、それ以外の要素は UWP にできんことはない気がする。まぁ、早くても来年やね。

</div>

