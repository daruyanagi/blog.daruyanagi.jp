
+++
date = "2012-08-19 13:06:06 +0000 UTC"
draft = false
title = "WebMatrix でファイルのアップロード"
tags = ["ASP.net","WebMatrix"]

+++
<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120819/20120819110408.png" alt="f:id:daruyanagi:20120819110408p:plain" title="f:id:daruyanagi:20120819110408p:plain" class="hatena-fotolife"/>今日は「WebMatrix 2」でファイルのアップロードを試してみた。なお、このサンプルは「Empty Sites」テンプレートを元に作成している。

<div class="section">
    ### Delault.cshtml
    ```html


&lt;html lang="ja">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>マイ サイトのタイトル&lt;/title>
    &lt;/head>
    &lt;body>
        &lt;form action="~/Upload" method="post"
              enctype="multipart/form-data">
            &lt;input type="file" name="upload" />&lt;br />
            &lt;input type="submit" name="submit" />
        &lt;/form>
    &lt;/body>
&lt;/html>

```拡張子を html にすれば、ただの HTML ドキュメントだね！　ファイルのアップロードを行うので、 multipart/form-data をつけるのを忘れないように。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120819/20120819110559.png" alt="f:id:daruyanagi:20120819110559p:plain" title="f:id:daruyanagi:20120819110559p:plain" class="hatena-fotolife"/>

</div>
<div class="section">
    ### Upload.cshtml
    アップロード処理を行う cshtml はこんな感じにしてみた。ほんとは path が存在しなければ例外、 file のサイズが 0 ならば例外、 file が image/*** でなければ例外、といったチェックを入れるのだけれど、ソースが長くなるので割愛している。あと、最初から複数ファイルのアップデートに対応できるように記述している。
```cs
@using System.IO

@functions {
    enum Result { Success, Error };
}

@{
    var result = Result.Error;
    var message = "You can use only POST method.";
    var link = string.Empty;

    if (IsPost)
    {
        foreach (var key in Request.Files.AllKeys)
        {
            var file = Request.Files[key];

            try
            {
                const string OUTPUT = "~/Files/";
                var path = Server.MapPath(OUTPUT);

                var src = Path.GetFileName(file.FileName);
                var dst = string.Format(
                    "{0:yyyyMMdd-HHmmssfff}{1}",
                    DateTime.Now, Path.GetExtension(src).ToLower()
                );

                file.SaveAs(Path.Combine(path, dst));

                result = Result.Success;
                message = string.Format(
                    "{0} is uploaded as {1}.", 
                    src, dst
                );
                link = VirtualPathUtility.ToAbsolute(OUTPUT + dst);
            }
            catch (Exception e)
            {
                result = Result.Error;
                message = e.Message;
            }
        }
    }
}

&lt;h1>@result&lt;/h1>
&lt;p>@message&lt;/p>
if (!string.IsNullOrEmpty(link))
{
    &lt;p>&lt;img src="@link" />&lt;/p>
}
&lt;p>&amp;raquo; Back to &lt;a href="~/">home&lt;/a>&lt;/p>

```基本的には、 Request.Files でファイルを取得し、 SaveAs() で保存するだけ。そのほかはファイル名の決定だのエラー処理だのといったことをしているに過ぎない。Default.cshtml から画像ファイルを POST すると、<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120819/20120819111843.png" alt="f:id:daruyanagi:20120819111843p:plain" title="f:id:daruyanagi:20120819111843p:plain" class="hatena-fotolife"/>エラーが出たらこんな感じで……<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120819/20120819111723.png" alt="f:id:daruyanagi:20120819111723p:plain" title="f:id:daruyanagi:20120819111723p:plain" class="hatena-fotolife"/>成功したらこんな感じになる。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120819/20120819112043.png" alt="f:id:daruyanagi:20120819112043p:plain" title="f:id:daruyanagi:20120819112043p:plain" class="hatena-fotolife"/>"~/Files/"フォルダが夢のようになっておるな！

</div>
<div class="section">
    ### ステップアップ
    
<div class="section">
    #### ヘルパーで楽をしよ……ぅ？
    <img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120819/20120819114311.png" alt="f:id:daruyanagi:20120819114311p:plain" title="f:id:daruyanagi:20120819114311p:plain" class="hatena-fotolife"/>ASP.NET Web Helpers Library という NuGet をインストールすると、複数ファイルのアップロードに対応した Form タグを簡単に生成できる。
```cs
@FileUpload.GetHtml()

```でも、個人的にはあんまり好きじゃなかったので今回は使わなかった。
```cs
&lt;!DOCTYPE html>

@{
    if (IsPost)
    {
        foreach (var key in Request.Files.AllKeys)
        {
            var file = Request.Files[key];

            try
            {
                file.SaveAs(
                   System.IO.Path.Combine(
                       Server.MapPath("~/Files/"),
                       file.FileName)
                );
            }
            catch (Exception e)
            {

            }
        }
    }
}

&lt;html lang="ja">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>マイ サイトのタイトル&lt;/title>
    &lt;/head>
    &lt;body>
        @FileUpload.GetHtml()
    &lt;/body>
&lt;/html>

```<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120819/20120819115634.png" alt="f:id:daruyanagi:20120819115634p:plain" title="f:id:daruyanagi:20120819115634p:plain" class="hatena-fotolife"/>なんか動的に生成されるノードの名前がカブってるし<a href="#f1" name="fn1" title="JavaScriptの不具合かなぁ">*1</a>、あんまりよくわかんなかった。

</div>
</div>
<div class="section">
    ### ビューでつかう変数をまとめる
    Upload.cshtml のソースコードがなんだか冗長なのは、HTML の出力に使う result、message、link という3つの変数を処理するためだけど、こいつらって**匿名クラス**でまとめてもいいよね。
```cs
@using System.IO

@functions { enum Result { Success, Error }; }

@{
    const string OUTPUT = "~/Files/";
    dynamic model = null;

    if (IsPost)
    {
        foreach (var key in Request.Files.AllKeys)
        {
            var file = Request.Files[key];

            try
            {
                var path = Server.MapPath(OUTPUT);

                var src = Path.GetFileName(file.FileName);
                var dst = string.Format(
                    "{0:yyyyMMdd-HHmmssfff}{1}",
                    DateTime.Now, Path.GetExtension(src).ToLower()
                );

                file.SaveAs(Path.Combine(path, dst));

                model = new {
                    Result = Result.Success,
                    Message = string
                        .Format("{0}&#39;s uploaded as {1}", src, dst),
                    Link = VirtualPathUtility
                        .ToAbsolute(OUTPUT + dst),
                };
            }
            catch (Exception e)
            {
                model = new {
                    Result = Result.Error,
                    Message = e.Message,
                    Link = string.Empty,
                };
            }
        }
    }
    else
    {
        model = new {
            Result = Result.Error,
            Message = "You can use only POST method",
            Link = string.Empty,
        };
    }
}

&lt;h1>@model.Result&lt;/h1>
&lt;p>@model.Message&lt;/p>
@if (!string.IsNullOrEmpty(model.Link))
{
    &lt;p>&lt;img src="@model.Link" />&lt;/p>
}
&lt;p>&amp;raquo; Back to &lt;a href="~/">home&lt;/a>&lt;/p>

```記述量はかえって多くなったけど、「何かの処理 → 結果（モデル）の生成」という流れが明確になった気がする。この @model っていうのが MVVM の ViewModel じゃない ViewModel という理解でいいんでしょうか。

</div>
<div class="section">
    ### Ajax には Json で応える
    ViewModel を返すことの利点は、可読性だけじゃない。たとえばこんなこともできる。
```cs
@if (IsAjax)
{
    // Response.ContentType = "application/json";
    Response.Write(Json.Encode(model));
}
else
{
    &lt;h1>@model.Result&lt;/h1>
    &lt;p>@model.Message&lt;/p>
    if (!string.IsNullOrEmpty(model.Link))
    {
        &lt;p>&lt;img src="@model.Link" />&lt;/p>
    }
    &lt;p>&amp;raquo; Back to &lt;a href="~/">home&lt;/a>&lt;/p>
}

```<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120819/20120819125626.png" alt="f:id:daruyanagi:20120819125626p:plain" title="f:id:daruyanagi:20120819125626p:plain" class="hatena-fotolife"/>Ajax リクエストに Json で応えるなんてことも簡単にできる！

</div>
<div class="section">
    ### 拡張メソッドのお時間です
    あとさ、これダサいよね。
```cs
foreach (var key in Request.Files.AllKeys)
{
    var file = Request.Files[key];
    ：
    ：

```拡張メソッドを書いて、シンプルにしましょう。
```cs
foreach (var file in Request.Files.ToEnumerable())
{
    ：
    ：

```~/App_Code/HttpFileCollectionBaseExtension.cs を作成してこのように書いてみました。
```cs
using System.Collections.Generic;
using System.Web;

public static class HttpFileCollectionBaseExtension
{
    public static IEnumerable&lt;HttpPostedFileBase> ToEnumerable(
        this HttpFileCollectionBase target)
    {
        foreach (var key in target.AllKeys)
        {
            yield return target[key];
        }
    } 
}

```
</div><div class="footnote">
<a href="#fn1" name="f1" class="footnote-number">*1</a><span class="footnote-delimiter">:</span><span class="footnote-text">JavaScriptの不具合かなぁ</span>
</div>

