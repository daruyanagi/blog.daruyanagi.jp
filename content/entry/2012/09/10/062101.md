
+++
date = "2012-09-10 06:21:01 +0000 UTC"
draft = false
title = "CSS / Javascript の Bunlde と Minify を WebMatrix で利用する"
tags = ["ASP.net Web Pages","WebMatrix"]

+++
<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120910/20120910054553.png" alt="f:id:daruyanagi:20120910054553p:plain" title="f:id:daruyanagi:20120910054553p:plain" class="hatena-fotolife"/>ほんとは OAuth を早く試してみたいのだけれど……<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120910/20120910054633.png" alt="f:id:daruyanagi:20120910054633p:plain" title="f:id:daruyanagi:20120910054633p:plain" class="hatena-fotolife"/>残念ながらこの通りなので。NuGet Gallery にいくとこのバージョンは存在するのだけど、何がおかしいのだろうか。とりあえず報告しておいた。

<div class="section">
    ### Bunlde ＋ Minify ＝ Optimization
    さてはて。というわけで、最後にやってみたかった CSS / Javascript の Bunlde とMinify を試してみる。 Minify はコードの可読性のためにもうけられたコメントや改行なんかを取っ払ってファイルサイズを小さくすること。 Bundle はヘルパーやパーシャルビューからメインテンプレートにリソースを登録可能にする CSS / Javascript の管理機能だと思えばいいと思う。ちいさなリソースをまとめて（Bunlde）ドバッと送信しちゃえば、多少パフォーマンスも上がるしねぇ。あと、 jQuery なんかはファイル名にバージョンナンバーが含まれていて、アップデートするたびに手動でリンクも書き換えなくちゃならないのだけど、そういう管理も少し楽になる。
```
bundles.Add(
    new ScriptBundle("~/bundles/jquery", jqueryCdnPath)
        .Include("~/Scripts/jquery-{version}.js"));
```
</div>
<div class="section">
    ### 公式の Optimization ライブラリ
    とはいえ、最後にしたのにはわけがあって……<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120910/20120910055103.png" alt="f:id:daruyanagi:20120910055103p:plain" title="f:id:daruyanagi:20120910055103p:plain" class="hatena-fotolife"/>名前がコロコロ変わっているうえ、まだ v1.0 に到達していないというありさま（<a href="http://nuget.org/packages/microsoft.web.optimization">http://nuget.org/packages/microsoft.web.optimization</a>）。WebMatrix からも一応（一番古いのを）使うことはできるのだけど……もう少し様子見が必要かな。今回はそのまま突っ切っちゃうけど、将来的にはこんな感じにできるんだよっていう参考程度に。 MVC 4 だったらもう使えるのかなぁ。

</div>
<div class="section">
    ### Microsoft.Web.Optimization
    <img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120910/20120910055942.png" alt="f:id:daruyanagi:20120910055942p:plain" title="f:id:daruyanagi:20120910055942p:plain" class="hatena-fotolife"/>まず、Microsoft.Web.Optimization をインストール。
```
# ＿AppStart.cshtml

@using Microsoft.Web.Optimization

@{
    var csses = new Bundle("~/css", typeof(CssMinify)); // 仮想パス
    csses.AddDirectory("~/Content/", "*.css", true); // ファイル登録
    BundleTable.Bundles.Add(csses); // マネージャーに登録
    
    var scripts = new Bundle("~/js", typeof(JsMinify));
    scripts.AddDirectory("~/Scripts/", "*.js", true);
    BundleTable.Bundles.Add(scripts);
}

```で、 Scripts フォルダーや Content フォルダーを Bundle に登録。
```


@using Microsoft.Web.Optimization

&lt;html lang="ja">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>マイ サイトのタイトル&lt;/title>

        &lt;link href="~/favicon.ico" rel="shortcut icon"
              type="image/x-icon" />

        // 仮想パス "~/css" として登録したバンドルを解決
        &lt;link rel="stylesheet" type="text/css"
         href="@BundleTable.Bundles.ResolveBundleUrl("~/css")" />

        &lt;script src="@BundleTable.Bundles.ResolveBundleUrl("~/js")">
        &lt;/script>
    &lt;/head>
    &lt;body>
        &lt;p>これはテストです。&lt;/p>
    &lt;/body>
&lt;/html>

```で、テンプレートで Bundle を解決。スクリプトなんかは body の最後につっこむほうがナウいかもしれない。ページの読み込みが早くなるんだってさ。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120910/20120910060245.png" alt="f:id:daruyanagi:20120910060245p:plain" title="f:id:daruyanagi:20120910060245p:plain" class="hatena-fotolife"/>ソースを見たらこんな感じ。 ?v=*** というのは最新版が読み込まれますように、というオマジナイだと思う。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120910/20120910060250.png" alt="f:id:daruyanagi:20120910060250p:plain" title="f:id:daruyanagi:20120910060250p:plain" class="hatena-fotolife"/>肝心の中身を見てみると…… CSS はちゃんと Minify されているようにみえる。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120910/20120910060252.png" alt="f:id:daruyanagi:20120910060252p:plain" title="f:id:daruyanagi:20120910060252p:plain" class="hatena-fotolife"/>JavaScript はなんかエラー出た。使い方が悪いのかもしれないけれど、まぁ、正式版になったらまた検証してみるって感じで。

</div>
<div class="section">
    ### Scripts セクションで誤魔化す
    とまぁ、こんな感じなのだけれど、「ちょろっとビューからスクリプトを動的に追加したいなぁ」というだけならば、もっとお手軽な方法も使える。
```
# Sample.cshtml

@section Scripts
{
    &lt;link rel="stylesheet" type="text/css" href="***1" />
    &lt;link rel="stylesheet" type="text/css" href="***2" />
}
```こうやって Scripts セクションを用意しておいて、
```
# _SiteLayout.cshtml

        :
        :
        @RenderBody("Scripts", false)
    &lt;/body>
&lt;/html>
```とレイアウト側で呼び出せば OK。“スターター サイト”テンプレートで使われていたやり方をマネしてみただけだけどね！

</div>
<div class="section">
    ### 追記
    @chack411 さん曰く、 <a href="http://nuget.org/packages/Microsoft.AspNet.Web.Optimization">http://nuget.org/packages/Microsoft.AspNet.Web.Optimization</a> を使うのが正しいそうです（ありがとうございます！）。また後日試してみましょう。

</div>

