
+++
date = "2017-07-17 14:33:23 +0000 UTC"
draft = false
title = "ASP.NET Core MVC：特定のリクエストを他のサイトにリダイレクトする"
tags = ["ASP.NET Core"]

+++
6月末、事情があって急遽 daruyanagi.jp を ASP.NET Core MVC で書き直した。[空の ASP.NET Core プロジェクトからとりあえず Web サイトのトップページを書いて Azure にデプロイするまで - だるろぐ](http://blog.daruyanagi.jp/entry/2017/06/27/021736)しかし、このとき daruyanagi.jp → blog.daruyanagi.jp へのリダイレクト機能を実装していなかった。[はてなブログのドメインを daruyanagi.jp から blog.daruyanagi.jp へ引越しした - だるろぐ](http://blog.daruyanagi.jp/entry/2017/03/26/234347)[Google Search Console から“「404」ページの増加”というメールが来た - だるろぐ](http://blog.daruyanagi.jp/entry/2017/04/02/013553)リンク先を読むのがめんどくさい人のために、事情をかいつまんでいうと、

<ul>
<li>むかし、はてなブログを daruyanagi.jp で運営していた</li>
<li>はてなブログをサブドメインなしで運用するのは非推奨だったので、blog.daruyanagi.jp へ移した</li>
<li>当然ながら大量のリンク切れが発生</li>
<li>これを解消するため、daruyanagi.jp にリダイレクト機能を組み込んでいた（ASP.NET Web Pages 製）</li>
<li>ASP.NET Web Pages 製 daruyanagi.jp を ASP.NET Core MVC 製にする過程で、リダイレクト機能を省略した</li>
</ul>Visual Studio 2017 Update 3 が正式版になれば、ASP.NET Web Pages のような機能が IDE 側でサポートされるという話を聞いたので、それを待ってから実装してもいいかなと思っていたのだけど、なかなかこない＆ブログにリンク切れが多くて使いにくかったので、とりあえずやっつけの対策を施した。まず、ルーティングの書き換え。今回は /entry だけを対策しておく（ほんとは他の URL にも対策を施さないといけないけれど、今回は一番困るやつだけ対策）。
```cs
// {Root}/startup.cs

app.UseMvc(routes =>
{
    routes.MapRoute(
        name: "entry",
        template: "entry/{*id}",
        defaults: new { controller = "Entry", action = "Index" });

    routes.MapRoute(
        name: "default",
        template: "{controller=Home}/{action=Index}/{id?}");
});

```ちゃんとコントローラーに処理が移っているみたい。“*（アスタリスク）”を付ければ、“/（スラッシュ）”も含めてマッチするみたいだね。

{{< figure src="/images/20170717143025.png"  >}}

とは EntryController をちょちょいのちょいと書き換え。
```cs
// {Root}/Controllers/EntryController.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;

// For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860

namespace daruyanagi.Controllers
{
    public class EntryController : Controller
    {
        // GET: /<controller>/</controller>
        public IActionResult Index()
        {
            var url = HttpContext.Request.Path;

            return Redirect($"http://blog.daruyanagi.jp{url}");
        }
    }
}

```これでだいたいイケてるような気がする。


