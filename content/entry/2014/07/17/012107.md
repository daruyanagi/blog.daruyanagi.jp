
+++
date = "2014-07-17 01:21:07 +0000 UTC"
draft = false
title = "WebMatrix：Web.config の appSettings を使いこなす"
tags = ["WebMatrix","ASP.net Web Pages"]

+++
<a href="https://blog.daruyanagi.jp/entry/2014/07/15/224549">WebMatrix：ローカルとリモートで異なる設定を利用する方法を考えてみた - だるろぐ</a> でちょっと興味がわいたので、Web.config について少しいろいろ試してみた。

<div class="section">
    ### 基本
    {{< figure src="/images/20140717005913.png"  >}}<br/>


<div class="section">
    #### Default.cshtml
    ```html


@using System.Configuration

&lt;html lang="ja">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>マイ サイトのタイトル&lt;/title>
    &lt;/head>
    &lt;body>
        @ObjectInfo.Print(ConfigurationManager.AppSettings)
    &lt;/body>
&lt;/html>

```Web.config の appSettings セクションに記述したアプリケーション設定を読み込む。@ObjectInfo.Print は WebMatrix でちょっとしたデバッグをするときに便利なのでぜひ覚えておこう。

</div>
<div class="section">
    #### Web.config
    ```xml
<!--?-->xml version="1.0" encoding="utf-8"?>

<configuration></configuration>
  .web>
    debug="true" targetFramework="4.0" />
  .web>

    file="Web2.config">
        key="A" value="a"/>
        key="B" value="b"/>
        key="C" value="c"/>
        key="D" value="d"/>
        key="E" value="e"/>
        key="F" value="f"/>
        key="G" value="g"/>
    


```appSettings セクションにアプリケーション設定を記述。<code>file="Web2.config"</code> は後述。

</div>
<div class="section">
    #### 結果
    {{< figure src="/images/20140717011748.png"  >}}たとえば、
```cs
var a = System.Configuration.ConfigurationManager.AppSettings["A"];

```などとすることで、Web.config の appSettings セクションに記述したアプリケーション設定が得られる。ちょっとめんどくさいけれど、API キーなどの静的値はなるべくハードコードせず、appSettings に書いておくべき。

</div>
</div>
<div class="section">
    ### 外部 .config ファイルを利用したアプリケーション設定のオーバーライド
    {{< figure src="/images/20140717011257.png"  >}}以下のような Web2.config ファイルを追加。

<div class="section">
    #### Web2.config
    ```xml
<!--?-->xml version="1.0" encoding="utf-8"?>

<appsettings></appsettings>
    key="E" value="1"/>
    key="F" value="2"/>
    key="G" value="3"/>


```
</div>
<div class="section">
    #### 結果
    {{< figure src="/images/20140717010123.png"  >}}ConfigurationManager.AppSettings["E"] 以降の値が Web2.config の内容によって書き換えられる。Web.config の file 属性で指定した外部 .config ファイルが存在しない場合は、読み込み処理がスキップされる。

</div>
</div>
<div class="section">
    ### 外部 .config ファイルを利用したアプリケーション設定の強制削除
    ちょっと Web2.config をイジってみる。

<div class="section">
    #### Web2.config
    ```xml
<!--?-->xml version="1.0" encoding="utf-8"?>

<appsettings></appsettings>
    <clear></clear> // &lt;- 追加
    &lt;add key="E" value="1"/>
    key="F" value="2"/>
    key="G" value="3"/>


```
</div>
<div class="section">
    #### 結果
    {{< figure src="/images/20140717010556.png"  >}}Web.config で記述したアプリケーション設定がクリアされる。要するに、ASP.NET は .config を読んで、appSettings セクションに書かれた add や clear といったコマンドを AppSettings（Dictionary 型）に対して行っているだけ。なので、
```xml
<!--?-->xml version="1.0" encoding="utf-8"?>

<appsettings></appsettings>
    key="A" />


```とすれば、特定のキーだけを消すことも可能。これを使えば、Web.config で行ったアプリケーション設定を Web2.config から自由にイジれる。使い方間違うとハマるかもだけど。

</div>
</div>
<div class="section">
    ### 外部 .config ファイルを隠しファイルにする
    結論を先に言うと、Web2.config を隠しファイルにしても、appSettings はちゃんと読み込まれる。なので <a href="https://blog.daruyanagi.jp/entry/2014/07/17/004650">WebMatrix：特定のファイルを発行対象に含まない - だるろぐ</a> と組み合わせることで、

<ul>
<li>Web.config</li>
<li>Web2.config（隠しファイル、リモートに発行されない）</li>
</ul>という構成にすれば、

<ul>
<li>ローカル：Web.config ＋ Web2.config のアプリケーション設定で動作</li>
<li>リモート：Web.config のアプリケーション設定で動作</li>
</ul>という風に運用できる（<a href="https://blog.daruyanagi.jp/entry/2014/07/15/224549">WebMatrix：ローカルとリモートで異なる設定を利用する方法を考えてみた - だるろぐ</a> は発想を逆にすればよかった！）。

</div>

