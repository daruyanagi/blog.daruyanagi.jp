
+++
date = "2017-03-18 03:08:10 +0000 UTC"
draft = false
title = "UWP ＋ WebView ＋ XPath でスクレイピングする"
tags = ["UWP"]

+++
WebView の InvokeScriptAsync() を利用してスクレイピングしてみた。
```cs
public sealed partial class MainPage : Page
{
    public MainPage()
    {
        this.InitializeComponent();

        Loaded += MainPage_Loaded;
    }

    private void MainPage_Loaded(object sender, RoutedEventArgs e)
    {
        var browser = new WebView();
        var url = "https://google.co.jp/";
        var xpath = "//h1";
        var result_type = "XPathResult.FIRST_ORDERED_NODE_TYPE";
        var function = $"document.evaluate(" + 
            "&#39;{xpath}&#39;, &#39;document&#39;, null, {result_type}, null" + 
            ").singleNodeValue.innerHTML;";

        browser.NavigationCompleted += async (s, args) =>
        {
            if (!args.IsSuccess) throw new Exception();

            var html = await browser.InvokeScriptAsync(
                "eval", 
                new string[] { function, }
            );

            System.Diagnostics.Debug.WriteLine(html);
        };

        browser.Navigate(new Uri(url));
    }
}

```一応うまくいっているみたい。

{{< figure src="/images/20170318025944.png"  >}}

かし、Windows ストアなんかでスクレイピングをやろうとすると、アプリの切り替えダイアログが出てしまう（プロトコルハンドラーとか言うのか？　これ）。

{{< figure src="/images/20170318030427.png"  >}}

と、AngularJS みたいなサイトでは使えないかもしれない（やり方が悪いだけかもしれない）。また、WebView は UI スレッドで動作するらしいので、バックグラウンドタスクで利用することもできない。あんまりスジのいい方法ではなさそうだ、というのが今回の結論かも。


