
+++
date = "2013-02-03 16:09:15 +0000 UTC"
draft = false
title = "WebMatrix 2：OAuth でログインする（２）"
tags = ["ASP.net Web Pages","WebMatrix"]

+++
<a href="https://blog.daruyanagi.jp/entry/2013/01/27/102043">WebMatrix 2：OAuth でログインする - だるろぐ</a> の続き。今回は“空のサイト”テンプレートから、OAuth によるログイン処理を書いていくことにする。まぁ、“スターターサイト”テンプレートのコードを読めば分かる人もいると思うけど、こういうのは一度自分で書いてみるに限ると思う。

<div class="section">
    ### NuGet で必要なものをインストール
    

{{< figure src="/images/20130203152828.png"  >}}

uGet で <a href="http://nuget.org/packages/Microsoft.AspNet.WebPages.OAuth">NuGet Gallery | Microsoft.AspNet.WebPages.OAuth 3.2.7</a> をインストール。まえにやったとき（<a href="https://blog.daruyanagi.jp/entry/2012/09/04/023414">さて、WebMatrix で OAuth 認証を……Σ(ﾟдﾟlll)ｶﾞｰﾝ - だるろぐ</a>）はインストールできなかったのだけど、今はできるようになってる。何が悪かったのかな？　ま、直ってるならいいや。

{{< figure src="/images/20130203153208.png"  >}}

れをインストールすると、 DotNetOpenAuth を初めとする必要なライブラリも同時にインストールされる。DotNetOpenAuth 系はいろいろあってどれを入れていいのかよくわからないけれど、Microsoft WebPages OAuth library をいれておけばおっけーなのかな。

</div>
<div class="section">
    ### ~/_AppStart.cshtml
    Web サイトを初めて実行するときにロードされる ~/_AppStart.cshtml で、初期設定を行う。
```cs
@{
    // いろんなところで使うので、グローバルにアクセスできるようにしとくか
    App.Database = "Database";

    // ユーザー管理用のテーブルを初期化・作成
    WebSecurity.InitializeDatabaseConnection(
        App.Database,
        "UserProfile", "UserId", "UserName",
        autoCreateTables: true);

    // Google の OAuth を使います！
    OAuthWebSecurity.RegisterGoogleClient();
}

```WebSecurity.InitializeDatabaseConnection は以前（<a href="https://blog.daruyanagi.jp/entry/2012/08/24/095023">WebMatrix でユーザー認証機能 ―― 準備編 - だるろぐ</a>）も使った。OAuth のときもこれを使うみたいだね。

</div>
<div class="section">
    ### ~/Account/Login.cshtml
    お次はログインフォーム。
```cs
@{
    Page.Title = "ログイン";

    var provider = Request.Form["provider"];
}

@{  // POST のときは外部サイトの認証ページへ飛ばす

    if (!provider.IsEmpty() &amp;&amp; IsPost)
    {
        AntiForgery.Validate(); // CSRF 対策

        // 外部認証サービスでの認証を行う
        // 成功したら ~/Account/RegisterService.cshtml を開く
        OAuthWebSecurity.RequestAuthentication(
            provider,
            Href("~/Account/RegisterService")
        );

        return;
    }
}

@{  // GET のとき（だけじゃないけど）は、
    // 外部認証サービスを選択するフォームを表示する

    if (OAuthWebSecurity.RegisteredClientData.Count == 0)
    {
        &lt;p>外部認証サービスが構成されていません。&lt;/p>
    }
    else
    {
        &lt;form method="post">
            @AntiForgery.GetHtml()
            &lt;p>
            @foreach (var client in OAuthWebSecurity.RegisteredClientData)
            {
                &lt;button type="submit" name="provider"
                    value="@client.AuthenticationClient.ProviderName"
                    title="@client.DisplayName アカウントを使用してログイン">
                    @client.DisplayName
                &lt;/button>
            }
            &lt;/p>
        &lt;/form>
    }
}

```

{{< figure src="/images/20130203155104.png"  >}}

のボタンを押すと、

{{< figure src="/images/20130203155926.png"  >}}

oogle の認証ページに飛ぶはず。

</div>
<div class="section">
    ### ~/Account/RegisterService.cshtml
    Google での認証が成功すると、このページに着地する。まぁ、名前は好きにすればいいと思う。
```cs
@{
    Page.Title = "登録";
}

&lt;dl>
@foreach (var key in Request.Params.Keys)
{
    &lt;dt>@key&lt;/dt>
    &lt;dd>@Request.Params[key.ToString()]&lt;/dd>
}
&lt;/dl>

```

{{< figure src="/images/20130203160114.png"  >}}

回はパラメーターを列挙するだけにしておいた。ほんとはここから

<ul>
<li>認証がうまくいったか</li>
<li>認証データの取り出し</li>
<li>このサイトでの認証とデータベースへの登録</li>
</ul>などを行わないといけない。外部認証サービスによって返ってくるデータは微妙に違うけれど、

<ul>
<li><a href="http://msdn.microsoft.com/ja-jp/library/jj158354(v=vs.111).aspx">OAuthWebSecurity.VerifyAuthentication Method (Microsoft.Web.WebPages.OAuth) | Microsoft Docs</a></li>
<li><a href="http://msdn.microsoft.com/ja-jp/library/microsoft.web.webpages.oauth.oauthwebsecurity.trydeserializeprovideruserid(v=vs.111).aspx">OAuthWebSecurity.TryDeserializeProviderUserId(String, String, String) Method (Microsoft.Web.WebPages.OAuth) | Microsoft Docs</a></li>
<li><a href="http://msdn.microsoft.com/ja-jp/library/microsoft.web.webpages.oauth.oauthwebsecurity.trygetoauthclientdata(v=vs.111).aspx">OAuthWebSecurity.TryGetOAuthClientData(String, AuthenticationClientData) Method (Microsoft.Web.WebPages.OAuth) | Microsoft Docs</a></li>
</ul>などを使うことによって、統一的に扱えるようなので安心……という感じのようだ。知らんけど。今日のところは、ここまで。

</div>

