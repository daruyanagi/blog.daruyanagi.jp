<!DOCTYPE html>
<html><link rel="icon" href="https://via.placeholder.com/70x70">
<link rel="stylesheet" href="https://andybrewer.github.io/mvp/mvp.css">

<meta charset="utf-8">
<meta name="description" content="My description">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>WebMatrix でユーザー認証機能（2） ―― WebSecurityってどうやって使うんだ？ - だるろぐ - だるやなぎのブログ</title>

<style>
    nav {
        margin-bottom: 0;
    }

    body {
        font-family: "UD デジタル 教科書体 NP-R", Arial, Helvetica, sans-serif;
    }

    table {
        margin: 2em auto;
        border: none;
    }

    th, td, tr {
        text-align: right !important;
        padding: 1rem !important;
    }

    td {
        border-bottom: 1px solid gray;
    }
</style>


    
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53152247-5"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-53152247-5');
        </script>
    
<body>
        <header><nav>
    <a href="/"><img alt="Logo" src="/logo.png" height="70"></a>
    
</nav>

<h1>だるろぐ - だるやなぎのブログ</h1>

<p></p>



<hr></header>

        <main>
<article>
    <h1>WebMatrix でユーザー認証機能（2） ―― WebSecurityってどうやって使うんだ？</h1>
    
    <p class="published">
        <time>
            公開日：
            2012/08/24
        </time>        
    </p>

    <p>さて、前回（<a href="https://blog.daruyanagi.jp/entry/2012/08/24/095023">WebMatrix でユーザー認証機能 ―― 準備編 - だるろぐ</a>）準備した WebSecurity Helper ですけど、これってどうやって使うんでしょうね。ちょっとメタデータからプロパティやメソッドを引っ張ってみました。名前と引数をみるだけで使い方がだいたい分かる感じ。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">using</span> System;
<span style="color:#66d9ef">using</span> System.Web;

<span style="color:#66d9ef">namespace</span> WebMatrix.WebData
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurity</span>
    {
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">string</span> EnableSimpleMembershipKey;

<span style="color:#960050;background-color:#1e0010">```</span>WebSecurity <span style="color:#960050;background-color:#1e0010">は静的クラスです。“</span>EnableSimpleMembershipKey<span style="color:#960050;background-color:#1e0010">”はよくわかりませんが、</span> <span style="color:#66d9ef">readonly</span> <span style="color:#960050;background-color:#1e0010">だしとくにわからなくても問題無さそう。</span> AppSetting <span style="color:#960050;background-color:#1e0010">から読み込んだキーを保存しているみたいですけどね。外部に公開してるんだから、どっかの外部クラスが使うんだろうか……。</span> ASP.NET <span style="color:#960050;background-color:#1e0010">の認証システムは全然わかってないけれど、おいおい解決していきたいです。</span>
<span style="color:#960050;background-color:#1e0010">```</span>cs
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> CurrentUserId { <span style="color:#66d9ef">get</span>; }
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> CurrentUserName { <span style="color:#66d9ef">get</span>; }
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> HasUserId { <span style="color:#66d9ef">get</span>; }
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> Initialized { <span style="color:#66d9ef">get</span>; }
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> IsAuthenticated { <span style="color:#66d9ef">get</span>; }

<span style="color:#960050;background-color:#1e0010">```お次はプロパティ群ですね。</span> CurrentUser <span style="color:#960050;background-color:#1e0010">に関するさまざまな情報を取得できます。</span> Initialized <span style="color:#960050;background-color:#1e0010">だけは</span> &lt;a href=<span style="color:#e6db74">&#34;http://msdn.microsoft.com/en-us/library/webmatrix.webdata.websecurity(v=vs.99).aspx&#34;</span>&gt;http:<span style="color:#75715e">//msdn.microsoft.com/en-us/library/webmatrix.webdata.websecurity(v=vs.99).aspx&lt;/a&gt; に記述がなくてわからない。たぶん、前回やった初期化が完了しているかどうかを取得できるのだと思う。
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">```</span>cs
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> ChangePassword(
            <span style="color:#66d9ef">string</span> userName, <span style="color:#66d9ef">string</span> currentPassword,
            <span style="color:#66d9ef">string</span> newPassword);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> ConfirmAccount(
            <span style="color:#66d9ef">string</span> accountConfirmationToken);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> ConfirmAccount(
            <span style="color:#66d9ef">string</span> userName, <span style="color:#66d9ef">string</span> accountConfirmationToken);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> CreateAccount(
            <span style="color:#66d9ef">string</span> userName, <span style="color:#66d9ef">string</span> password,
            <span style="color:#66d9ef">bool</span> requireConfirmationToken = <span style="color:#66d9ef">false</span>);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> CreateUserAndAccount(
            <span style="color:#66d9ef">string</span> userName, <span style="color:#66d9ef">string</span> password,
            <span style="color:#66d9ef">object</span> propertyValues = <span style="color:#66d9ef">null</span>,
            <span style="color:#66d9ef">bool</span> requireConfirmationToken = <span style="color:#66d9ef">false</span>);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> GeneratePasswordResetToken(
            <span style="color:#66d9ef">string</span> userName,
            <span style="color:#66d9ef">int</span> tokenExpirationInMinutesFromNow = <span style="color:#ae81ff">1440</span>);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> DateTime GetCreateDate(<span style="color:#66d9ef">string</span> userName);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> DateTime GetLastPasswordFailureDate(
            <span style="color:#66d9ef">string</span> userName);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> DateTime GetPasswordChangedDate(
            <span style="color:#66d9ef">string</span> userName);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> GetPasswordFailuresSinceLastSuccess(
            <span style="color:#66d9ef">string</span> userName);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> GetUserId(<span style="color:#66d9ef">string</span> userName);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> GetUserIdFromPasswordResetToken(
            <span style="color:#66d9ef">string</span> token);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> InitializeDatabaseConnection(
            <span style="color:#66d9ef">string</span> connectionStringName, <span style="color:#66d9ef">string</span> userTableName,
            <span style="color:#66d9ef">string</span> userIdColumn, <span style="color:#66d9ef">string</span> userNameColumn,
            <span style="color:#66d9ef">bool</span> autoCreateTables);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> InitializeDatabaseConnection(
            <span style="color:#66d9ef">string</span> connectionString, <span style="color:#66d9ef">string</span> providerName,
            <span style="color:#66d9ef">string</span> userTableName, <span style="color:#66d9ef">string</span> userIdColumn,
            <span style="color:#66d9ef">string</span> userNameColumn, <span style="color:#66d9ef">bool</span> autoCreateTables);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> IsAccountLockedOut(
            <span style="color:#66d9ef">string</span> userName, <span style="color:#66d9ef">int</span> allowedPasswordAttempts,
            <span style="color:#66d9ef">int</span> intervalInSeconds);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> IsAccountLockedOut(
            <span style="color:#66d9ef">string</span> userName, <span style="color:#66d9ef">int</span> allowedPasswordAttempts,
            TimeSpan interval);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> IsConfirmed(<span style="color:#66d9ef">string</span> userName);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> IsCurrentUser(<span style="color:#66d9ef">string</span> userName);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> Login(
            <span style="color:#66d9ef">string</span> userName, <span style="color:#66d9ef">string</span> password,
            <span style="color:#66d9ef">bool</span> persistCookie = <span style="color:#66d9ef">false</span>);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Logout();
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> RequireAuthenticatedUser();
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> RequireRoles(<span style="color:#66d9ef">params</span> <span style="color:#66d9ef">string</span>[] roles);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> RequireUser(<span style="color:#66d9ef">int</span> userId);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> RequireUser(<span style="color:#66d9ef">string</span> userName);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> ResetPassword(
            <span style="color:#66d9ef">string</span> passwordResetToken, <span style="color:#66d9ef">string</span> newPassword);
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> UserExists(<span style="color:#66d9ef">string</span> userName);
    }
}

<span style="color:#960050;background-color:#1e0010">```</span>WebSecurity <span style="color:#960050;background-color:#1e0010">クラスのメンバーたち（このうち、</span>InitializeDatabaseConnection() <span style="color:#960050;background-color:#1e0010">は前回使いました）。</span>

&lt;ul&gt;
&lt;li&gt;<span style="color:#960050;background-color:#1e0010">メールなどを利用した本人確認</span>&lt;/li&gt;
&lt;li&gt;<span style="color:#960050;background-color:#1e0010">パスワードのリセット（忘れちゃった時のためかな？）</span>&lt;/li&gt;
&lt;li&gt;<span style="color:#960050;background-color:#1e0010">パスワードの入力ミスを複数回繰り返すとアカウントをロック</span>&lt;/li&gt;
&lt;/ul&gt;<span style="color:#960050;background-color:#1e0010">なんてことができるみたい。気になったのは</span> CreateUserAndAccount() <span style="color:#960050;background-color:#1e0010">ですかね。</span> Account <span style="color:#960050;background-color:#1e0010">（メンバーシップアカウント）と</span> User <span style="color:#960050;background-color:#1e0010">（ユーザープロファイル、ユーザー情報）って別物なんだ。“</span>Starter Site<span style="color:#960050;background-color:#1e0010">”テンプレートで使っていたのは</span> CreateAccount() <span style="color:#960050;background-color:#1e0010">で、ほかにサンプルも見当たらなかったのでよくわかりませんが……。</span>

<figure>
    <img src="/images/20120824104305.png"/> 
</figure>


<span style="color:#960050;background-color:#1e0010">ょっと</span> DB <span style="color:#960050;background-color:#1e0010">のテーブル構成を見てみましょう。なんかいろいろありますけど、メンバーシップアカウントは</span> webpages_Membership <span style="color:#960050;background-color:#1e0010">、ユーザープロファイルは</span> Users<span style="color:#960050;background-color:#1e0010">（初期設定は</span> UserProfile<span style="color:#960050;background-color:#1e0010">）で管理するというのがなんとなく想像できます。どうやら</span> webpages_ <span style="color:#960050;background-color:#1e0010">というプレフィックスがついたテーブルはシステム（</span>WebSecurity Helper<span style="color:#960050;background-color:#1e0010">）が管理するみたい。</span>

<figure>
    <img src="/images/20120824103854.png"/> 
</figure>


<span style="color:#960050;background-color:#1e0010">際、</span>webpages_Membership <span style="color:#960050;background-color:#1e0010">テーブルには認証情報を格納するカラムがたくさん用意されていますが、</span>

<figure>
    <img src="/images/20120824103857.png"/> 
</figure>


serProfile <span style="color:#960050;background-color:#1e0010">テーブルのほうはかなりスッキリしていて「好きに使え」と言わんばかり。たとえばユーザーのプロフィール画像なんかの情報はこっちに保存しておいたほうがいいみたいですね。これはおいおい試していきたいと思います。</span>


</code></pre></div>
</article>

<section>
    <style>
        article p.published { text-align: right; }

        .spacer { margin: auto 1em;}
    </style>

    <p>
        
        <a href="https://blog.daruyanagi.jp/entry/2012/08/24/095023/">&laquo; Older</a>
        
        <span class="spacer">|</span>
        <a href="/">Home</a>
        <span class="spacer">|</span>
        <a href="#">Top</a>
        <span class="spacer">|</span>
        
            <a href="https://blog.daruyanagi.jp/entry/2012/08/25/003421/">Newer &raquo;</a>
        
    </p>    
    
</section>


        </main>
        
        <footer><hr>
<p>
    <a href="/about">daruyanagi</a> &copy; 2007-2020
</p>

<script data-ad-client="ca-pub-0944887782985208" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></footer>
    </body>
</html>
