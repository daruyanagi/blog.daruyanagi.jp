
+++
date = "2012-02-25 08:42:11 +0000 UTC"
draft = false
title = " ASP.net MVC 3 で Dropbox を利用する"
tags = ["ASP.net","Dropbox"]

+++
自家製の Wiki システムを ASP.net MVC 3 で作ってて、「リビジョン管理機能がほしいですなぁ」と思った。そこで試行錯誤したのだけど、だんだん面倒になってきた。そしたら思いついた。_「Dropbox に記事を保存すれば勝手にリビジョン管理してくれるんだから、そっちにバックアップ取ればいいじゃん」__「そもそも Dropbox をデータベースとして使えばよくね？」_というわけで、とりあえず Dropbox を使うところから始めてみた。

<div class="section">
    ### 準備
    まず、アプリケーションの作成。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120225/20120225080924.png" alt="f:id:daruyanagi:20120225080924p:plain" title="f:id:daruyanagi:20120225080924p:plain" class="hatena-fotolife"/>別に認証機能は要らないや。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120225/20120225080955.png" alt="f:id:daruyanagi:20120225080955p:plain" title="f:id:daruyanagi:20120225080955p:plain" class="hatena-fotolife"/>今回は SharpBox (<a href="http://sharpbox.codeplex.com/">http://sharpbox.codeplex.com/</a>) を使って楽をすることにした。NuGetでさくっとインストール。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120225/20120225081131.png" alt="f:id:daruyanagi:20120225081131p:plain" title="f:id:daruyanagi:20120225081131p:plain" class="hatena-fotolife"/>あと、<a href="https://www2.dropbox.com/developers/apps">https://www2.dropbox.com/developers/apps</a> でアプリの登録をしておくのも忘れずに。APIキーをここで取得しておく必要がある。

</div>
<div class="section">
    ### コード
    
<div class="section">
    #### コントローラー
    まず、Homeコントローラーを作る。なぜ Home という名前なのかというと、Global.asax を書き換えるのが面倒くさいからですね。わかります。スキャフォールディングも使って楽をしましょう。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120225/20120225081310.png" alt="f:id:daruyanagi:20120225081310p:plain" title="f:id:daruyanagi:20120225081310p:plain" class="hatena-fotolife"/>Index メソッドを書く。とりあえず動かしているだけなのでごちゃごちゃしているけど、接続→ルートの取得→（ファイルアップロード）→ファイルの列挙 という操作をしているだけ。あとでモデルへ追いだそう。

    ```
public ActionResult Index()
{
    var storage = new CloudStorage();
    var config = CloudStorage.GetCloudConfigurationEasy(nSupportedCloudConfigurations.DropBox);

    // load a valid security token from file
    ICloudStorageAccessToken accessToken;
    using (var fs = System.IO.File.Open(
        Server.MapPath("~/App_Data/DropBoxToken"),
        System.IO.FileMode.Open,
        System.IO.FileAccess.Read,
        System.IO.FileShare.None))
    {
        accessToken = storage.DeserializeSecurityToken(fs);
    }

    // open the connection
    var storageToken = storage.Open(config, accessToken);

    // get the root entry of the cloud storage 
    ICloudDirectoryEntry root = storage.GetRoot();
    if (root == null)
    {
        throw new Exception("ルートあらへん。");
    }

    // Upload file
    if (root.Length == 0)
    {
        storage.UploadFile(Server.MapPath("~/App_Data/Home.md"), root);
    }

    // Enum files
    var model = new List&lt;ICloudFileSystemEntry>();
    foreach (ICloudFileSystemEntry entry in root)
    {
        // フィルタリングとか。あ、Linq使えばよかった
        model.Add(entry);
    }

    // close the cloud storage connection
    if (storage.IsOpened)
    {
        storage.Close();
    }

    return View(model);
}
```

</div>
<div class="section">
    #### トークンファイルの作成
    言い忘れていたが、 /App_Data/DropBoxToken は、SharpBox に付属のツールで作成する。_（プロジェクトフォルダ）\packages\AppLimit.CloudComputing.SharpBox.1.2.0.542\lib\net40-full_ にあるので探してみよう。これがわからなくてだいぶググった。じゃなくてビングった。SharpBox 1.2 から認証周りがだいぶ変わっていて、サンプル読んでいるとダマされるので注意。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120225/20120225081949.png" alt="f:id:daruyanagi:20120225081949p:plain" title="f:id:daruyanagi:20120225081949p:plain" class="hatena-fotolife"/>できたファイルは App_Data に突っ込んでおいた。あまり自信はないけど、APS.net の作法ではこれでいい気がする。ついでにファイルが何もない場合にアップロードする初期ファイル（Home.md）も、ここに用意しておいた。

</div>
</div>
<div class="section">
    ### ビュー
    Home/Index のビューを作成する。Index メソッドのコンテキストメニューから簡単に作成できる。

    ```
@model List&lt;AppLimit.CloudComputing.SharpBox.ICloudFileSystemEntry>

@{
    ViewBag.Title = "Index";
}

&lt;h2>Index&lt;/h2>
&lt;ul>
@foreach (var i in Model)
{
    &lt;li>@i.Name (@i.Modified)&lt;/li>
}
&lt;/ul>
```

</div>
<div class="section">
    ### ［F5］！
    無事動いているみたい。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120225/20120225082122.png" alt="f:id:daruyanagi:20120225082122p:plain" title="f:id:daruyanagi:20120225082122p:plain" class="hatena-fotolife"/>ローカルの Dropbox にもアップロードしたファイルが現れた。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120225/20120225082309.png" alt="f:id:daruyanagi:20120225082309p:plain" title="f:id:daruyanagi:20120225082309p:plain" class="hatena-fotolife"/>

</div>
<div class="section">
    ### Thanks!
    ほとんどここを参照したので、みんなも見てみればいいと思うよ。 → <a href="http://blog.jayway.com/2012/02/06/unboxing-dropbox-and-sharpbox-2/">Unboxing Dropbox and SharpBox | Jayway Team Blog - Sharing Experience</a>

</div>

