
+++
date = "2017-05-17 07:33:39 +0000 UTC"
draft = false
title = "PowerShell：環境構築を（なるべく）自動化する"
tags = ["PowerShell"]

+++
Windows 10 は［回復］オプションで割と簡単に初期化できるので、なんか調子悪くなったときは気軽にキレイサッパリにしているのだけど、そのあとの環境構築を毎回手動でやるのがいい加減かったるいので、できるだけスクリプトでできんもんかなーと考えてみた。ウチは OS をわりとプレーンな状態で使う派なので、実はやることがそんなにないんだけど、それでも以下のことが必要っぽかった。

<ul>
<li>（データは OneDrive で同期する。スタンドアロンアプリもだいたい OneDrive で）</li>
<li>Set-ExecutionPolicy -ExecutionPolicy RemoteSigned</li>
<li>chocolatey で必要なアプリをセットアップ
<ul>
<li>chocolatey で管理できない（するとかえって面倒）なものは OneDrive へ保存済みのインストーラーでセットアップ</li>
</ul></li>
<li>シンボリックリンクを張る
<ul>
<li>Picture\Screenshots -> OneDrive\Screenshots（スクリーンショットを同期するため）</li>
</ul></li>
</ul>これだったら自分の PowerShell 力でもなんとかなると思った。
```ps1
Write-Host "STEP 0: Set-ExecutionPolicy を RemoteSigned に書き換えます……"

Set-ExecutionPolicy -ExecutionPolicy RemoteSigned
Write-Host ""

Write-Host "STEP 1: chocolatey をセットアップしています……"

if (Test-Path "C:\ProgramData\chocolatey")
{
    Write-Host "すでにインストールされています。"
}
else
{
    iex ((New-Object System.Net.WebClient).DownloadString(&#39;https://chocolatey.org/install.ps1&#39;))
    # Get-PackageProvider -name chocolatey
    Write-Host "インストールが完了しました。"
}

Write-Host ""

Write-Host "STEP 2: ソフトウェアをインストールしています……"

choco install -y paint.net
choco install -y sizer
choco install -y dotnetcore-sdk  
choco install -y visualstudiocode 
choco install -y dropbox 
choco install -y vlc 

# Nullsoft Install System
Start-Process -FilePath "$Home\OneDrive\Apps\WinSnap_4.5.8-setup.exe" -ArgumentList "/S"
# Advanced Installer
Start-Process -FilePath "$Home\OneDrive\Apps\emed64_16.7.2.exe" -ArgumentList "/quiet"

Write-Host ""

Write-Host "STEP 3: シンボリックリンクを作成しています……"

Write-Host "Picture\Screenshots -> OneDrive\Screenshots"
Set-Location "$Home\Pictures"
Remove-Item "Screenshots"
New-Item -Type SymbolicLink -Path "Screenshots" -Value "$Home\OneDrive\Screenshots"

Write-Host ""

Write-Host "セットアップが終了しました。キーを押すと終了します。"
$host.UI.ReadLine()

```このスクリプトを管理者権限で起動すればよいのだけど、PowerShell のコンテキストメニューには［管理者権限で実行する］コマンドはないんだな。バッチファイルならあるのに。

{{< figure src="/images/20170517072412.png"  >}}

―というわけで、スクリプトをキックするためのバッチファイルも書いた。
```
@powershell -NoProfile -ExecutionPolicy RemoteSigned -File "C:\Users\Hideto\OneDrive\Initialize.ps1"
```

{{< figure src="/images/20170517072704.png"  >}}

urface 3 を初期化してテストした後に、デスクトップ PC でも試してみたのだけど、<code>choco install -y dropbox</code> が失敗して面倒くさいことになった<a href="#f-63094833" name="fn-63094833" title="利用したバージョンのオフラインインストーラーがどうにも動かない。Web インストーラーをダウンロード＆実行して解決">*1</a>以外は、割とスムーズにいった。実は以前からところどころを自動化していたのだけど、ちゃんとメンテナンスすればいろいろ楽になるかなーと思った。Windows ストアからのインストールもコマンドでできたらいいんだけど……かつて「OneGet」で Windows ストアをプロバイダーにできるようになるとか聞いた覚えがあるんだが、どうなったんだろう。
<div class="footnote">
<a href="#fn-63094833" name="f-63094833" class="footnote-number">*1</a><span class="footnote-delimiter">:</span><span class="footnote-text">利用したバージョンのオフラインインストーラーがどうにも動かない。Web インストーラーをダウンロード＆実行して解決</span>
</div>

