
+++
date = "2012-06-19 02:24:55 +0000 UTC"
draft = false
title = "デスクトップ全体を一時的に暗転させたい (2)"
tags = ["Windows","C#"]

+++
<a href="http://daruyanagi.hatenablog.com/entry/2012/05/27/155731">デスクトップ全体を一時的に暗転させたい - だるろぐ</a> がなぜか動かんなぁ、と思っていろいろ試していた（<a href="http://daruyanagi.hatenablog.com/entry/2012/06/18/202158">08式机上撮影機 v1.5.0 - だるろぐ</a>）のだけど、原因は FormWindowState.Maximized だったっぽい。これをコメントアウトすると動いた。
```cs
public const int AW_HIDE = 0x10000;
public const int AW_ACTIVATE = 0x20000;
public const int AW_SLIDE = 0x40000;
public const int AW_BLEND = 0x80000;
public const int AW_HOR_POSITIVE = 0x00000001;
public const int AW_HOR_NEGATIVE = 0x00000002;
public const int AW_VER_POSITIVE = 0x00000004;
public const int AW_VER_NEGATIVE = 0x00000008;
public const int AW_CENTER = 0x00000010;

[DllImport("user32.dll", CharSet = CharSet.Auto, SetLastError = true)]
public static extern int AnimateWindow(
    IntPtr hWnd, int dwTime, int dwFlags);

using (var form = new Form()
{
	BackColor = Color.Black,
	ShowInTaskbar = false,
	TopMost = true,
	// WindowState = FormWindowState.Maximized, &lt;- 諸悪の根源！
	Left = 0,
	Top = 0,
	Width = Screen.PrimaryScreen.Bounds.Width,
	Height = Screen.PrimaryScreen.Bounds.Height,
	FormBorderStyle = FormBorderStyle.None,
})
{
	int result = 0;
	const int interval = 200;

	result = AnimateWindow(form.Handle,
            interval, AW_BLEND | AW_ACTIVATE);
	if (result != 0) Debug.WriteLine(
            Marshal.GetLastWin32Error());
	form.Show();

	if (settings.SoundEnabled &amp;&amp;
            File.Exists("PrintScreen.wav"))
	    new SoundPlayer("PrintScreen.wav").Play();

	result = AnimateWindow(form.Handle, interval,
            AW_BLEND | AW_HIDE);
	if (result != 0) Debug.WriteLine(
            Marshal.GetLastWin32Error());
	form.Hide();
}

```調べてる時に知ったのだけど、Wind32 API を DllImport するときに SetLastError = true を指定しておけば、GetLastError() を利用しなくてもマネージドな Marshal.GetLastWin32Error() でエラーの内容が取得できるのだそうだ。一つ賢くなった。


