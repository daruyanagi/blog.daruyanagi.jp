
+++
date = "2013-09-05 07:02:45 +0000 UTC"
draft = false
title = "WebMatrix 3"
tags = ["WebMatrix","ASP.net Web Pages","Twitter","Windows開発"]

+++
{{< figure src="/images/20130905061149.png"  >}}ちょっと Twitter と連携するアプリを作ってみたかったのだけど、“スターター サイト”テンプレートを使った例以外はあまり載っていなかったので、今回はそれを使わずに、“空のサイト”テンプレートから作ってみるよ。というのも、ググってたら自分のサイトが検索に引っかかって、<a href="https://blog.daruyanagi.jp/entry/2013/02/03/160915">WebMatrix 2：OAuth でログインする（２） - だるろぐ</a> を放置することすでに半年経つことが判明したので……さすがにこの当時のことはあまりよく思い出せないのだけど、今回の記事がフォローアップのようなものになれば幸い。

<div class="section">
    ### 下準備
    {{< figure src="/images/20130905063705.png"  >}}まず NuGet で <a href="http://www.nuget.org/packages/Microsoft.AspNet.WebPages.OAuth/">NuGet Gallery | Microsoft.AspNet.WebPages.OAuth 3.2.7</a> をインストール。これで“スターター サイト”テンプレートでも使われている <a href="http://msdn.microsoft.com/ja-jp/library/microsoft.web.webpages.oauth.oauthwebsecurity(v=vs.111).aspx">OAuthWebSecurity Class (Microsoft.Web.WebPages.OAuth) | Microsoft Docs</a> が使えるようになる。{{< figure src="/images/20130905062911.png"  >}}次に <a href="https://dev.twitter.com/apps/">https://dev.twitter.com/apps/</a> でアプリの登録を行っておく。登録祭の必須入力事項は以下のとおり。

<ul>
<li>Name: アプリの名前</li>
<li>Description: title</li>
<li>Website: <a href="http://127.0.0.1:****/">http://127.0.0.1:****/</a> （localhost は無効な URL として蹴られる）</li>
<li>Callback URL: <a href="http://127.0.0.1:****/">http://127.0.0.1:****/</a> （空っぽだと動かないっぽい）</li>
<li>Allow this application to be used to Sign in with Twitter: 無効化</li>
</ul>アプリを登録したら、

<ul>
<li>Consumer key</li>
<li>Consumer secret</li>
</ul>を取得し、~/_AppStart.cshtml で初期化を行う。
```cs
@{
    // DB名: kenzo-memo.sdf
    WebSecurity.InitializeDatabaseConnection("kenzou-memo", "Users", "UserId", "Name", true);  

    OAuthWebSecurity.RegisterTwitterClient(
        "kFe1j**********LTcSizQ",
        "aKz6C**********Qzws06agyxRXImPk9sfETNQeg"
    );
}

```これで OAuthWebSecurity の twitter プロバイダーが利用できるようになる。このプロバイダーは OAuth 認証に必要な面倒事の一切を引き受けてくれる。

</div>
<div class="section">
    ### ~/Default.cshtml
    {{< figure src="/images/20130905061617.png"  >}}ログインしていない場合はログインボタンを、ログインしている場合はログオフのリンクを表示するだけの簡単なコード。
```cs
&lt;!DOCTYPE html>

&lt;html lang="en">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>&lt;/title>
    &lt;/head>
    &lt;body>
    @if (User.Identity.IsAuthenticated)
    {
        &lt;p>@User.Identity.Name&lt;/p>
        &lt;p>&lt;a href="Logout.cshtml">Logout&lt;/a>&lt;/p>
    }
    else
    {
        &lt;a href="~/Login.cshtml">
            &lt;img src="Twitter ボタンを用意する" />
        &lt;/a>
    }
    &lt;/body>
&lt;/html>

```資格関連の情報は User.Identity （<a href="http://msdn.microsoft.com/ja-jp/library/system.web.httpcontext.user.aspx">HttpContext.User Property (System.Web) | Microsoft Docs</a>）でとれる。

</div>
<div class="section">
    ### ~/Login.cshtml
    ```cs
@{
    var returnUrl = Request.UrlReferrer.ToString();

    OAuthWebSecurity.RequestAuthentication(
        "twitter", // プロバイダー名は文字列で指定
        Href("~/LoginCallback", new { returnUrl })
    );
}

```**OAuthWebSecurity.RequestAuthentication** で Twitter へリクエストを投げる。{{< figure src="/images/20130905064446.png"  >}}おなじみのこの画面へ飛ばされる。

</div>
<div class="section">
    ### ~/LoginCallback
    Twitter で認証処理を行うと、~/LoginCallback にリダイレクトされてくるので、**OAuthWebSecurity.VerifyAuthentication** で検証し、成否を得る（今回で言えば result 変数）。Twitter でのログインが成功していたら、その資格情報（OAuth なのでパスワードはないけど）をデータベースに格納し（**OAuthWebSecurity.CreateOrUpdateAccount**）、アプリにログインさせる（**OAuthWebSecurity.Login**）。
```cs
@{
    var returnUrl = Request["returnUrl"];

    // ログインの検証
    var result = OAuthWebSecurity.VerifyAuthentication(  
         Href("LogonCallBack", new { ReturnUrl = returnUrl })
    );

    if (result.IsSuccessful)
    {
        // ログインが成功すると、
        // - provider: twitter
        // - ProviderUserId: twitter の ID
        // - UserName: twitter のスクリーンネーム
        // の3つが得られる。自動補完が効かないので変数に入れとく
        var provider = result.Provider;
        var providerUserId = result.ProviderUserId;
        var userName = result.UserName;

        // ユーザー名が Users テーブルに存在しない場合、
        // あらかじめユーザー名を追加しておく。
        // でないと CreateOrUpdateAccount() でコケる
        using (var db = Database.Open("kenzou-memo"))
        {
            const string SELECT = "SELECT * FROM USERS WHERE Name=@0";
            const string INSERT = "INSERT INTO Users (Name) VALUES (@0)";

            if (db.QuerySingle(SELECT, userName) == null)
            {
                db.Execute(INSERT, userName);
            }
        }

        // CreateOrUpdate とか言ってるけど、
        // やってることは Users テーブルと内部管理テーブルの紐づけ
        OAuthWebSecurity.CreateOrUpdateAccount(
            provider,
            providerUserId,
            userName);

        // ログインチケットの発行
        OAuthWebSecurity.Login(
            provider,
            providerUserId,
            createPersistentCookie: true);

        Response.Redirect(returnUrl);        
    }
    else
    {
        // ログインに失敗したときの処理
    }
}

```{{< figure src="/images/20130905064840.png"  >}}{{< figure src="/images/20130905064842.png"  >}}成功するとこんなかんじにユーザーがデータベースに追加される。ちなみに result の中身はこんな感じ。{{< figure src="/images/20130905064941.png"  >}}ObjectInfo.Print() はデバッグにとっても便利なヘルパーなのでぜひ覚えておいてね！

</div>
<div class="section">
    ### ~/Logout.cshtml
    最後にログアウトの処理も書いておく。
```cs
@{
    var returnUrl = Request.UrlReferrer.ToString();

    WebSecurity.Logout();

    Response.Redirect(returnUrl);
}

```ログインの時はもっぱら <a href="http://msdn.microsoft.com/ja-jp/library/microsoft.web.webpages.oauth.oauthwebsecurity(v=vs.111).aspx">OAuthWebSecurity Class (Microsoft.Web.WebPages.OAuth) | Microsoft Docs</a> を使っていたけれど、ログアウトはいつもどおり <a href="http://msdn.microsoft.com/ja-jp/library/webmatrix.webdata.websecurity(v=vs.111).aspx">WebSecurity Class (WebMatrix.WebData) | Microsoft Docs</a> が使える。

</div>
<div class="section">
    ### まとめ
    
<ol>
<li>OAuthWebSecurity.RegisterTwitterClient で twitter プロバイダーを有効化</li>
<li>OAuthWebSecurity.RequestAuthentication で Twitter の認証画面へ飛ばす</li>
<li>OAuthWebSecurity.VerifyAuthentication で Twitter での認証がうまく言ったか確認</li>
<li>OAuthWebSecurity.CreateOrUpdateAccount でアプリのアカウントと紐付ける</li>
<li>OAuthWebSecurity.Login でアプリにログインする</li>
</ol>“スターター サイト”テンプレートは手広い実装になっていて、その分複雑になっているけれど、アプリのアカウント＝ Twitter アカウントという運用でよいのならば、このように比較的簡単に実装できる。

</div>

