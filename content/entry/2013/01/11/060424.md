
+++
date = "2013-01-11 06:04:24 +0000 UTC"
draft = false
title = "WebMatrix 2：RESTful？な Web アプリケーション （3） "
tags = ["ASP.net Web Pages","WebMatrix"]

+++
<a href="https://blog.daruyanagi.jp/entry/2013/01/11/041856">WebMatrix 2：RESTful？な Web アプリケーション （2） - だるろぐ</a> の続き。日中戦争、ベトナム戦争並みに泥沼化してきたけど、突き進んでいこう！

<div class="section">
    ### PUT/DELETE メソッドを扱えるようにする
    とりあえず、前回の宿題をさっさと終わらせる。
```cs
@{
    Layout = "_SiteLayout.cshtml";

    // POST で PUT/DELETE を代用
    string method = Request.HttpMethod.ToUpper();
    if (IsPost &amp;&amp; Request["_method"] != null) 
    {
        method = Request["_method"].ToUpper();
    }
}

```こんなのでいいのかな。あとはこれを switch すればよさそうだけど……
```cs
@switch (method)
{
    case "GET":
        // いろいろ
        break;
    case "POST":
        // さまざま
        break;
    case "PUT":
        // ほげほげ
        break;
    case "DELETE":
        // ふがふが
        break;
    default:
       throw new Exception("なにいってんだおまえ");
}

```――ダサいな！たまたま今日、北陸の女神様のブログ（<a href="http://d.hatena.ne.jp/miso_soup3/20130110/1357822008">ASP.NET WEB API ルーティングについていろいろ - miso_soup3 Blog</a>）を読んでいたのだけど、ASP.NET Web API みたいに
```cs
// GET ~/api/values/
public void Get() { }

// GET ~/api/values/:id
public void Get(int id) { }

// POST ~/api/values/
public void Post() { }

// PUT ~/api/values/
public void Put() { }

```こういうのを勝手にバインディング（っていうのかな？）して呼び出してくれたら、カッコいいのかもしれない。

</div>
<div class="section">
    ### メソッドのバインディング
    というわけで、こういうのを考えてみた。
```cs
@using System.Reflection

@{
    Layout = "_SiteLayout.cshtml";

    // POST で PUT/DELETE を代用
    string method = Request.HttpMethod.ToUpper();
    if (IsPost &amp;&amp; Request["_method"] != null) 
    {
        method = Request["_method"].ToUpper();
    }

    Type type = this.GetType();
    MethodInfo method_info = type.GetMethod(
        method,
        UrlData.Select(_ => _.GetType()).ToArray()
    );

    // みつからなかったら method_info == null っぽい

    &lt;p>@method_info&lt;/p>
}

```んでんで、
```cs
@functions 
{
   public HelperResult GET()
   {
       return new HelperResult(_ => _.WriteLine("GET()"));
   }

   public HelperResult GET(int id)
   {
       return new HelperResult(_ => _.WriteLine("Get(int id)"));
   }

   public HelperResult GET(string title)
   {
       return new HelperResult(_ => _.WriteLine("Get(string title)"));
   }

   public HelperResult GET(string s1, string s2)
   {
       return new HelperResult(_ => _.WriteLine("Get(string s1, s2)"));
   }

   public HelperResult POST()
   {
       return new HelperResult(_ => _.WriteLine("POST()"));
   }
}

```こうやって適当に引数の異なるメソッドを用意しておく。

<div class="section">
    #### 結果
    

{{< figure src="/images/20130111054006.png"  >}}

{{< figure src="/images/20130111054007.png"  >}}

んかいい感じだ。出力を
```cs
&lt;p>@method_info.Invoke(this, UrlData.Select(_ => _ as object).ToArray())&lt;/p>

```に変えてみてもうまくいった（なんか不細工だなーもっといい書き方ある気がする）。

{{< figure src="/images/20130111055006.png"  >}}

OST も投げてみたけどイケてるみたい（わかりにくくてごめん、まだあんまり使い方がよくわかっていない！）。

{{< figure src="/images/20130111060244.png"  >}}

とは、MethodInfo を取得するとき、単に UrlData の type[] を問い合わせるのではなくて
```cs
MethodInfo method_info = type.GetMethod(
    method,
    UrlData.Select(_ => _.なるべくintに変換する().GetType()).ToArray()
);

```みたいなにすれば、GET(int id) でも呼べるはずだよね！　……今日はもう疲れたからやらないけど。ASP.NET MVC/Web API はこういうのをもっとエレガントにやっているんだろうなって思うと、だいぶ尊敬しちゃう。

</div>
</div>

