
+++
date = "2012-03-06 01:17:45 +0000 UTC"
draft = false
title = "YouTube の URL を動画タグへ変換する（oEmbed）"
tags = ["C#","ASP.NET"]

+++
<a href="http://daruyanagi.hatenablog.com/entry/2012/03/03/225037">Flickr の URL を画像タグへ変換する（oEmbed） - だるろぐ</a> のYoutube版も作ってみた。Youtube も oEmbed に対応しているのだけれど、画像ではなく動画なので、リンクを作る場合は url ではなく html （objectタグ）を使うのが、Flickr の写真の場合と少し違うところ<a href="#f1" name="fn1" title="Flickr も動画に対応しているのだけど、type==" video"="" の場合はやっぱり="" url="" ではなく="" html="" を使う"="">*1</a>。type には、ほかに rich だの link だのがあるっぽい。詳しくは <a href="http://oembed.com/">oEmbed</a> に全部書いてあるので参照のこと。

    ```
private static readonly string SERVICE_ENDPOINT =
	@"http://www.youtube.com/oembed";
private static readonly string FORMAT_URL =
	@"{0}?url={1}&amp;maxwidth={2}&amp;maxheight={3}&amp;format={4}";

public static string FORMAT_HTML_VIDEO_TAG = @"
&lt;blockquote class=&#39;youtube youtube-video&#39;>
&lt;p>{0}&lt;p>
&lt;p>&lt;small>{1} by &lt;a href=&#39;{3}&#39;>{2}&lt;/a>&lt;/small>&lt;p>
&lt;/blockquote>
";
public static string FORMAT_ERROR = @"&lt;p class=&#39;error&#39;>{0}&lt;/p>";

public static string GetHtml(string url,
	string max_width = "500", string max_height = "500")
{
    try
    {
        return GetHtml(url,
        	int.Parse(max_width), int.Parse(max_height));
    }
    catch (Exception e)
    {
        return string.Format(FORMAT_ERROR, e.Message);
    }
}

public static string GetHtml(
    string url, int max_width, int max_height)
{
    try
    {
        if (url.StartsWith("http://youtu.be/"))
            url = url.Replace(
            	"http://youtu.be/",
        	"http://www.youtube.com/watch?v=");

        var format = "json";

        var address = string.Format(
        	FORMAT_URL, SERVICE_ENDPOINT, url,
        	max_width, max_height, format);

        using (var client = new WebClient())
        {
            var response = client.DownloadString(address);
            var info = DynamicJson.Parse(response);

            switch (info.type as string)
            {
                case "video":
                    return string.Format(FORMAT_HTML_VIDEO_TAG,
                        info.html, info.title,
                        info.author_name, info.author_url);

                default:
                    throw new Exception("Unknown media type.");
            }
        }
    }
    catch (Exception e)
    {
        return string.Format(FORMAT_ERROR, e.Message);
    }
}
```
YouTube の短縮URLはドメイン部分を置換しただけみたい。実装も楽だし、開発者も楽だし、多少リンクが長くなる以外はなかなかイケていると思う。
<div class="footnote">
<a href="#fn1" name="f1" class="footnote-number">*1</a><span class="footnote-delimiter">:</span><span class="footnote-text">Flickr も動画に対応しているのだけど、type=="video" の場合はやっぱり url ではなく html を使う</span>
</div>

