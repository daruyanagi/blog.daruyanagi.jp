
+++
date = "2013-03-15 03:31:29 +0000 UTC"
draft = false
title = "WebMatrix 2"
tags = ["WebMatrix","ASP.net Web Pages","Twitter"]

+++


{{< figure src="/images/20130315025326.png"  >}}

witter の Web UI で改行が使えるようになったとのことで、タイムラインが縦書きでいっぱいです。それをみていたら、自分も漢詩なんかが縦書きで投稿できるアプリがほしくなりました。

<ul>
<li><a href="http://tools.daruyanagi.net/Tategaki/">縦書き - @daruyanagi</a></li>
</ul>
<div class="section">
    ### Inside Tategaki
    
<div class="section">
    #### 拡張メソッド
    さっそく中身を紹介したいのですが、その前に拡張メソッドをいくつか用意しておきます。クラス名が体を表していないのは見逃してください。拡張メソッドのクラス名なんか飾りなんですよ！

<ul>
<li>Transpose() : 行と列を逆にします</li>
<li>Join() : string.Join() を "hoge".Join() で呼び出す</li>
<li>Times()：string * int がほしかった</li>
</ul>**~/App_Code/EnumerableExtensions.cs**
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;

public static class EnumerableExtensions
{
    public static IEnumerable&lt;IEnumerable&lt;T>> Transpose&lt;T>(
        this IEnumerable&lt;IEnumerable&lt;T>> source)
    {
        return from row in source
               from col in row.Select(
                   (x, i) => new KeyValuePair&lt;int, T>(i, x))
               group col.Value by col.Key into c
               select c as IEnumerable&lt;T>;
    }

    public static string Join&lt;T>(
        this IEnumerable&lt;T> source, string seperator)
    {
        return string.Join(seperator, source);
    }

    public static string Times(this string source, int times)
    {
        return Enumerable.Range(0, times).Select(_ => source).Join("");
    }
}

```
</div>
</div>
<div class="section">
    ### メインページ
    “既定のページの管理”で .cshtml を追加してあります。**~/Tategaki/Default.cshtml**
```cs
@{
    var text = (Request["text"] ?? string.Empty);
}

&lt;div style="width: 300px; margin: 0 auto;">
    &lt;form action="">
        &lt;p>&lt;textarea name="text" style="width: 100%; height: 10em;">@text&lt;/textarea>&lt;/p>
        &lt;p style="text-align: right;">&lt;input type="submit" />&lt;/p>
    &lt;/form>

@{
    text = text.Replace("  ", "　").Replace(" ", "　");
    text = Microsoft.VisualBasic.Strings
        .StrConv(text, Microsoft.VisualBasic.VbStrConv.Wide, 0);
    
    var s = Request["s"].AsInt(1);
    var new_line = new [] { "\r\n", "\r", "\n" };
    var lines = Html.Encode(text).Split(new_line, StringSplitOptions.None);
    var width = lines.Max(_ => _.Length);
    
    var vertical_text = lines
        .Reverse()
        .Select(_ => _.PadRight(width, &#39;　&#39;).ToCharArray().AsEnumerable())
        .Transpose()
        .Select(_ => _.Join(" ".Times(s)).TrimEnd())
        .Join("\n") + "\n\n";
}

```半角 ⇒ 全角 の変換処理はめんどくさいの Visual Basic の機能（StrConv 関数）を引っ張ってきました。Web.config を書き換えて DLL の参照を追加するより、一度「Visual Studio」で開いて［参照の追加］を使うのが簡単。AsInt() は ASP.NET Web Pages で提供されている便利なメソッド。ここでは Request[] で受け取った値を Int32 型にしている（失敗したら 0、引数を与えれていればデフォルト値を返す）。ほかにもいろんな型に対応するメソッドが用意されてるよ！

<ul>
<li><a href="http://www.asp.net/web-pages/overview/more-resources/asp-net-web-pages-api-reference">ASP.NET API Quick Reference : The Official Microsoft ASP.NET Site</a></li>
</ul>手抜き命名の変数 s は行間に挿入するスペースの数（LINQ の下から二つ目 " ".Times(s) の部分）。あとは LINQ で

<ol>
<li>横にスライス（縦書きの時は右上始点で読むのリバースしておく）</li>
<li>それをまた縦にスライスして char の表に（空きは簡便のため全角空白で埋める）</li>
<li>行と列を入れ替えて縦書きに</li>
<li>各行の char[] を連結（うしろの空白は不要なのでカット）</li>
<li>すべての行を連結</li>
</ol>するだけ。もっといい方法あるかな？
```cs
@functions
{
    public string GetShorURL(string url){ 
        string endpoint = "https://www.googleapis.com/urlshortener/v1/url"; 
        string json = "{\"longUrl\": \"" + url + "\"}"; 
        WebClient client = new WebClient { Encoding = System.Text.Encoding.UTF8 }; 
        client.Headers["Content-Type"] = "application/json";
        var response = Json.Decode(client.UploadString(endpoint, json));
        return response.id as string;
    }
}

@{
    var url = GetShorURL(Request.Url.AbsoluteUri);
}
    
    &lt;pre style="padding: 1em; background-color: whitesmoke; border: 1px lightgray solid; overflow: auto;">@vertical_text&lt;/pre>
   

    &lt;div style="text-align: right;">
        &lt;span>@(140 - vertical_text.Length)&lt;/span>
    &lt;/div>

    &lt;div>
        &lt;a href=&#39;https://twitter.com/intent/tweet?text=@HttpUtility.UrlEncode(vertical_text)&#39; class="twitter-mention-button" data-lang="ja" data-size="large" data-related="daruyanagi" data-url="@url">Tweet&lt;/a>
        &lt;script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = "//platform.twitter.com/widgets.js"; fjs.parentNode.insertBefore(js, fjs); } }(document, "script", "twitter-wjs");&lt;/script>
    &lt;/div>
&lt;/div>

```goo.gl で短縮するための処理を入れている。リクエストを Json で扱うのだけど、エンコード・でコードするクラスがあるのが便利だった……

{{< figure src="/images/20130315035335.png"  >}}

</div>

