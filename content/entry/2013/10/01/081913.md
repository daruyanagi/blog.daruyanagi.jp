
+++
date = "2013-10-01 08:19:13 +0000 UTC"
draft = false
title = "WebMatrix 3"
tags = ["ASP.net","ASP.net Web Pages","WebMatrix"]

+++


{{< figure src="/images/20130929122557.png"  >}}

a href="https://blog.daruyanagi.jp/entry/2013/09/29/122508">WebMatrix 3: @ でハマる - だるろぐ</a

> の続き。<script>    window.twttr = (function(d, s, id) {        var js, fjs = d.getElementsByTagName(s)[0],            t = window.twttr || {};        if (d.getElementById(id)) return t;        js = d.createElement(s);        js.id = id;        js.src = "https://platform.twitter.com/widgets.js";        fjs.parentNode.insertBefore(js, fjs);        t._e = [];        t.ready = function(f) {            t._e.push(f);        };        return t;    }(document, "script", "twitter-wjs"));</script>

<script>    twttr.ready(function (twttr) {        var el = document.getElementsByClassName('twitter-syntax-tweet-id-384486530380611584');        for (var i=0;i<el.length;i++) {            if (!!el[i].getAttribute('data-is-tweet-loaded')){                continue;            }            el[i].setAttribute('data-is-tweet-loaded', '1');            twttr.widgets.createTweet('384486530380611584',el[i],{});        }    });</script>

<div class="twitter-syntax-tweet-id-384486530380611584"></div>というアドバイスをもらった。あ、たぶんそれだ。というわけで書き直した。

<div class="section">
    ### 旧バージョン（Logger.cshtml）
    ```cs
#App_Code/Logger.cshtml

@helper Write(string message)
{
    System.IO.File.AppendAllText(
        Server.MapPath("~/log.txt"),
        string.Format("{0}:\t{1}\r\n", DateTime.Now, message)
    );
}

```これって実は public static HelperResult Write(string message) になるんだよね。それにしてもなぜ AppendAllText() が実行されないのかは謎だけど、HTML が含まれていない（出力がない）ならば処理を飛ばしてしまう最適化なんかがあるのかもしれない。とりあえず“Page に対してなんら出力のないヘルパー”という使い方は NG ってことかな。

</div>
<div class="section">
    ### 新バージョン（Logger.cs）
    

{{< figure src="/images/20131001075835.png"  >}}

br/>

```cs
#App_Code/Logger.cs

using System;

public static class Logger
{
    public static void Write(string message)
    {
        System.IO.File.AppendAllText(
            System.Web.Hosting.HostingEnvironment.MapPath("~/log.txt"),
            string.Format("{0}:\t{1}\r\n", DateTime.Now, message)
        );
    }
}

```CSHTML → CS にして、コードを Razor ではなく C# で書き直す。“<a href="http://msdn.microsoft.com/ja-jp/library/system.web.hosting.hostingenvironment.mappath.aspx">HostingEnvironment.MapPath(String) Method (System.Web.Hosting) | Microsoft Docs</a>”は最近覚えたのだけど、Server.MapPath() が使えない場面でも動く（のだと期待している）。

{{< figure src="/images/20131001080145.png"  >}}

果は――期待通りログが出力される。けれど、Default.cshtml も少し書き直さなければならない。

</div>
<div class="section">
    ### 旧バージョン（Default.cshtml）
    ```html
@{
     @Logger.Write("冒頭のコードブロック内で記述");
}



&lt;html lang="ja">
    &lt;head>
&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        &lt;meta charset="utf-8" />
        &lt;title>マイ サイトのタイトル&lt;/title>
        &lt;link href="~/favicon.ico" rel="shortcut icon" type="image/x-icon" />
    &lt;/head>
    &lt;body>
        @Logger.Write("Body 内で記述")
    &lt;/body>
&lt;/html>

```
</div>
<div class="section">
    ### 新バージョン（Default.cshtml）
    ```html
@{
     Logger.Write("冒頭のコードブロック内で記述");
}



&lt;html lang="ja">
    &lt;head>
&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        &lt;meta charset="utf-8" />
        &lt;title>マイ サイトのタイトル&lt;/title>
        &lt;link href="~/favicon.ico" rel="shortcut icon" type="image/x-icon" />
    &lt;/head>
    &lt;body>
        @{ Logger.Write("Body 内で記述"); }
    &lt;/body>
&lt;/html>

```Logger.Write が HelperResult を返さなくなったことにより（ヘルパーメソッドとしてシグネチャーが合わなくなったので）、@Logger.Write() という書き方はできなくなり、コードブロックで囲まなければならなくなった。けど、これが正しい。そういえば

<ul>
<li><a href="http://haacked.com/archive/2011/02/27/templated-razor-delegates.aspx">Templated Razor Delegates | You’ve Been Haacked</a></li>
</ul>をあんまり理解していないことを思い出したので、これも今度解決しておくことにする。

</div>
<div class="section">
    ### 追記
    この功を表して、しばやんにはもう一枚 CD を贈ることにした。

</div>

