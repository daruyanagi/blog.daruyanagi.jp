
+++
date = "2012-07-24 20:11:50 +0000 UTC"
draft = false
title = "失敗の数だけ強くなりたい"
tags = ["C#","WPF"]

+++
<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120724/20120724200928.png" alt="f:id:daruyanagi:20120724200928p:plain" title="f:id:daruyanagi:20120724200928p:plain" class="hatena-fotolife"/>朝起きてボーっとしてたんだけど、そしたらふと「Windows Phone端末使って Gist でメモ取れたら便利じゃね？」と思いついた。早速、 Visual Studio を起動。けれど、趣味プログラマーの悲しさ、久しぶりだと何もかもすっかり忘れている<a href="#f1" name="fn1" title="歳もとったし">*1</a>。しかも、 Silverlight だといろいろ機能が欠けてて面倒くさいことも判明。とりあえず、 WPF で試作品でも作ることにした。 OAuth は面倒そうだったので、それも後回し。まずは Public の Gist を取得して ListBox に並べるところから始めよう。**MainWindow.xaml**
```xml
<grid></grid>
    Name="listBoxGists">
    


```**MainWindow.xaml.cs**
```cs
using System.Net;
using Newtonsoft.Json;

/// &lt;summary>
/// MainWindow.xaml の相互作用ロジック
/// &lt;/summary>
public partial class MainWindow : Window
{
    public MainWindow()
    {
        InitializeComponent();
    }
    
    private void MainWindow_Loaded(
        object sender, RoutedEventArgs e)
    {
        var client = new WebClient();
    
        client.DownloadStringCompleted += (_sender, _e) =>
        {
            listBoxGists.ItemsSource = JsonConvert
                .DeserializeObject&lt;Gist[]>(_e.Result);
        };
    
        client.DownloadStringAsync(
            new Uri("https://api.github.com/gists"));
    }
}

public struct Gist
{
    public string html_url;
    public string git_push_url;
    public User user;
    public string description;
    public int comments;
    public bool @public;
    public Dictionary&lt;string, File> files;
    public string created_at;
    public string url;
    public string id;
    public string updated_at;
    public string git_pull_url;
}

public struct User
{
    public string avatar_url;
    public string gravatar_id;
    public string login;
    public string url;
    public string id;
}

public struct File
{
    public string @type;
    public string filename;
    public string raw_url;
    public string language;
    public string size;
}

```これは酷いベタ書きでござる<a href="#f2" name="fn2" title="意外なことに、ここまではぐぐることもなく、案外すんなり書けたんだよ！">*2</a>。見る人が見たら殴りにくるよね？

<div class="section">
    ### 第一の失敗
    初回ビルドは成功。しかも、ちゃんと動いているみたいだ。けれど、数分後にもう一度試すと例外が発生するようになった。なぜだ。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120724/20120724194531.png" alt="f:id:daruyanagi:20120724194531p:plain" title="f:id:daruyanagi:20120724194531p:plain" class="hatena-fotolife"/>けれど、これは比較的簡単に原因がわかった。エラーがでた箇所の JSON をみてみる。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120724/20120724194701.png" alt="f:id:daruyanagi:20120724194701p:plain" title="f:id:daruyanagi:20120724194701p:plain" class="hatena-fotolife"/>日本語がうまく処理されていないらしい。ちゃんと WebClient のエンコードを指定していなかった……
```cs
var client = new WebClient()
{
    Encoding = System.Text.UTF8Encoding.UTF8
};

```日本語のデータが含まれていても、例外が出なくなった。うまくいった。

</div>
<div class="section">
    ### 第二の失敗
    気をよくしたので、ついでに ListBox の見た目をもう少しよくしようと思った。
```xml
<grid></grid>
    Name="listBoxGists">
        .ItemTemplate>
            <datatemplate></datatemplate>
                <stackpanel></stackpanel>
                    Text="{Binding description}"/>
                
            
        .ItemTemplate>
    


```<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120724/20120724195003.png" alt="f:id:daruyanagi:20120724195003p:plain" title="f:id:daruyanagi:20120724195003p:plain" class="hatena-fotolife"/>うまくいかないでござる！　うまくいかないでござる！

    >
        System.Windows.Data Error: 40 : BindingExpression path error: &#39;description&#39; property not found on &#39;object&#39; &#39;&#39;Gist&#39; (HashCode=284350719)&#39;. BindingExpression:Path=description; DataItem=&#39;Gist&#39; (HashCode=284350719); target element is &#39;TextBlock&#39; (Name=&#39;&#39;); target property is &#39;Text&#39; (type &#39;String&#39;)

    
などというエラーがたくさんでている。ここで1時間が経過してタイムオーバー。さすがにもう会社へ行かなくてはいけない。しかし、会社の椅子に座った途端、ふと気がついた。もしかしたら……！家に帰って早速コードを一行だけ変更。
```cs
public struct Gist
{
    public string html_url;
    public string git_push_url;
    public User user;
    public string description { get; set; } /* Here! */
    public int comments;
    public bool @public;
    public Dictionary&lt;string, File> files;
    public string created_at;
    public string url;
    public string id;
    public string updated_at;
    public string git_pull_url;
}

```<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120724/20120724195343.png" alt="f:id:daruyanagi:20120724195343p:plain" title="f:id:daruyanagi:20120724195343p:plain" class="hatena-fotolife"/>お見事！　フィールドはバインディングできないのでした。しかし、なんでこんなところで躓いているんだろう……まったく、わたくしさまの人生そのものですな。

</div><div class="footnote">
<a href="#fn1" name="f1" class="footnote-number">*1</a><span class="footnote-delimiter">:</span><span class="footnote-text">歳もとったし</span>
<a href="#fn2" name="f2" class="footnote-number">*2</a><span class="footnote-delimiter">:</span><span class="footnote-text">意外なことに、ここまではぐぐることもなく、案外すんなり書けたんだよ！</span>
</div>

