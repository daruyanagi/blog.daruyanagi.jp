
+++
date = "2012-09-05 05:01:57 +0000 UTC"
draft = false
title = "ダミーイメージがもらえなくて激怒したので WebMatrix でスマートに解決してみたけど一部激怒した"
tags = ["ASP.net Web Pages","WebMatrix"]

+++
Web サイトのデザインを考えるとき、ダミーイメージは欠かせないよね。少なくとも、自分はそう。そんな悩める怠惰な子ブタたちのために、 <a href="http://dummyimage.com">http://dummyimage.com</a> はある。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120905/20120905041606.png" alt="f:id:daruyanagi:20120905041606p:plain" title="f:id:daruyanagi:20120905041606p:plain" class="hatena-fotolife"/>こいつはパラメータを与えて URL を投げるだけで、いろんなサイズ・色のダミーイメージをじぇねれいと<a href="#f1" name="fn1" title="クールに発音してくれよ？　じぇねりっと って感じやな">*1</a>してくれるクールなサービスなんだ。

<div class="section">
    ### もっとクールに
    <img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120905/20120905041836.png" alt="f:id:daruyanagi:20120905041836p:plain" title="f:id:daruyanagi:20120905041836p:plain" class="hatena-fotolife"/>でも、まさか WebMatrix を使っているおシャレさんのなかに、 &lt;img src="htt... だなんて毎度いちいち手入力してるヤツはいないよな。もちろん、ヘルパーにしておいて自動補完機能に入力させるハズだ。機械でできることを手でやるのはアホのすることだ<a href="#f2" name="fn2" title="おれです、ゴメンナサイゴメンナサイ">*2</a>。
```cs
#~/App_Code/DummyImage.cshtml

@helper GetHtml(string args, object attrs = null)
{
    if (attrs != null)
    {
        attrs = string.Join(" ", attrs
            .GetType()
            .GetProperties()
            .Select(_ => string.Format(
                "{0}=\"{1}\"",
                _.Name, _.GetValue(attrs)
                )
            )
        );
    }
    &lt;img src="http://www.dummyimage.com/@Html.Raw(@args)"
         @Html.Raw(attrs) />
}

```こうやっておけば、
```cs
@DummyImage.GetHtml("640x16:9")

```と書くだけ<a href="#f3" name="fn3" title="実質的にはほとんど @ , dumm... , g, " 640x16:9"="" と入力するだけ！"="">*3</a>で、実行時に
```cs
 &lt;img src="http://www.dummyimage.com/640x16:9"  />

```のような HTML コードへ展開される。画像タグに alt 属性をつけなければ瞬時に息絶える W3C 原理主義者や、 style を埋め込みたいなんていうわがままさんはこんな感じで書けばいい。
```cs
@DummyImage.GetHtml(300,
    new { alt = "Dummy image", style = "border: 1px red solid;"})

```
</div>
<div class="section">
    ### 激怒してみた
    <img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120905/20120905043110.png" alt="f:id:daruyanagi:20120905043110p:plain" title="f:id:daruyanagi:20120905043110p:plain" class="hatena-fotolife"/>けれど、世の中うまくいかないものだ。 Web ページを実行してもなかなか画像が表示されない。 dummyimage.com が重過ぎるんだ！（怒でも、よく考えたらローカルの資源はありあまっているわけで……ダミー画像なんかむしろそっちで作るべきだよね。なんでも Web サービスに頼るのはよくないな。
```cs
#~/App_Code/DummyImage.cshtml

@using System.Drawing
@using System.Drawing.Drawing2D
@using System.Drawing.Imaging
@using System.Drawing.Text

@helper GetHtml(float width, float height = -1,
    Font font = null,
    Brush foreBrush = null, Brush backBrush = null,
    object attrs = null)
{
    // リフレクションで匿名オブジェクトを HTML 属性にするぜー
    if (attrs != null)
    {
        attrs = string.Join(" ", attrs
            .GetType()
            .GetProperties()
            .Select(_ => string.Format(
                "{0}=\"{1}\"",
                _.Name, _.GetValue(attrs)
                )
            )
        );
    }

    // 一応引数のチェック。負数ははじくか 16:9 に整形
    if (width &lt;= 0)
    {
        throw new ArgumentException("Width must be > 0");
    }
    height = height > 0 ? height : width * 9 / 16;

    // ここから画像生成。さいごに BASE64 に変換してタグに埋め込む
    var image = new Bitmap((int)width, (int)height);
    var base64 = string.Empty;

    using (var g = Graphics.FromImage(image))
    {
        // おまえのパワー、あまってんだろ？　品質最高にしてやんぜー
        g.SmoothingMode = SmoothingMode.HighQuality;
        g.PixelOffsetMode = PixelOffsetMode.HighQuality;
        g.TextRenderingHint = TextRenderingHint.AntiAlias;

        // 背景塗りつぶすぜー
        g.FillRectangle(
            backBrush ?? Brushes.LightGray,
            0, 0, width, height);

        // どまんなかにテキスト書くぜー
        var format = new StringFormat();
        format.Alignment = StringAlignment.Center;
        format.LineAlignment = StringAlignment.Center;

        g.DrawString(
            string.Format("{0}×{1}", image.Width, image.Height),
            font ?? new Font("Consolas", 36, FontStyle.Regular),
            foreBrush ?? Brushes.Black,
            new RectangleF(0, 0, width, height),
            format
        );
    }

    // 画像バイナリをテキスト（BASE64）に変換するぜー
    using (var stream = new System.IO.MemoryStream())
    {
        image.Save(stream, ImageFormat.Png);
        base64 = Convert.ToBase64String(stream.ToArray());
    }

    // HTML タグとして出力されるぜー
    &lt;img src="data:image/png;base64,@Html.Raw(@base64)"
         @Html.Raw(attrs) />
}

```<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120905/20120905044715.png" alt="f:id:daruyanagi:20120905044715p:plain" title="f:id:daruyanagi:20120905044715p:plain" class="hatena-fotolife"/>一見長いけど、やってることは FillRect() と DrawImage() 、BASE64 変換だけだよ。みんな ImageMagick 好きだけど、わしは .NET Framework の方が慣れていていいや。なぜか動かなくて悩んだりせずに済むしな<a href="#f4" name="fn4" title="お前が使い方をわかってないだけや！">*4</a>。

</div>
<div class="section">
    ### おまけ激怒
    <img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20120905/20120905044930.png" alt="f:id:daruyanagi:20120905044930p:plain" title="f:id:daruyanagi:20120905044930p:plain" class="hatena-fotolife"/>Razor の制限とはいえ…… using をネストしなければならないのは泣ける！（怒<br/>
まぁ、あとで画像生成部分を @functions に切り出せばよいかな。気が向いたらこいつは NuGet にしておきたいけれど、ダミーテキストを作るヘルパーもほしくなってきたね……なにかおもしろことできないかな。

</div><div class="footnote">
<a href="#fn1" name="f1" class="footnote-number">*1</a><span class="footnote-delimiter">:</span><span class="footnote-text">クールに発音してくれよ？　じぇねりっと って感じやな</span>
<a href="#fn2" name="f2" class="footnote-number">*2</a><span class="footnote-delimiter">:</span><span class="footnote-text">おれです、ゴメンナサイゴメンナサイ</span>
<a href="#fn3" name="f3" class="footnote-number">*3</a><span class="footnote-delimiter">:</span><span class="footnote-text">実質的にはほとんど @ , dumm... , g, "640x16:9" と入力するだけ！</span>
<a href="#fn4" name="f4" class="footnote-number">*4</a><span class="footnote-delimiter">:</span><span class="footnote-text">お前が使い方をわかってないだけや！</span>
</div>

