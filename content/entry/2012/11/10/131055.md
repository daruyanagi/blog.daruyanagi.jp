
+++
date = "2012-11-10 13:10:55 +0000 UTC"
draft = false
title = "Windows 8 の［Windows］＋［X］メニューをカスタマイズする"
tags = ["Windows 8"]

+++
<div class="section">
    ### 基本的な仕組み
    <img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20121110/20121110124222.png" alt="f:id:daruyanagi:20121110124222p:plain" title="f:id:daruyanagi:20121110124222p:plain" class="hatena-fotolife"/>［Windows］＋［X］キーで利用できる Windows 8 の管理メニューの構成は、
```
%LocalAppData%\Microsoft\Windows\WinX
```に保存されている。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20121110/20121110124004.png" alt="f:id:daruyanagi:20121110124004p:plain" title="f:id:daruyanagi:20121110124004p:plain" class="hatena-fotolife"/>単にフォルダ分けして、ショートカットファイルが収められているだけなので、簡単にカスタマイズできる……ように見える（後述）。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20121110/20121110124112.png" alt="f:id:daruyanagi:20121110124112p:plain" title="f:id:daruyanagi:20121110124112p:plain" class="hatena-fotolife"/>ショートカットファイルをフォルダ分けしておくと、メニューが表示されるときにスプリッタ―で分割されるので、多少見やすくなる。「Group*」という命名規則に従う必要は必ずしもないようだが、もしかしたら表示順序などには関係するのかもしれない。従っておいたほうが無難だと思う。

<div class="section">
    #### 寄り道
    ここで少し気になるのは、コマンドプロンプトのショートカットファイルが2種類あることだろう。この違いは管理者権限の有無だ。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20121110/20121110124601.png" alt="f:id:daruyanagi:20121110124601p:plain" title="f:id:daruyanagi:20121110124601p:plain" class="hatena-fotolife"/>これはショートカットファイルの［詳細設定］で変更できる。ちょっと階層が深い……。

</div>
</div>
<div class="section">
    ### メニュー項目をカスタマイズしてみる
    <img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20121110/20121110124905.png" alt="f:id:daruyanagi:20121110124905p:plain" title="f:id:daruyanagi:20121110124905p:plain" class="hatena-fotolife"/>とりあえずデスクトップに転がっていたショートカットファイルを「新しいフォルダー」に突っ込んでみた。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20121110/20121110124943.png" alt="f:id:daruyanagi:20121110124943p:plain" title="f:id:daruyanagi:20121110124943p:plain" class="hatena-fotolife"/>これだけだと何も起こらないので、エクスプローラーを再起動してみる。<img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/daruyanagi/20121110/20121110123900.png" alt="f:id:daruyanagi:20121110123900p:plain" title="f:id:daruyanagi:20121110123900p:plain" class="hatena-fotolife"/>すると、スプリッタ―だけが追加された。メニュー項目は追加されない。

    >
        The entries on the menu are driven by shortcut (.lnk) files present in each Group folder located at %LocalAppData%\Microsoft\Windows\WinX. But you can’t manipulate the shortcuts within or add new ones. That’s because at first invocation (e.g. a fresh boot), the menu scans for and only adds approved shortcuts.

        Windows 8 Secrets: The WinX Menu and its hashing algorithm Within Windows
    
どうやら管理メニューが最初に呼び出されるときに、ショートカットファイルをスキャンして“承認された”ものであるかどうかチェックが入るようだ。“承認された”ショートカットファイルを作成するには、

<ul>
<li>The link’s target application path/file (e.g. C:\Games\Minecraft.exe)</li>
<li>The link’s target application arguments (e.g. –windowed)</li>
</ul>これらのハッシュをとって、ショートカットファイルの特定のデータチャンクへ埋め込まなければならない。

<ul>
<li><a href="http://msdn.microsoft.com/en-us/library/dd871305(v=prot.20).aspx">[MS-SHLLINK]: Shell Link (.LNK) Binary File Format</a></li>
</ul>ショートカットファイルの構造って結構メンドイのな……。うはぁ、めんどくさい！

</div>
<div class="section">
    ### まとめ
    “WinX”フォルダーを編集すれば、［Windows］＋［X］メニューはカスタマイズできる。ただし、新たにショートカットファイルを登録する場合は、ハッシュを埋め込む必要がある。これを簡単なツールが、

<ul>
<li><a href="https://github.com/riverar/hashlnk">riverar/hashlnk · GitHub</a></li>
</ul>で公開されている。ショートカットファイルの移動や削除だけならば、比較的簡単に行える。また、エンドユーザー向けにはとあるロシア人が作ってくれたわかりやすいツールが用意されている。

<ul>
<li><a href="http://www.forest.impress.co.jp/docs/review/20121108_571662.html">窓の杜 - 【REVIEW】Windows 8の［Windows］＋［X］メニューを自分好みに編集「Win+X Menu Editor」</a></li>
</ul>あと、このメニューはユーザーがカスタマイズして利用することがあまり想定されていないようだ。多少悲しいことがあっても、泣いちゃいけない。

</div>

