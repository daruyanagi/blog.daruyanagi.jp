<!DOCTYPE html>
<html><link rel="icon" href="https://via.placeholder.com/70x70">
<link rel="stylesheet" href="https://andybrewer.github.io/mvp/mvp.css">

<meta charset="utf-8">
<meta name="description" content="My description">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>ASP.NET Core MVC：特定のリクエストを他のサイトにリダイレクトする - だるろぐ - だるやなぎのブログ</title>

<style>
    nav {
        margin-bottom: 0;
    }

    body {
        font-family: "UD デジタル 教科書体 NP-R", Arial, Helvetica, sans-serif;
    }

    table {
        margin: 2em auto;
        border: none;
    }

    th, td, tr {
        text-align: right !important;
        padding: 1rem !important;
    }

    td {
        border-bottom: 1px solid gray;
    }
</style>


    
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53152247-5"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-53152247-5');
        </script>
    
<body>
        <header><nav>
    <a href="/"><img alt="Logo" src="/logo.png" height="70"></a>
    
</nav>

<h1>だるろぐ - だるやなぎのブログ</h1>

<p></p>



<hr></header>

        <main>
<article>
    <p>6月末、事情があって急遽 daruyanagi.jp を ASP.NET Core MVC で書き直した。<a href="http://blog.daruyanagi.jp/entry/2017/06/27/021736">空の ASP.NET Core プロジェクトからとりあえず Web サイトのトップページを書いて Azure にデプロイするまで - だるろぐ</a>しかし、このとき daruyanagi.jp → blog.daruyanagi.jp へのリダイレクト機能を実装していなかった。<a href="http://blog.daruyanagi.jp/entry/2017/03/26/234347">はてなブログのドメインを daruyanagi.jp から blog.daruyanagi.jp へ引越しした - だるろぐ</a><a href="http://blog.daruyanagi.jp/entry/2017/04/02/013553">Google Search Console から“「404」ページの増加”というメールが来た - だるろぐ</a>リンク先を読むのがめんどくさい人のために、事情をかいつまんでいうと、</p>
<ul>
<li>むかし、はてなブログを daruyanagi.jp で運営していた</li>
<li>はてなブログをサブドメインなしで運用するのは非推奨だったので、blog.daruyanagi.jp へ移した</li>
<li>当然ながら大量のリンク切れが発生</li>
<li>これを解消するため、daruyanagi.jp にリダイレクト機能を組み込んでいた（ASP.NET Web Pages 製）</li>
<li>ASP.NET Web Pages 製 daruyanagi.jp を ASP.NET Core MVC 製にする過程で、リダイレクト機能を省略した</li>
</ul>Visual Studio 2017 Update 3 が正式版になれば、ASP.NET Web Pages のような機能が IDE 側でサポートされるという話を聞いたので、それを待ってから実装してもいいかなと思っていたのだけど、なかなかこない＆ブログにリンク切れが多くて使いにくかったので、とりあえずやっつけの対策を施した。まず、ルーティングの書き換え。今回は /entry だけを対策しておく（ほんとは他の URL にも対策を施さないといけないけれど、今回は一番困るやつだけ対策）。
```cs
// {Root}/startup.cs
<p>app.UseMvc(routes =&gt;
{
routes.MapRoute(
name: &ldquo;entry&rdquo;,
template: &ldquo;entry/{*id}&quot;,
defaults: new { controller = &ldquo;Entry&rdquo;, action = &ldquo;Index&rdquo; });</p>
<pre><code>routes.MapRoute(
    name: &quot;default&quot;,
    template: &quot;{controller=Home}/{action=Index}/{id?}&quot;);
</code></pre>
<p>});</p>
<pre><code class="language-ちゃんとコントローラーに処理が移っているみたい。“*（アスタリスク）”を付ければ、“/（スラッシュ）”も含めてマッチするみたいだね。" data-lang="ちゃんとコントローラーに処理が移っているみたい。“*（アスタリスク）”を付ければ、“/（スラッシュ）”も含めてマッチするみたいだね。">
<figure>
    <img src="/images/20170717143025.png"/> 
</figure>


とは EntryController をちょちょいのちょいと書き換え。
```cs
// {Root}/Controllers/EntryController.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;

// For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860

namespace daruyanagi.Controllers
{
    public class EntryController : Controller
    {
        // GET: /&lt;controller&gt;/&lt;/controller&gt;
        public IActionResult Index()
        {
            var url = HttpContext.Request.Path;

            return Redirect($&quot;http://blog.daruyanagi.jp{url}&quot;);
        }
    }
}

```これでだいたいイケてるような気がする。


</code></pre>
</article>

<section>
    <style>
        .spacer { margin: auto 1em;}
    </style>

    <p>
        
        <a href="https://blog.daruyanagi.jp/entry/2017/07/15/022136/">&laquo; Older</a>
        
        <span class="spacer">|</span>
        <a href="/">Home</a>
        <span class="spacer">|</span>
        <a href="#">Top</a>
        <span class="spacer">|</span>
        
            <a href="https://blog.daruyanagi.jp/entry/2017/07/19/114618/">Newer &raquo;</a>
        
    </p>    
    
</section>


        </main>
        
        <footer><hr>
<p>
    <a href="/about">daruyanagi</a> &copy; 2007-2020
</p></footer>
    </body>
</html>
