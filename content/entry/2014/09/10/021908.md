
+++
date = "2014-09-10 02:19:08 +0000 UTC"
draft = false
title = "WinRT：システムにインストールされた Windows ストア アプリを列挙する"
tags = ["Windows Runtime"]

+++
WPF アプリケーションからシステムにインストールされた Windows ストア アプリを列挙するには、この Windows Runtime API を使えばいいらしい。

<ul>
<li><a href="http://msdn.microsoft.com/ja-jp/library/windows/apps/br240968.aspx">PackageManager.FindPackagesForUser(String) Method (Windows)</a></li>
</ul>ちなみに、Windows ストア アプリからは利用できないとのこと。

<div class="section">
    ### 準備
    というわけで、この API を使うために諸々の準備を行う。

<div class="section">
    #### ターゲットプラットフォームバージョンを指定
    まず *.csproj ファイルをテキストエディターなどで開き、ターゲットプラットフォームとして Windows 8 以降を指定する。

{{< figure src="/images/20140910015930.png"  >}}

ロジェクトを一度アンロード。

{{< figure src="/images/20140910020152.png"  >}}

ロジェクトフォルダをエクスプローラで開く。いつからかコンテキストメニューにこのコマンドが追加されていてうれしい。

{{< figure src="/images/20140910020215.png"  >}}

argetPlatformVersion<a href="http://msdn.microsoft.com/ja-jp/library/microsoft.build.utilities.targetplatformsdk.targetplatformversion(v=vs.110).aspx">TargetPlatformSDK.TargetPlatformVersion プロパティ (Microsoft.Build.Utilities)</a> を記述して保存。プロジェクトをリロード。

</div>
<div class="section">
    #### winmd を参照に追加
    

{{< figure src="/images/20140910020337.png"  >}}

に、winmd を参照に追加。パスが長いけれど、コモンダイアログで winmd を検索すれば簡単に見つかる。これで IntelliSense で PackageManager クラスが補完できるようになるはず。デスクトップアプリから Windows Runtime API を使う時には、毎回こういう作業が必要になるみたい。知らんけど。

</div>
</div>
<div class="section">
    ### コーディング
    これで準備はだいたい完了なので、コードを記述していく。

<div class="section">
    #### コードビハインド
    簡便のため、ViewModel は匿名型で済ませる。
```cs
namespace WinRTAppsUpdateChecker
{
    using Windows.Management.Deployment;

    /// &lt;summary>
    /// MainWindow.xaml の相互作用ロジック
    /// &lt;/summary>
    public partial class MainWindow : Window
    {
        public MainWindow()
        {
            InitializeComponent();

            var manager = new PackageManager();

            DataContext = new
            {
                Packages = manager.FindPackagesForUser(string.Empty),
            };
        }
    }
}

```
</div>
<div class="section">
    #### XAML
    リストボックスを用意するだけ。Package<a href="http://msdn.microsoft.com/ja-jp/library/windows/apps/windows.applicationmodel.package.aspx">パッケージ Class (Windows)</a> の情報は Package Class 直下にぶら下がっているものと、Package.Id にぶら下がっているものがあるっぽいが、前者はあまり役に立たん感じ（後述）。
```xml
ItemsSource="{Binding Packages}">
    .View>
        <gridview></gridview>
            DisplayMemberBinding="{Binding Path=DisplayName}" Header="DisplayName"/>
            DisplayMemberBinding="{Binding Path=Id.Name}" Header="Name"/>
        
    .View>


```
</div>
</div>
<div class="section">
    ### 実行
    

{{< figure src="/images/20140910020822.png"  >}}

行するとエラーが発生するので、System.Rumtime を参照へ追加する（64bit Windows 8.1 Update/Visual Studio 2013 Update 3 で開発してるけれど、32bit版 .NET 4 のアセンブリでいいみたい？）。

{{< figure src="/images/20140910021531.png"  >}}

念ながら DisplayName はプロパティがあるにもかかわらず取得できない。ほんとこういうところクソだと思う。InstalledLocation にある AppxManifest.xml を読む必要がある。

</div>

