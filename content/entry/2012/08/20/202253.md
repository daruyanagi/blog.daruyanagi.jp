
+++
date = "2012-08-20 20:22:53 +0000 UTC"
draft = false
title = "WebMatrix でファイルのアップロード（3） - FileUpload ヘルパーを使う"
tags = ["ASP.net Web Pages","WebMatrix"]

+++
まずはお詫びを。{{< figure src="/images/20120819115634.png"  >}}<br/>


    >
        ASP.NET Web Helpers Library という NuGet をインストールすると、（FileUpload ヘルパーを利用して）複数ファイルのアップロードに対応した Form タグを簡単に生成できる。でも、個人的にはあんまり好きじゃなかったので今回は使わなかった。なんか動的に生成されるノードの名前がカブってるし、あんまりよくわかんなかった。

        WebMatrix でファイルのアップロード - だるろぐ
    
そしたらツッコミをもらった。>だるさん、HTML の name 属性の値は重複してもいいんやで— しばやん (@shibayan) 2012年8月19日<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>最初はなんのことかと思ったけど、 HttpFileCollection は NameObjectCollectionBase を継承している。 NameObjectCollectionBase は重複した複数のキーをもてるので、キーで値を取ろうとすると取りこぼしが発生する、ということみたい。{{< figure src="/images/20120820201127.png"  >}}確かにせやな。 Key はひとつだけど、 Value は複数あるわ。というわけで、値をすべて取得する拡張メソッド（~/App_Code/HttpFileCollectionBaseExtension.cs）は
```cs
using System.Collections.Generic;
using System.Web;

public static class HttpFileCollectionBaseExtension
{
    public static IEnumerable&lt;HttpPostedFileBase> ToEnumerable(
        this HttpFileCollectionBase target)
    {
        foreach (var key in target.AllKeys) //--> Key で……
        {
            yield return target[key];
        }
    }
}

```ではなくて、
```cs
using System.Collections.Generic;
using System.Web;

public static class HttpFileCollectionBaseExtension
{
    public static IEnumerable&lt;HttpPostedFileBase> ToEnumerable(
        this HttpFileCollectionBase target)
    {
        for (int i = 0; i &lt; target.Count; i++) //--> Index で！
        {
            yield return target[i];
        }
    }
}

```じゃないとダメみたい。 for 文なんて久しぶりに書いたわ……。んで、 Default.cshtml をこんな感じで書いてみた。
```cs
&lt;!DOCTYPE html>

@{
    IEnumerable&lt;dynamic> model = null;

    if (IsPost)
    {
        model = Request.Files.ToEnumerable()
            .Select&lt;HttpPostedFileBase, dynamic>((file) =>
        {
            try
            {
                var path = "~/Files/" + file.FileName;
                file.SaveAs(Server.MapPath(path));

                return new {
                    Result = "Success",
                    Src = VirtualPathUtility.ToAbsolute(path),
                    Message = string.Format(
                        "{0} is saved successfully", file.FileName),
                };
            }
            catch (Exception e)
            {
                return new {
                    Result = "Error",
                    Message = e.Message,
                };
            }
        });
    }
}

&lt;html lang="ja">
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>マイ サイトのタイトル&lt;/title>

        &lt;style>
            html { font-family: Meiryo, sans-serif; }
            .label { color: #fff; font-size: 0.8em;
                     border-radius: 2px; padding: 0 5px; }
            .success { background-color: #0094ff; }
            .error { background-color: #ff6a00; }
        &lt;/style>
    &lt;/head>
    &lt;body>
        &lt;h1>File Upload Test&lt;/h1>

        &lt;h2>Upload&lt;/h2>
        @FileUpload.GetHtml()

        &lt;h2>Result&lt;/h2>
        @if (model == null)
        {
            &lt;p>No files are uploaded.&lt;/p>
        }
        else
        {
            &lt;ul>
            @foreach (var item in model)
            {
                &lt;li>&lt;span class="label @item.Result.ToLower()">
                    @item.Result&lt;/span> @item.Message&lt;/li>
            }
            &lt;/ul>
        }
    &lt;/body>
&lt;/html>

```結果はこんな感じ。{{< figure src="/images/20120820201550.png"  >}}できた！

<ul>
<li><a href="http://shiba-yan.hatenablog.jp/entry/20110702/1309532938">HTML5 の Drag and Drop API と File API を使ってファイルアップロードを実装する - しばやん雑記</a></li>
</ul>

